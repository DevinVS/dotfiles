(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{29:function(e,t,i){"use strict";var n=i(3);const s=window._;if(!s)throw new Error("ADD _");const a=window.Backbone;if(!a)throw new Error("ADD Backbone");const o=s.extend({},a);new Date;function r(e,t){function i(){const e=s.toArray(arguments);setTimeout((function(){t.apply(this,e)}),50)}n.a.gEvents.on(e,i),window.addEventListener("unload",(function(){n.a.gEvents.off(e,i)}))}function l(e){r(e,(function(t,i){o.trigger(e,t,i)}))}function c(e,t){return function(i){setTimeout((function(){const n={name:e,id:i.id,op:t,ts_mod:i.ts_mod};o.trigger(e,n),o.trigger(e+":"+i.id,n)}),100)}}r("service:active",(function(e){o.trigger("service:state",e)})),r("change:pref:service.user_id",(function(){window.location.reload()})),r("store:clients:create",c("clients","I")),r("store:clients:update",c("clients","U")),r("store:sieve_data:create",c("sieve_data","I")),r("store:sieves:create",c("sieves","I")),r("store:sieves:update",c("sieves","U")),r("worker:sieve:state",(function(e){const t={rel:"sieves",id:e.id,ts_mod:Date.now(),doc:e};o.trigger("sieves:run_state",t),o.trigger("sieves:run_state:"+e.id,t)})),r("store:tags:create",c("tags","I")),r("store:tags:update",c("tags","U")),r("store:tags:destroy",c("tags","U")),l("change:error"),l("change:unread"),o.init=function(){const e=n.a.service.state,t=s.clone(e.attributes);e.clear(),e.set(t)},t.a=o},30:function(e,t,i){"use strict";var n=i(13);i(1);const s=n.a.Model.extend(),a=n.a.Collection.extend({model:s}),o=n.a.Model.extend({parse:function(e){return e.entries=new a(e.entries),e}});t.a={Feed:o,FeedEntry:s,FeedEntryCollection:a}},31:function(e,t,i){"use strict";var n=i(4);if(!window.domo)throw new Error("ADD domo");if(!window.async)throw new Error("ADD async");const s=n.a.Base.extend({name:"FeedEntry",render:function(){const e=this.model.attributes;let t;return this.$el.append(H3(A({href:e.link},e.title)),DIV({style:"color: #999; margin: -10px 0px;"},I(moment(e.date).format("MMMM DD, YYYY"))),t=DIV({class:"summary"})),$(t).html(e.description||e.summary||""),this}}),a=n.a.Collection.extend({name:"FeedEntryList",addOne:function(e){const t=new s({parent:this,model:e}).render();return this.$el.append(t.el),t}}),o=n.a.Base.extend({name:"Feed",render:function(){const e=this.model.attributes;return this.$el.append(H3(A({href:e.link},e.title)),DIV(e.description||e.summary||""),new a({parent:this,collection:this.model.get("entries")}).render().el),this}});t.a={Feed:o,FeedEntry:s,FeedEntryList:a}},32:function(e,t,i){"use strict";var n=i(0),s=i(2),a=i(11),o=i(5),r=i(4),l=(i(15),i(7));let c,d,h,u,p,f,m,g,v,b,w,_,y,x=e=>e;const S=window.async;if(!S)throw new Error("ADD async");class D extends l.a{constructor({model:e}){super(),this.model=e,this.state.showOptions=!1,this.setClientId(e.get("client_id")||App.clients.defaultId),this.setSessionId(e.get("session_id")),this.state.sessionNames={},this.loadSessions(),this.setProxyID(e.get("proxy_id")),this.state.proxyNames={},this.loadProxies(),e.on("change",()=>{this.state.session_id=e.get("session_id")})}async loadSessions(){let e=await o.a.api("/sessions");this.state.sessions=e.data,this.state.sessionNames=e.data.reduce((e,t)=>(e[t.id]=t.name,e),{})}setClientId(e){this.state.client_id=e,this.model.set("client_id",e)}setSessionId(e,t){t&&t.preventDefault(),this.state.session_id=e,this.model.set("session_id",e)}setProxyID(e,t){t&&t.preventDefault(),this.state.proxy_id=e,this.model.set("proxy_id",e)}async loadProxies(){USER.constraint.plan_id;const e=await o.a.api("/proxies",{only:["id","name","cost"]});let t=(await o.a.api("/proxies/global")).data;t=t.filter(e=>e.available),this.state.proxies=[...e.data,...t],e.data.reduce((e,t)=>(e[t.id]=t.name,e),this.state.proxyNames),t.reduce((e,t)=>(e[t.id]=t.name,e),this.state.proxyNames)}createTpl({client_id:e,session_id:t,sessions:i,sessionNames:n,proxyNames:s,proxies:a,proxy_id:o,showOptions:r}){let S=App.clients.get(e),I=!!i,D=!!a;return Object(l.b)(c||(c=x`<div class='flex align-items'><select @change=${0}>
      ${0}
      </select>
      ${0}
      ${0}
      ${0}
    </div>`),e=>this.setClientId(e.target.value),Object(l.d)(App.clients.toArray(),e=>e.id,t=>Object(l.b)(d||(d=x`<option value=${0} ?selected=${0}>${0}</option>`),t.id,t.id==e,t.getInfo())),S&&S.isWeb()&&!r?Object(l.b)(h||(h=x`<a
        @click=${0}
        class='ml3'
        href='javascript:void 0'>Options</a>`),e=>this.state.showOptions=!0):"",S&&S.isWeb()&&r?Object(l.b)(u||(u=x`<div class='ml3 dropdown relative'>
        <a class='dropdown-toggle btn-default ba pa1' data-toggle='dropdown'
          href='#'>
          Profile - ${0} <span class='caret'></span>
        </a>
        <ul class='dropdown-menu'>
          ${0}
        </ul>
        
      </div>`),t?n[t]||"Deleted":"Empty",I?[Object(l.b)(p||(p=x`<li><a href='#' @click=${0}>
                <i class='mr2 fa ${0}'></i>
                Empty (Default)</a></li>`),e=>this.setSessionId(null,e),t?"mr4":"fa-check"),...i.map(e=>Object(l.b)(f||(f=x`<li>
            <a data-id=${0} href='#' @click=${0}>
              <i class='mr2 fa ${0}'></i>
              ${0}
            </a>
          </li>`),e.id,t=>this.setSessionId(e.id,t),t==e.id?"fa-check":"mr4",e.name)),Object(l.b)(m||(m=x`
          <li class='divider'></li>

          <li><a href='#profiles/' target='_blank'>
              <span class='pl4'> Manage Profiles<span></a></li>

          <li><a href='${0}/kb/help/profiles-for-cloud-monitors' target='_blank'>
              <span class='pl4'> Learn More<span></a></li>
              `),URL_WEBSITE)]:Object(l.b)(g||(g=x`<li><a>Loading...</a></li>`))):"",r&&S&&S.isWeb()?Object(l.b)(v||(v=x`<div class='ml3 dropdown relative'>
        <a class='dropdown-toggle btn-default ba pa1' data-toggle='dropdown'
          href=#
          >
          Proxy - ${0} <span class='caret'></span>
        </a>
        <ul class='dropdown-menu'>
        ${0}
        </ul>
      
      </div>`),o?s[o]||"Deleted":"Shared Pool",D?[Object(l.b)(b||(b=x`<li><a href='#' @click=${0}>
            <i class='mr2 fa ${0}'></i>
            Shared Pool (Default)</a></li>`),e=>this.setProxyID(null,e),o?"mr4":"fa-check"),...a.map(e=>Object(l.b)(w||(w=x`<li>
            <a data-id=${0} href='#' @click=${0}>
              <i class='mr2 fa ${0}'></i>
              ${0} ${0}
            </a>
          </li>`),e.id,t=>this.setProxyID(e.id,t),o==e.id?"fa-check":"mr4",e.name,e.cost>1?`(${e.cost}x)`:"")),Object(l.b)(_||(_=x`
          <li class='divider'></li>

          <li><a href='#proxies/' target='_blank'>
              <span class='pl4'> Manage Proxies<span></a></li>

          <li><a href='${0}/kb/help/monitor-webpage-using-proxy-servers/' target='_blank'>
              <span class='pl4'> Learn More<span></a></li>
          `),URL_WEBSITE)]:Object(l.b)(y||(y=x`<li><a>Loading...</a></li>`))):"")}}const A=r.a.Collection.extend({name:"ClientManager",actions:{"client edit name":{fn:"action_edit_name"},"client remove":{fn:"action_remove"}},action_edit_name:function(e){const t=this,i=a.a.create("text"),n=this.collection.get(e),s=new r.a.PromptModal({title:"l_name",parent:this.getRoot(),view:i,width:500});s.show(),i.setValue(n.get("info")),$(i.field).focus(),s.on("save",(function(){const e=i.getValue();n.save({info:e},{patch:!0}),s.remove(),t.onReset(t.collection,{previousModels:t.collection.models})}))},action_remove:function(e){const t=this.collection.get(e);return e==this.collection.defaultId?alert(Object(n.a)("Can't remove self")):t.isWeb()?alert(Object(n.a)("Can't remove web app")):void(confirm(Object(n.a)("Remove "+t.get("info")+"?"))&&t.save({state:90},{wait:!0,success:()=>{this.collection.remove(t)}}))},addOne:function(e){if(e.get("type")<3)return new r.a.Base;const t=e.get("info"),i=e.id==this.collection.defaultId,s=new r.a.Base({el:P(SPAN(BUTTON({class:"btn btn-default btn-xs","data-action":"client edit name","data-action-param":e.id},I({class:"fa fa-edit"}))," ",BUTTON({class:"btn btn-danger btn-xs","data-action":"client remove","data-action-param":e.id},I({class:"fa fa-trash-o"})))," ",SPAN({style:i?"font-weight: bold;":""},t,i?" ("+Object(n.a)("l_device_this")+")":""),SMALL({},moment(e.get("ts")).format(" (YYYY-MM-DD)"))),parent:this}).render();return this.$el.append(s.el),s},onSave:function(){s.a.info("l_loading"),S.eachSeries(this.collection.models,(function(e,t){e.hasChanged("info")?e.save(null,{error:function(){t(new Error("Failed to save changes"))},success:function(){t()}}):t()}),(function(e){s.a.reset()}))},renderBase:function(){}});t.a={ClientManager:A,ClientSelector:D}},34:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i(5),s=i(3);async function a(e=0){const t={isOverLimit:!1,isFlexi:!1},i=s.a.auth;if(i&&!i.isLoggedIn()){if(i.isLegacy())return t;{const i=25,{total_count:n}=await s.a.store.SieveStore.find({"state.in":[40,45]},{only:["id"],limit:1});return{...t,limit:i,count:n,isOverLimit:n+e>i}}}const a=await n.a.api("/users/sieve-count");return{...a,isOverLimit:!a.isFlexi&&a.count+e>a.limit}}},36:function(e,t,i){"use strict";var n=i(10),s=(i(2),i(4)),a=i(6);if(!window.jQuery)throw new Error("ADD jQuery");if(!window._)throw new Error("ADD _");if(!window.Backbone)throw new Error("ADD Backbone");if(!window.domo)throw new Error("ADD domo");const o=s.a.Base.extend({name:"SieveConstraints",postInit:function(){},render:function(){const e=this.options.url||"";return this.$el.empty().append(DIV({class:"xmonitor-limit"},DIV({class:"alert alert-danger"},Object(n.a)("m_monitor_constraint_1",this.model.count,this.model.limit)," ",Object(n.a)("m_monitor_constraint_2"),UL(LI(A({href:a.a.agents.local?"/ui/inbox.html":"/watchlist"},I({class:"fa fa-link"})," ",Object(n.a)("a_go_to_watchlist")),": ",Object(n.a)("m_monitor_constraint_3")),LI(A({href:e+"/settings/billing"},I({class:"fa fa-link"})," ",Object(n.a)("a_go_to_billing")),": ",Object(n.a)("m_monitor_constraint_4")))))),this}});t.a=o},37:function(e,t,i){"use strict";var n=i(3),s=i(12),a=i(0),o=i(10),r=i(1),l=i(2),c=i(4),d=i(11),h=i(5),u=i(13),p=i(8),f=i(30),m=i(32),g=i(31),v=i(6);i(16);const b=window.jQuery;if(!b)throw new Error("ADD jQuery");const w=window._;if(!w)throw new Error("ADD _");if(!window.domo)throw new Error("ADD domo");if(!window.async)throw new Error("ADD async");var y=c.a.ActionProvider.extend({events:{"keypress input":"event_load","click .xtbar .btn.xload":"event_loadFeed","click .xtbar .btn.xadd":"event_add"},event_add:function(e){if(this.feed){const e=this.url,t=this.feed.attributes;this.trigger("save",{name:t.title,uri:t.link,content_type:r.a.TYPE_FEED,config:{uri:e}})}else this.error("Feed could not be loaded or parsed.")},event_load:function(e){13==e.keyCode&&this.loadURL(this.$(".xurl").val())},event_loadFeed:function(e){const t=e.target.getAttribute("href");this.$(".xurl").val(t),this.$(".xtbar").empty(),this.loadURL(t)},error:function(e){this.$(".xmsg").addClass("xerror").text(e?Object(a.a)(e):"")},msg:function(e){this.$(".xmsg").removeClass("xerror").text(e?Object(a.a)(e):"")},loadURL:function(e){const t=this;this.msg(""),e.indexOf(":")<0&&(e="http://"+e),/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi.test(e)?(this.url=e,this.feedView&&this.feedView.remove(),this.$(".xtbar").empty(),this.msg("l_loading"),function(e,t){v.a.agents.local?n.a.HTTP.get({url:e},t):b.get("/v1/http/get?url="+encodeURIComponent(e),(function(e,i,n){t(null,n.responseText,n)})).fail((function(){t("Error fetching resource: "+e)}))}(e,(function(e,i,s){if(e)return void t.error("e_load_source");let a=s.getResponseHeader("content-type");switch(a=a.split(";")[0]){case"text/html":case"application/xhtml+xml":t.msg("m_feed_finding");var r=new DOMParser,l=r.parseFromString(s.responseText,a);if(!l){const e=res.match(/<link.*\/>/gim).join("");l=r.parseFromString(e,a)}!function(e,t){if(!e)return t({code:"NULL",msg:"HTML document is null"});const i=e.querySelectorAll('link[type="application/rss+xml"],link[type="application/atom+xml"]'),n=w.map(i,(function(e){return{title:e.getAttribute("title"),href:e.getAttribute("href")}}));t(null,n)}(l,(function(e,i){if(0==i.length)t.error("e_feed_in_page_na");else if(1==i.length){const e=i[0].href;t.$(".xurl").val(e),t.loadURL(e)}else t.showFeedSelectionList(i)}));break;case"application/xml":case"text/xml":case"application/rss+xml":case"application/atom+xml":t.msg("Parsing feed..."),function(e,t,i){v.a.agents.local?n.a.Feed.fromString(e,t,i):b.post("/v1/feed/json",{text:e},(function(e,t,n){i(200!=n.status?"Error parsing feed":null,e)}))}(s.responseText,t.url,t.onParsedFeed);break;default:t.error(Object(o.a)("e_unknown_content_type",a))}}))):this.error("m_enter_valid_url")},onParsedFeed:function(e,t){this.msg(""),e?this.error(Object(a.a)("m_try_later")+" "+Object(a.a)("e_load_source")):(t=JSON.parse(JSON.stringify(t)),this.feed=new f.a.Feed(t,{parse:!0}),this.feedView&&this.feedView.remove(),this.feedView=new g.a.Feed({el:b("#feed")[0],model:this.feed,parent:this}).render(),this.$el.append(this.feedView.el),this.$(".xtbar").empty().append(BUTTON({class:"btn btn-primary xadd"},Object(a.a)("a_select"))))},render:function(){return this.$el.empty().append(DIV(DIV(INPUT({class:"form-control xurl",placeholder:Object(a.a)("m_enter_feed_url")})),DIV({class:"xmsg inline-block",style:"margin: 5px 0;padding: 0 5px;"}),DIV({class:"xtbar "}),DIV({class:"xpreview"}))),this},showFeedSelectionList:function(e){this.msg("m_feed_multi_selection"),this.$(".xtbar").empty().append(w.map(e,(function(e){return BUTTON({class:"btn btn-primary xload",href:e.href},Object(a.a)("Load feed")+" - "+e.title)})))}});const x=window.jQuery;if(!x)throw new Error("ADD jQuery");if(!window._)throw new Error("ADD _");if(!window.domo)throw new Error("ADD domo");if(!window.async)throw new Error("ADD async");var S=c.a.ActionProvider.extend({events:{"keypress input":"event_load","click .xtbar .btn.xadd":"event_add"},event_add:function(e){this.xml?this.trigger("save",{uri:this.url,content_type:r.a.TYPE_XML,config:{uri:this.url,selection:{excludes:[],includes:[{type:"xpath",expr:"/*"}]}}}):this.error("XML could not be loaded or parsed.")},event_load:function(e){13==e.keyCode&&this.loadURL(this.$(".xurl").val())},error:function(e){this.$(".xpreview").addClass("xerror").text(e?Object(a.a)(e):"")},msg:function(e){this.$(".xpreview").removeClass("xerror").text(e?Object(a.a)(e):"")},loadURL:function(e){const t=this;this.msg(""),e.indexOf(":")<0&&(e="http://"+e),/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi.test(e)?(this.url=e,this.$(".xtbar").empty(),this.msg("l_loading"),function(e,t){v.a.agents.local?n.a.HTTP.get({url:e},t):x.get("/v1/http/get?url="+encodeURIComponent(e),(function(e,i,n){t(null,n.responseText,n)})).fail((function(){t("Error fetching resource: "+e)}))}(e,(function(e,i,n){if(e)return void t.error("e_load_source");let s=n.getResponseHeader("content-type");switch(s=s.split(";")[0]){case"application/xml":case"text/xml":case"application/rss+xml":case"application/atom+xml":t.msg("Parsing xml..."),t.onXML(n.responseText);break;default:t.error(Object(o.a)("e_unknown_content_type",s))}}))):this.error("m_enter_valid_url")},onXML:function(e){const t=(new DOMParser).parseFromString(e,"text/xml");this.msg(""),t?(this.xml=t,this.$(".xpreview").text(e),this.$(".xtbar").empty().append(BUTTON({class:"btn btn-primary xadd"},Object(a.a)("a_select")))):(this.xml=null,this.error("Failed to parse XML"))},render:function(){return this.$el.empty().append(DIV(DIV(INPUT({class:"form-control xurl",placeholder:Object(a.a)("m_enter_xml_url")})),DIV({class:"xtbar "}),PRE({class:"xpreview",style:"max-height: 400px;overflow:auto;"}))),this}}),D=i(36),O=i(34);const E=window._;if(!E)throw new Error("ADD _");const T=c.a.Base.extend({tagName:"div",events:{click:"event_click"},close:function(){this.loader&&this.loader.destroy()},event_click:function(){this.loader&&chrome.tabs.update(this.loader.tabId,{active:!0})},render:function(){return this.$el.text(Object(a.a)("h_opening_selector_in_new_tab")),setTimeout(this.renderTab,400),this},renderTab:function(){const e=this;n.a.createLoader({type:"tab",info:{active:!1,pinned:!1,after:"activeTab",url:e.model.get("uri")||"https://www.google.com"}},(function(t,i){e.loader=i,t?(console.error("err:",t),l.a.error("e_sel_na")):(e.loader=i,setTimeout((function(){chrome.tabs.update(i.tabId,{active:!0})}),600),n.a.openSelectorForTabLoader({loader:i,model:e.model.toJSON(),client:document},e.selectorCallback),e.$el.text(Object(a.a)("h_opened_selector_in_tab")))}))},selectorCallback:function(e,t){t&&(t=JSON.parse(JSON.stringify(t))),chrome.tabs.getCurrent((function(e){chrome.tabs.update(e.id,{active:!0})})),e?l.a.error(e.msg||e.message||e):t?(this.model.set(this.model.parse(t)),this.trigger("save",null,this.model),l.a.info("m_selection_saved")):(this.trigger("discard"),l.a.info("m_selection_discarded"))}});var k=c.a.Modal.extend({name:"SelectorModal",title:Object(a.a)("l_visual_selector"),initialize:function(e){this.selector=new T(E.pick(e,"model","parent"));E.defaults(e,{width:400,height:120,view:this.selector}),this.on("discard",(function(){e.onDiscard()})),c.a.Modal.prototype.initialize.call(this,e),this.listenTo(this.selector,"discard",e.onDiscard),this.listenTo(this.selector,"save",e.onSave)},remove:function(){k.__super__.remove.call(this),this.selector.close()}}),L={Modal:k},j=i(29);var R=function(e,t){const i=new RegExp(/(\"|\').*/),n=new RegExp(/.*(\"|\')$/),s=[],a=[];let o=!1,r=null;const l=e.split(" ");for(let e=0;e<l.length;e++){let t=l[e];if(o){for(let i=e;i<l.length;i++)if(t=l[i],r.val=(r.val||"")+" "+t,t.match(n)){o=!1,e=i,r.val=r.val.replace('"',"");break}}else if(t.indexOf(":")>-1){null!=r&&(r.val=r.val.replace(/%22/g,'"'),a.push(r)),r={name:t.split(":")[0].trim(),val:""};var c=t.split(":")[1].trim();c&&(c.match(i)?(r.val=(r.val||"")+" "+c.match(i)[0].replace(/(\"|\')/gm,""),o=!0):r.val=(r.val||"")+" "+c)}else o?r.val=(r.val||"")+" "+c:s.push(t.replace(/%22/g,'"'))}null!=r&&(r.val=r.val.replace(/%22/g,'"'),a.push(r)),a.push({name:"keyword",val:s.join(" ")}),t(null,a)},N=function(e,t,i){const n=new RegExp(/(\"|\').*/),s=new RegExp(/.*(\"|\')$/),a=[],o=[];let r=!1,l=null,c=[];const d=e.split(" ");for(let e=0;e<d.length;e++){let i=d[e];if(r){for(let t=e;t<d.length;t++)if(i=d[t],l.val=(l.val||"")+" "+i,i.match(s)){r=!1,e=t,l.val=l.val.replace('"',"");break}}else if(i.indexOf(":")>-1){null!=l&&(l.val=l.val.replace(/%22/g,'"'),o.push(l)),l={name:i.split(":")[0].trim(),val:"",operator:""};var h=i.split(":")[1].trim();if(h&&(h.match(n)?(l.val=(l.val||"")+" "+h.match(n)[0].replace(/(\"|\')/gm,""),r=!0):l.val=(l.val||"")+" "+h),c.length>0){let e=c.pop();l.operator=e}}else r?l.val=(l.val||"")+" "+h:_.contains(t,i.toLowerCase())?c.push(i.replace(/%22/g,'"')):a.push(i.replace(/%22/g,'"'))}null!=l&&(l.val=l.val.replace(/%22/g,'"'),o.push(l)),o.push({name:"keyword",val:a.join(" ")}),i(null,o)};const C=c.a.Base.extend({name:"SieveActionEditor",postInit:function(){this.listenTo(this.model,"remove",this.remove),this.paramsModel=new Backbone.Model(this.model.get("config")),this.listenTo(this.paramsModel,"change",this.onEditParams)},onDelete:function(){this.model.collection.remove(this.model)},onEditParams:function(){this.model.set("config",this.paramsModel.toJSON())},render:function(){const e=this.model.desc;let t,i;if(e.single)this.$el.css({"margin-left":30,"line-height":0});else{let e;this.$el.append(e=A({class:"btn fa fa-trash-o xbtn-light",style:"vertical-align: top;margin-top: 5px;",href:"javascript:void 0",title:Object(a.a)("h_del_action")})),e.onclick=this.onDelete}if(this.$el.append(t=DIV({style:"display:inline-block;width:80%; margin-bottom: 5px;"})).css({position:"relative",overflow:"visible"}),i=this.paramEditors=_.map(e.params,(function(e){const i=d.a.create(e.type,{param:e,parent:this,model:this.paramsModel});return t.appendChild(i.render().el),e.must||i.$el.hide(),i}),this),_.any(e.params,(function(e){return!e.must}))){let e;t.appendChild(e=BUTTON({class:"btn btn-default btn-xs xbtn-light"},Object(a.a)("l_options"))),e.onclick=function(){_.each(i,(function(e){e.$el.show()})),$(e).remove()}}return e.plugin&&e.plugin(this),this}}),M=c.a.Base.extend({name:"SieveActionGroup",className:"xtype-group",postInit:function(e){this.desc=e.desc,this.models=e.models,this.views={},this.listenTo(this.models,"add",this.addOne),this.listenTo(this.models,"remove",this.onActionRemove)},addOne:function(e){if(null==this.views[e.cid]&&e.desc.type==this.desc.type){const t=new C({model:e,parent:this}).render();this.$list.append(t.el),this.views[e.cid]=t}},isVoid:function(e){return this.desc.single||0==this.desc.params.length},onActionAdd:function(){this.models.add(new p.a.SieveAction[this.desc.type])},onActionRemove:function(e,t){0==this.models.where({type:this.desc.type}).length&&this.remove()},onDelete:function(){const e=this.models.where({type:this.desc.type});_.each(e,(function(e){this.models.remove(e)}),this)},render:function(){const e=this.desc;let t,i;return this.$list=$(DIV()),e.single&&(this.$el.append(i=BUTTON({class:"btn fa fa-trash-o xbtn-light",title:Object(a.a)("h_del_action")})),i.onclick=this.onDelete),e.single||(this.$el.append(t=BUTTON({class:"btn fa fa-plus xbtn-light pull-right"})),t.onclick=this.onActionAdd),this.$el.append(SPAN({style:""},SPAN(Object(a.a)(e.label)),this.$list[0])),this.models.each(this.addOne),this}}),V=c.a.ActionProvider.extend({name:"SieveActionsEditor",actions:{action_global_actions:{fn:"action_global_actions"}},action_global_actions:function(){F()},postInit:function(e){this.actionGroups={},this.dels=[],this.sieve=e.sieve,this.models=e.actions,this.listenTo(this.models,"add",this.addOne),this.listenTo(this.models,"remove",this.onActionRemove),this.listenTo(this.models,"reset",this.render)},addOne:function(e){const t=e.desc,i=t.type;if(this.$emptyEl.remove(),!this.actionGroups[i]){const e=this.actionGroups[i]=new M({models:this.models,desc:t,parent:this}).render();this.listenTo(e,"remove",(function(){delete this.actionGroups[i]}),this),this.$list.append(e.el)}},getChanges:function(){return{dels:this.dels,posts:this.getPosts(),puts:this.getPuts()}},getPosts:function(){return this.models.filter((function(e){return e.isNew()}))},getPuts:function(){return this.models.filter((function(e){return!e.isNew()&&e.hasChanged()}))},onAddActionMenuClick:function(e){const t=$(e.currentTarget).attr("tag"),i=p.a.SieveAction[t];i.desc.single&&this.models.where({type:i.desc.type}).length>0?l.a.info("m_action_can_add_only_one"):(this.models.add(new i(null,{parent:this.sieve})),e.preventDefault())},onActionRemove:function(e){e.isNew()||this.dels.push(e)},render:function(){let e;return this.reset(),this.$emptyEl=$(DIV({class:"alert alert-warning hide"},"No action added - add one to get alerted on changes")),this.$list=$(DIV()),this.$el.empty().append(DIV({style:"position: relative;"},DIV(A({id:"menu_add_action",class:"dropdown-toggle","data-toggle":"dropdown",href:"javascript:void 0"},Object(a.a)("a_add_action")," ",B({class:"caret"}))," ",e=UL({class:"dropdown-menu",role:"menu","aria-labelledby":"menu_add_action",style:"z-index: 2000"})," ",this.options.global?"":A({href:"#",class:"right pl4","data-action":"action_global_actions"},"Global")),DIV({class:"right",style:"margin-left:10px;"})),this.$emptyEl,DIV({style:"max-height: 360px;overflow-y:auto;overflow-x-hidden;"},this.$list[0])),_.each(p.a.SieveActionDescList,(function(t){e.appendChild(LI(A({tag:t.type,tabindex:-1,href:"javascript:void 0"},I({class:"fa "+t.icon}),SPAN({style:"margin-left: 10px;"},Object(a.a)(t.label),t.paid?" *":""))))})),e.appendChild(LI({class:"disabled"},A({href:"#"},"* "+Object(a.a)("m_premium_only")))),$(e).find("a").click(this.onAddActionMenuClick),this.models.each(this.addOne),this.$emptyEl[0==this.models.length?"removeClass":"addClass"]("hide"),this},reset:function(){_.each(this.actionGroups,(function(e){e.remove()})),this.actionGroups={},this.dels=[]}});var U=V;async function F(){if(!USER.id)return alert("Please sign in save global actions");l.a.info("loading");let e,t=new p.a.Sieve,i=new p.a.SieveActions(null,{parent:t});try{e=await h.a.api("/prefs/actions"),l.a.reset()}catch(e){return console.error(e),l.a.error("Please try again later. Failed to load data.")}i.set({data:e},{parse:!0});let n=new V({actions:i,sieve:t,parent:App.root,global:!0});const s=new c.a.SaveDiscardModal({name:"GlobalActionEditor$SaveDiscardModal",title:"Global Actions",titleEx:"taken on changes for all monitors, merged with monitor's actions",view:n,parent:App.root});s.on("save",async()=>{s.remove();let e=i.toJSON();try{await h.a.api("/prefs/actions","PUT",e),USER.prefs.actions=e}catch(e){console.error(e),l.a.error("Failed to save data, please try again later")}}),s.on("discard",()=>{s.remove()}),s.show()}var H=i(18);const Y=c.a.Base.extend({name:"SieveRuleEditor",className:"xtype-group",postInit:function(){this.paramsModel=new Backbone.Model(this.model.rule.params)},getConfig:function(){return{type:r.a.TYPE_RULE,contentType:this.getContentType(),rule:{type:this.getRuleType(),params:this.getParams()}}},getContentType:function(){return parseInt(this.selContentType.value)},getParams:function(){const e=_.pluck(this.getRuleDesc().params,"name"),t=this.paramsModel.toJSON();return _.pick(...[t].concat(e))},getRuleDesc:function(){return _.findWhere(H.a.DescList,{type:this.getRuleType()})||{type:0,lable:"l_rule_unknown",params:[]}},getRuleType:function(){return parseInt(this.selRuleType.value)},onTypeChange:function(){this.renderParams()},render:function(){let e;return this.$el.append(this.selContentType=SELECT.apply(window,_.map(H.a.ContentList,(function(e){return OPTION({value:e.type},Object(a.a)(e.label))}))),this.selRuleType=SELECT.apply(window,_.map(H.a.DescList,(function(e){return OPTION({value:e.type},Object(a.a)(e.label))}))),e=DIV({style:"margin-top: 4px;"})),this.selContentType.value=this.model.contentType,this.selRuleType.value=this.model.rule.type,this.$elParams=$(e),this.renderParams(),$(this.selRuleType).change(this.onTypeChange),this},renderParams:function(){const e=this.$elParams,t=this.paramsModel,i=this.getRuleDesc();if(!i)throw new Error("Unknown rule desc:"+this.getRuleType());e.empty();const n=_.map(i.params,(function(e){return d.a.create(e.type,{param:e,parent:this,model:t}).render().el}),this);e.append(n)}});var J=c.a.Base.extend({name:"SieveRuleGroupEditor",tagName:"fieldset",className:"xrulegroup",postInit:function(){this.editors=[]},addOne:function(e){e.type==r.a.TYPE_RULE?this.addRule(e):e.type==r.a.TYPE_RULE_GROUP&&this.addRuleGroup(e)},addEditor:function(e,t){let i,n;const s=this;this.$list.append(n=DIV({class:"row"},DIV({class:"col-md-1"},i=BUTTON({class:"btn xbtn-light"},I({class:"fa fa-trash-o"}))),DIV({class:"col-md-11",style:"padding-left: 0"},e.el))),$(i).click((function(){e.remove(),n.remove(),s.editors.splice(_.indexOf(s.editors,e),1)})),this.editors.push(e)},addRule:function(e){e||(e=this.defaultRule());const t=new Y({model:e,parent:this}).render();this.addEditor(t,!1)},addRuleGroup:function(e){e||(e=this.defaultRuleGroup());const t=new J({model:e,parent:this}).render();t.setConfig(e),this.addEditor(t,!0)},defaultRule:function(){return{type:r.a.TYPE_RULE,contentType:r.a.CONTENT_TYPE_CHANGED_TEXT,rule:{type:r.a.RULE_HAS_TEXT,params:{input:""}}}},defaultRuleGroup:function(){return{type:r.a.TYPE_RULE_GROUP,op:r.a.OP_AND,rules:[this.defaultRule()]}},getConfig:function(){return{type:r.a.TYPE_RULE_GROUP,op:parseInt(this.selOp.value),rules:_.map(this.editors,(function(e){return e.getConfig()}))}},isEmpty:function(){return 0==this.editors.length},onAddClick:function(e){const t=e.target.getAttribute("tag");t&&(t==r.a.TYPE_RULE?this.addRule():t==r.a.TYPE_RULE_GROUP&&this.addRuleGroup())},render:function(){let e,t;return this.$el.append(LEGEND(Object(a.a)("l_rule_true_if_matches_x")+" ",this.selOp=SELECT(OPTION({value:r.a.OP_AND},Object(a.a)("l_all")),OPTION({value:r.a.OP_OR},Object(a.a)("l_any")))," "+Object(a.a)("l_x_of_following_rules")+":",t=DIV({class:"btn-group xadd-rule right"},BUTTON({class:"btn btn-default btn-xs",tag:r.a.TYPE_RULE},I({class:"fa fa-plus"})," ",Object(o.a)("a_action_object","a_add","l_rule")),BUTTON({class:"btn btn-default btn-xs dropdown-toggle","data-toggle":"dropdown"},SPAN({class:"caret"})),UL({class:"dropdown-menu",role:"menu"},LI(A({tag:r.a.TYPE_RULE_GROUP,tabindex:-1,href:"javascript:void 0"},Object(o.a)("a_action_object","a_add","l_rule_group")))))),e=DIV()),$(t).click(this.onAddClick),this.$list=$(e),this},setConfig:function(e){console.log("setConfig",{model:e}),this.selOp.value=e.op,_.each(this.editors,(function(e){e.remove()})),this.editors=[],_.each(e.rules,this.addOne)}});const q=c.a.ActionProvider.extend({name:"SieveRulesEditor",actions:{add_condition:{fn:"action_add"},action_global_rules:{fn:"action_global_rules"}},action_add:function(){this.ruleView.addRule(),this.renderRules()},action_global_rules(){W()},duplicate:function(e){const t=new p.a.SieveRule({id:e});t.fetch({success:()=>{this.model.set(_.omit(t.attributes,"id","ts","ts_mod")),this.onLoad()}})},postInit:function(e){this.ruleView=new J({parent:this}).render(),this.model.isNew()?this.model.isEmpty()||_.delay(this.onLoad):(this.loading=!0,this.model.fetch({success:this.onLoad,error:this.onError}))},onError:function(){this.loading=!1,this.$body.empty(),this.$body.append(Object(a.a)("e_req")," ",Object(a.a)("h_try_later"))},onLoad:function(){this.loading=!1;let e=this.model.get("config");this.ruleView.setConfig(e),this.renderRules()},render:function(){let e;return this.$el.append(e=DIV({style:"max-height: 600px; overflow-y: auto; overflow-x:hidden;"})),this.$body=$(e),this.loading?this.$body.text(Object(a.a)("l_loading")):this.renderRules(),this},renderRules:function(){const e=this.$body;e.empty(),this.ruleView.isEmpty()?e.append(A({href:"#","data-action":"add_condition"},Object(o.a)("a_action_object","a_add","l_rule"))," ",this.options.global?"":A({href:"#",class:"right pl4","data-action":"action_global_rules"},"Global")):e.append(this.ruleView.el)},updateModel:function(){const e=this.ruleView.getConfig();this.model.set("config",e)}});var Q=q;async function W(){if(!USER.id)return alert("Please sign in save global conditions");let e;l.a.info("loading");try{e=await h.a.api("/prefs/rule"),l.a.reset()}catch(e){return console.error(e),l.a.error("Please try again later. Failed to load data.")}let t=new p.a.SieveRule({config:e}),i=new q({model:t,global:!0,parent:App.root});const n=new c.a.SaveDiscardModal({name:"GlobalRuleEditor$SaveDiscardModal",title:"Global Conditions",titleEx:"used for all monitors and combined with each monitor's conditions",view:i,parent:App.root});n.on("save",async()=>{n.remove(),i.updateModel();let e=t.get("config");try{await h.a.api("/prefs/rule","PUT",e),USER.prefs.rule=e}catch(e){console.error(e),l.a.error("Failed to save data, please try again later")}}),n.on("discard",()=>{n.remove()}),n.show()}var G=i(7),z=i(15);let X,Z,K,ee=e=>e;const te=window.Backbone;function ie(e,t="m",i=120){const n=e.val().trim().replace(/\s+/g,"").split(/(\d*\.*\d*)/);return(parseInt(n[1])||i)*{s:1,m:60,h:3600,d:86400,w:604800}[(n[2]||"").toLowerCase()[0]||t]}const ne=["Sunday","Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],se=["","Jan","Feb","March","April","May","June","July","August","Sep","Oct","Nov","Dec"];class ae extends G.a{constructor(e){super({...e.model.toJSON(),params:e.model.get("schedule").toJSON().params}),this.model=e.model,this.schedule=this.model.get("schedule"),this.el.classList.add("xtype-group"),this.el.classList.add("inline-block"),this.el.style.minWidth="480px"}onChange(e,t){const i=["m","h","dm","mon","dw"].indexOf(e),n={...this.state.params},{expr:s}=n,a=s.split(/\s/g);a[i]=t,n.expr=a.join(" "),this.state.params=n,5==a.length&&_.all(a,e=>e.length>0)&&this.setModelParams(n)}onPresetClick(e){e.preventDefault();const t={...this.state.params};t.expr=e.target.dataset.expr,this.state.params=t,this.setModelParams(t)}setModelParams(e){this.schedule.set("params",new te.Model(e)),this.model.trigger("change:schedule",this.schedule)}getDesc({m:e,h:t,dm:i,mon:n,dw:s}){function a(e,t){if(t.includes(",")){const i=t.split(",").map(t=>a(e,t)),n=i.pop();return`${i.join(", ")} and ${n}`}if("*"==t)return`every ${e}`;if(t.includes("-")){let[i,n]=t.split("-");return"month"==e&&(i=se[i],n=se[n]),"day-of-week"==e&&(i=ne[i],n=ne[n-1]),`every ${e} from ${i} through ${n}`}if(t.includes("/")){let[i,n]=t.split("/");const s="";let a="every";if(n>1){a=n+(["","st","nd","rd"][n]||"th")}return"*"==i?i=null:"month"==e?i=se[i]:"day-of-week"==e&&(i=ne[i]),`every  ${a} ${e} ${i?`from ${i} through ${s}`:""}`}return"month"==e&&(t=se[t],e=""),"day-of-week"==e&&(t=ne[t],e=""),`${e} ${t}`}try{return`At ${a("minute",e)} past ${a("hour",t)} on ${a("day-of-week",s)} in ${a("month",n)}`}catch(e){return console.error(e,arguments[0]),"Invalid expression"}}createTpl({params:e}){const t=e.expr,[i,n,s,a,o]=(e.tz||(new Date).getTimezoneOffset(),t.split(/\s/g)),r={m:i,h:n,dm:s,mon:a,dw:o},l=this.getDesc(r),c={m:"Minute",h:"Hour",dm:"Day",mon:"Month",dw:"Weekday"};return Object(G.b)(X||(X=ee`
      <table>
        <thead>
          ${0}
          <th></th>
        </thead>
        <tbody>
          <tr>
            ${0}
            <td>
              <div class='dropdown'>
                <a href='#' data-toggle='dropdown'>Use Preset <i class='fa fa-caret-down'></i></a>
                <ul class='dropdown-menu' @click=${0}>
                  <li><a href='#' data-expr='0 9 * * 1-5'>Weekdays at 9am</a></li>
                  <li><a href='#' data-expr='0 9-17 * * 1-5'>Weekdays between 9am to 5pm</a></li>
                  <li><a href='#' data-expr='0 9 * * *'>All days at 9am</a></li>
                  <li><a href='#' data-expr='0 9-17 * * *'>All days between 9am to 5pm</a></li>
                </ul>
              </div>
            </td>
          </tr>
          <tr>
            <td 
              style='width: 60px; padding: 0 12px;'
              colspan=6><div class='help'>
                ${0}
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    `),_.map(c,(e,t)=>Object(G.b)(Z||(Z=ee`<th class='col-md-2'>${0}</th>`),e)),_.map(c,(e,t)=>Object(G.b)(K||(K=ee`
                <td class='col-md-2'>
                  <input
                    style='width: 60px; padding: 0 10px;'
                    .value=${0}
                    placeholder=${0}
                    @keyup=${0}>
                  </input>
                </td>
                `),r[t],e,e=>this.onChange(t,e.target.value))),e=>this.onPresetClick(e),l)}remove(){}render(){return this}}var oe=c.a.ActionProvider.extend({name:"SieveIntervalScheduleEditor",convertToSlider:function(e){return Math.log(e)},convertToModel:function(e){return Math.round(Math.pow(Math.E,e))},focus:function(){this.textInput.focus()},getSliderValue:function(){return this.convertToModel(this.$slider.val())},setSliderValue:function(e){this.$slider.slider("setValue",this.convertToSlider(e))},remove:function(){this.$slider.data("slider")&&this.$slider.slider("destroy"),oe.__super__.remove.call(this)},render:function(){const e=this.model.get("schedule"),t=e.get("params").get("interval"),i=this.convertToSlider(t);return this.$el.empty().append(DIV({style:"display:flex;min-width:420px;margin-bottom:25px;"},this.slider=INPUT({style:"width:100%;",value:i}),this.textInput=INPUT({class:"xschdlr-input"})),SPAN({class:"help"},this.constraint=SPAN({style:"color: red; display: none;"},Object(a.a)("h_schedule_constraint_1"),Object(a.a)(e.formatInterval(USER.constraint.interval,!1)+"."),BR(),Object(a.a)("h_schedule_constraint_2"),A({href:"https://distill.io/pricing",target:"_blank"},"Upgrade Account"))),P({class:"help"},Object(a.a)("h_schedule_interval"))),this.$constraint=$(this.constraint),this.$slider=$(this.slider).slider({min:1.6,max:14.78,step:.05,tooltip:"hide",value:i,ticks:[1.6,3.4,5.7,8.3,11.55,14.78],ticks_positions:[0,13.657,31.107,50.834,75.493,100],ticks_labels:["5s","30s","5m","1h","1d","Never"],ticks_snap_bounds:0}).on("slide",this.updateValue).on("slideStop",this.updateModel),this.$textInput=$(this.textInput).on("change",this.textInputChanged).on("focus",(function(){this.select()})),this.updateValue(),this},textInputChanged:function(){const e=ie(this.$textInput,"m",3600);this.setSliderValue(e),this.updateValue(),this.updateModel()},updateModel:function(){this.updateValue();const e=this.model.get("schedule");this.model.trigger("change"),this.model.trigger("change:schedule",e)},updateValue:function(){const e=this.getSliderValue(),t=this.model.get("client_id"),i=this.model.get("schedule"),n=i.get("params"),s=USER&&USER.constraint,a=s&&s.interval||5;t==z.a.Clients.webAppId&&e<a?(n.set("interval",USER.constraint.interval),this.$constraint.css("display","block")):(n.set("interval",e),this.$constraint.css("display","none")),this.$textInput.val(i.getShortDisplayText())}});const re=c.a.ActionProvider.extend({name:"SieveLiveScheduleEditor",render:function(){return this.$el.append(DIV("Use it only if page auto-updates content using JavaScript."),DIV({class:"help"},Object(a.a)("l_schedule_live_desc"))),this}}),le=c.a.ActionProvider.extend({name:"SieveRandomScheduleEditor",render:function(){const e=this.model.get("schedule").get("params");return this.$el.empty().append(DIV(SPAN("Min: "),this.minInput=INPUT({class:"xschdlr-input"}),SPAN({style:"margin-left: 20px;"},"Max: "),this.maxInput=INPUT({class:"xschdlr-input"})),SPAN({class:"help"},this.constraint=SPAN({style:"color: black; display: none;"},Object(a.a)("h_schedule_constraint_1"),Object(a.a)(USER.constraint.interval+" seconds. "),BR(),Object(a.a)("h_schedule_constraint_2"),A({href:"https://distill.io/pricing",target:"_blank"},"Upgrade Account"))),P({class:"help"},Object(a.a)("h_schedule_random"))),this.$constraint=$(this.constraint),(this.$minInput=$(this.minInput)).val(e.get("min")),(this.$maxInput=$(this.maxInput)).val(e.get("max")),$([this.minInput,this.maxInput]).on("change",this.updateModel),this.updateValue(),this},updateModel:function(){this.updateValue();const e=this.model.get("schedule");this.model.trigger("change"),this.model.trigger("change:schedule",e)},updateValue:function(){if(ie(this.$minInput,"s")>ie(this.$maxInput,"s"))var e=Math.max(this.model.get("client_id")==z.a.Clients.webAppId?USER.constraint.interval:5,ie(this.$minInput,"s")+1);else e=Math.max(this.model.get("client_id")==z.a.Clients.webAppId?USER.constraint.interval:5,ie(this.$maxInput,"s"));const t=Math.max(this.model.get("client_id")==z.a.Clients.webAppId?USER.constraint.interval:5,ie(this.$minInput,"s")),i=this.model.get("schedule").get("params"),n=this.model.get("client_id"),s=USER&&USER.constraint;s&&s.interval;i.set("min",t),i.set("max",e),this.$minInput.val(t),this.$maxInput.val(e),n==z.a.Clients.webAppId?this.$constraint.css("display","block"):this.$constraint.css("display","none")}});var ce=c.a.ActionProvider.extend({name:"SieveScheduleEditor",EDITORS:{INTERVAL:oe,LIVE:re,RANDOM:le,CRON:ae},focus:function(){},render:function(){let e,t;const i=this.model.get("schedule").get("type");v.a.agents.local;this.model.get("schedule");let n=new this.EDITORS[i](_.extend({parent:this},this.options));return this.$el.css({display:"flex","flex-direction":"row"}).empty().append(DIV(e=SELECT({style:"margin-right: 20px;"},OPTION({value:"INTERVAL"},"Interval"),OPTION({value:"RANDOM"},"Random"),OPTION({value:"LIVE"},"Live (beta)"),USER.account_id?OPTION({value:"CRON"},"Crontab *"):OPTION({value:"CRON",disabled:""},"Crontab *"),OPTION({value:"",disabled:""},"*For Enterprise"))),t=DIV({style:"flex:1"},n.render().el)),$(e).val(i).on("change",()=>{const i=e.value,s=new p.a.Schedule({type:i});"RANDOM"==i&&s.get("params").set({min:60,max:120}),"CRON"==i&&s.get("params").set({expr:"* * * * *",tz:(new Date).getTimezoneOffset()}),n.remove(),this.model.set("schedule",s),this.model.trigger("change:schedule",s),n=new this.EDITORS[i](_.extend({parent:this},this.options)),$(t).empty().append(n.render().el)}),this}}),de=c.a.Base.extend({name:"TagsEditor",events:{"click :checkbox":"event_check"},event_check:function(e){const t=e.target,i=t.dataset.id,n=t.checked,s=App.labels.get(i);n?this.tags.push(s):this.tags=_.without(this.tags,s),this.model.set("tags",_.pluck(this.tags,"id").join(","))},postInit:function(){this.tags=this.model.getTags(App.labels),this.listenTo(App.labels,"sync",this.render)},render:function(){return this.$el.empty(),App.labels.length>0?this.$el.append(_.map(App.labels.models,e=>{const t=INPUT({type:"checkbox",style:"vertical-align: top;","data-id":e.id}),i=LABEL({style:"font-weight:normal;margin-right:8px; "},t,e.get("name"));return this.tags.indexOf(e)>=0&&(t.checked=!0),i})):this.$el.append("No label found."),this}});let he,ue,pe,fe,me=e=>e;const ge=window.diff_match_patch;if(!ge)throw new Error("ADD diff_match_patch");const ve=window.jQuery;if(!ve)throw new Error("ADD jQuery");const be=window._;if(!be)throw new Error("ADD _");const we=window.async;if(!we)throw new Error("ADD async");if(!window.domo)throw new Error("ADD domo");const _e=window.moment;if(!_e)throw new Error("ADD moment");const ye=window.Backbone;if(!ye)throw new Error("ADD Backbone");const xe=window.feeddiff;if(!xe)throw new Error("ADD feeddiff");const Se={snipped:!1,removed:!1};let Ie;const De={};let Ae;const Oe=c.a.ActionProvider.extend({name:"HTMLSelector",render:function(){return this.selectorModal=new L.Modal({model:this.model.clone(),parent:this,shouldShowNewVisualSelector:!0,onDiscard:this.onSelectorDiscard,onSave:this.onSelectorSave}),this.selectorModal.show(),this},onSelectorDiscard:function(){this.trigger("discard"),this.selectorModal.remove()},onSelectorSave:function(e,t){e?(l.a.error("Error running visual selector: "+e),this.trigger("error",e)):this.trigger("save",be.pick(t.toJSON(),"uri","name","config","content_type","session_id")),this.selectorModal.remove()}}),Ee=c.a.ActionProvider.extend({name:"PDFSelector",postInit:function(){this.editor=d.a.create("url",{param:{label:"m_enter_pdf_url",must:!0,name:"uri"},parent:this}).render(),this.listenTo(this.editor,"change",this.save)},save:function(){const e=this.editor.getValue(),t=e.split("/"),i=t[t.length-1],n={name:i+(i.match(/\.pdf$/)?"":" pdf"),uri:e,content_type:r.a.TYPE_PDF_HTML,config:{uri:e}};this.trigger("save",n)},render:function(){return this.$el.empty().append(this.editor.el),this}}),Te=c.a.ActionProvider.extend({name:"DOCSelector",postInit:function(){this.editor=d.a.create("url",{param:{label:"m_enter_doc_url",must:!0,name:"uri"},parent:this}).render(),this.listenTo(this.editor,"change",this.save)},save:function(){const e=this.editor.getValue(),t=e.split("/"),i=t[t.length-1],n={name:i+(i.match(/\.docx?$/)?"":" doc"),uri:e,content_type:r.a.TYPE_DOC,config:{uri:e}};this.trigger("save",n)},render:function(){return this.$el.empty().append(this.editor.el),this}}),ke=c.a.ActionProvider.extend({name:"SieveSourceSelector",postInit:function(){const e=this.model;let t;switch(e.get("content_type")){case r.a.TYPE_HTML:t=new Oe({parent:this,model:e});break;case r.a.TYPE_FEED:t=new y({parent:this,model:e});break;case r.a.TYPE_XML:t=new S({parent:this,model:e});break;case r.a.TYPE_PDF_HTML:t=new Ee({parent:this,model:e});break;case r.a.TYPE_DOC:t=new Te({parent:this,model:e});break;default:throw new Error("Unknown content_type")}t.on("save",e=>this.trigger("save",e)),t.on("discard",()=>this.trigger("discard")),this.view=t},render:function(){return this.$el.append(this.view.render().el),this}}),$e=function(e,t,i){const n=d.a.create("json",{param:{label:"l_selection_config",must:!1,name:"config",type:"json"},model:new ye.Model({config:e.get("config").toJSON()})}),s=new c.a.SaveDiscardModal({name:"SieveSourceEditor$ConfigModal",title:t,view:n});function a(t){return new(0,e.get("config").constructor)(t,{parse:!0})}s.on("save",(function(){const t=n.model.get("config");e.set({config:a(t)}),i(s)})),s.on("discard",(function(){s.remove()})),s.show(),n.$el.find("textarea").css("height",300)},Le=c.a.ActionProvider.extend({name:"SieveSourceEditor",actions:{edit_url:{fn:"action_edit_url"},force_static:{fn:"action_force_static"},selector_config_show:{fn:"action_config_show"},selector_edit:{fn:"action_selector_edit"}},action_config_show:function(){$e(this.model,Object(a.a)("l_selection_config"),e=>{e.remove()})},action_edit_url:function(){const e=this.model,t=d.a.create("url",{param:{label:"l_url",must:!0,name:"uri"},model:e.clone(),parent:this}),i=new c.a.SaveDiscardModal({name:"SieveSourceEditor$URLModal",parent:this,title:Object(a.a)("l_url"),view:t});i.show(),i.on("save",(function(){e.set({uri:t.getValue()}),i.remove()})),i.on("discard",(function(){i.remove()}))},action_force_static:function(){const e=this.model,t=e.get("config").get("selections");(t&&t.at(0)).set("dynamic",!1),this.checkURI(e),e.trigger("change")},action_selector_edit:function(){this.sourceSelector?this.onEditSourceSelectorDiscard():this.openSelector()},checkURI:function(e){if(e.get("content_type")!=r.a.TYPE_HTML)return;const t=e.get("uri"),i=e.get("config").get("selections").at(0),s=v.a.tabForXFrame,a=v.a.tabForDynamic,o=this.elXFrameNotice;if(!t||!1===i.get("dynamic")||!v.a.agents.local||!s&&!a)return ve(o).addClass("hide");a?ve(o).removeClass("hide"):s&&n.a.HTTP.get({url:t},(function(e,t,i){if(e)return l.a.error("Failed to fetch URL.");(i.getResponseHeader("x-frame-options")||/x-frame-options/i.test(t))&&ve(o).removeClass("hide")}))},onSourceSelectorSave:function(e){e.config=this.parseConfig(JSON.parse(e.config)),this.model.get("name")&&delete e.name,this.model.set(e),this.sourceSelector.remove(),this.sourceSelector=null},onEditSourceSelectorDiscard:function(){this.sourceSelector.remove(),this.sourceSelector=null,this.model.isNew()&&App.navBack()},openSelector:function(){this.sourceSelector=new ke({parent:this,model:this.model}),this.listenTo(this.sourceSelector,"save",this.onSourceSelectorSave),this.listenTo(this.sourceSelector,"discard",this.onEditSourceSelectorDiscard),this.sourceSelector.render(),this.elSelector.appendChild(this.sourceSelector.el),this.sourceSelector.$el.css({padding:10})},parseConfig:function(e){return new(0,this.model.get("config").constructor)(e,{parse:!0})},postInit:function(){const e=this.model;this.listenTo(e,"change:config change:uri",this.render),e.isEmpty()&&be.defer(this.openSelector),this.elXFrameNotice=DIV({class:"alert alert-info hide",style:"margin: 5px 0; padding: 5px;"},Object(a.a)("m_xframe_notice")," ",BUTTON({class:"btn btn-default btn-xs","data-action":"force_static"},Object(a.a)("a_static_load"))," ",A({href:"https://distill.io/help/new-tab-chrome-extension"},Object(a.a)("Learn More"))),this.listenTo(e,"change:uri",this.checkURI),this.checkURI(e)},render:function(){return this.$el.empty().append(DIV(DIV({class:"btn-group",role:"group"},BUTTON({type:"button",class:"btn btn-default","data-action":"selector_edit",title:Object(a.a)("h_selector_edit")},Object(a.a)("a_open_selector")),BUTTON({class:"btn btn-default dropdown-toggle","data-toggle":"dropdown"},SPAN({class:"caret"})),UL({class:"dropdown-menu"},LI(A({"data-action":"selector_config_show",href:"javascript:void 0"},Object(a.a)("h_config_show")))))," ",BUTTON({class:"btn btn-default","data-action":"edit_url"},Object(a.a)("a_edit")," ",this.model.get("uri"))),this.elXFrameNotice,this.elSelector=DIV()),this}}),Pe=c.a.ActionProvider.extend({name:"SieveOptions",actions:{sieve_save:{fn:"action_save"}},action_save:function(e,t){const i=this,n=this.model;l.a.start("sieve:save",{info:"saving"}),ve(t).button("loading"),we.series([function(e){const t=i.rulesEditor.model;if(i.rulesEditor.updateModel(),t.isNew()&&t.isEmpty())return e();l.a.start("sieve:rule:save",{info:"l_loading"}),t.save(null,{error:function(t,i){l.a.stop("sieve:rule:save",{error:"e_req"}),e({msg:"Failed to save conditions",err:i})},success:function(){n.get("rule_id")!=t.id&&n.set({rule_id:t.id},{silent:!0}),l.a.stop("sieve:rule:save"),e()}})},function(e){const t=be.omit(n.toJSON(),"err","text","ts","ts_data","ts_mod","ts_view","user_id");t.state==r.a.STATE_INIT&&(t.state=r.a.STATE_READY),n.save(null,{data:t,patch:!0,silent:!0,wait:!0,error:function(t,i){l.a.stop("sieve:save",{error:"Failed to save changes to server"}),e({msg:"Failed to save changes",err:i})},success:function(t){l.a.stop("sieve:save"),e(null)}})},function(e){const t=i.actionEditor.getChanges();u.a.syncBatch(t,e)||e()}],(function(e,n){ve(t).button("reset"),e?l.a.error("Failed to save data. Please check console for more info."):(i.trigger("save"),App.navBack())}))},duplicate:function(e){const t=this.collection.get(e),i=be.pick(t.toJSON(),"name","uri","config","client_id","content_type","schedule","tags");i.name="Copy of "+i.name,this.setModel(new this.collection.model(i,{parse:!0}),{defaultsModel:t,editURL:!0,skipSelector:!0})},edit:function(e){const t=this;this.fetch(e,(function(e,i){e?(t.action_discard(),l.a.error("Failed to get data")):t.setModel(i)}))},editNew:function(e){let t=0,i=!1;switch(e){case"page":t=r.a.TYPE_HTML;break;case"profile-page":i=!0,t=r.a.TYPE_HTML;break;case"feed":t=r.a.TYPE_FEED;break;case"xml":t=r.a.TYPE_XML;break;case"pdf":t=r.a.TYPE_PDF_HTML;break;case"doc":t=r.a.TYPE_DOC;break;default:throw l.a.error("Unknown monitor type: "+e),new Error("Unknown monitor type: "+e)}this.setModel(new p.a.Sieve({content_type:t},{parse:!0}),{useProfile:i})},fetch:function(e,t){new p.a.Sieve({id:e}).fetch({error:function(e,i){t(i)},success:function(e,i){e.changed={},t(null,e)}})},initEditors:async function(e,t){const i=new p.a.SieveActions(null,{parent:e}),n=new p.a.SieveRule({id:e.get("rule_id")||void 0});this.sourceEditor=new Le({model:e,parent:this,className:"controls"}).render(),this.clientSelector=new m.a.ClientSelector({model:e}),this.nameEditor=d.a.create("text",{model:e,param:{label:"l_name",must:!0,name:"name",type:"text"},parent:this}).render(),this.scheduleEditor=new ce({model:e,parent:this}).render(),this.actionEditor=new U({actions:i,sieve:e,parent:this}).render(),this.rulesEditor=new Q({model:n,parent:this}).render(),this.tagsEditor=new de({model:e,parent:this}).render(),await Promise.all([i.fetch(),n.fetch()]),this.loadDefaults(e,i,t)},createDefaults:function(e,t,i){const n=this,s=e.get("uri"),o=s&&new URL(s).hostname,l=new p.a.Sieves;if(be.isEmpty(e.get("name"))&&s&&(e.set("name",Object(a.a)("l_loading")),ve.get(URL_ROOT+"/v1/http/get?html_css_filter=title&url="+encodeURIComponent(s),(function(t){t&&e.set("name",ve(t).text().trim()||"Untitled")}))),i)return c(i,!0);function c(i,s){const a=new p.a.SieveActions(null,{parent:i});a.fetch({data:{state:0},success:function(){a.each((function(e){const i=e.omit("id","sieve_id","ts","ts_mod");t.add(new p.a.SieveAction[i.type](i,{parse:!0}))})),n.onChanges()}});let o=i.get("schedule");"LIVE"==o.get("type")&&(o=new p.a.Schedule({type:"INTERVAL"})),e.set("schedule",o),n.scheduleEditor.render();const r=i.get("rule_id");s&&r&&n.rulesEditor.duplicate(r)}l.fetch({data:{"uri.like":"%"+o+"%","state.in":[r.a.STATE_READY,r.a.STATE_PAUSED],_opt:{limit:1,order:["-ts"],only:["id","schedule","tags"]}},success:function(){if(l.length>0)return c(l.at(0),!1);l.fetch({data:{"state.in":[r.a.STATE_READY,r.a.STATE_PAUSED],_opt:{limit:1,order:["-ts"],only:["id","schedule","tags"]}},success:function(){l.length>0?c(l.at(0),!1):(be.each(p.a.SieveActionDescList,(function(e){e.addByDefault(v.a)&&t.add(new p.a.SieveAction[e.type])})),n.onChanges())}})}})},loadDefaults:function(e,t,i){e.isNew()||e.get("state")==r.a.STATE_INIT?this.createDefaults(e,t,i):t.fetch({data:{state:0}})},postInit:function(e){this.clients=e.clients},showProgress:function(){this.$el.children(".xprogress").show()},removeProgress:function(){this.$el.children(".xprogress").hide()},render:function(){return this.$el.empty().append(DIV({class:"xtbar xvbar-margin"},BUTTON({class:"btn btn-default","data-action":"go_back"},I({class:"fa fa-chevron-left"})," ",Object(a.a)("a_discard")," ",this.elUnsavedMsg=SPAN())),DIV({class:"xpage-header"},H3(this.elHeading=SPAN())),DIV({class:"xprogress",style:"margin-top: -2px;position:absolute;"},DIV({class:"xindeterminate"})),DIV({class:"form-horizontal",style:"padding: 10px;"},this.elContent=DIV())),this},renderOptions:function(){const e=this.model;this.model.getTags(App.labels);ve(this.elHeading).empty().append(Object(a.a)("l_options")," - ",e.isNew()?Object(a.a)("l_add_monitor"):e.get("name")),ve(this.elContent).empty().append(DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},Object(a.a)("l_source")),DIV({class:"col-md-10"},this.sourceEditor.el,P({class:"help"},Object(a.a)("h_sieve_source")))),DIV({class:"form-group"},LABEL({class:"control-label col-md-2",for:"sieve-device"},Object(a.a)("l_device")),DIV({class:"col-md-10"},this.clientSelector.el,P({class:"help"},Object(a.a)("h_sieve_device")))),DIV({class:"form-group"},LABEL({class:"control-label col-md-2",for:"sieve-name"},Object(a.a)("l_name")),DIV({class:"col-md-10"},this.nameEditor.el,P({class:"help"},Object(a.a)("h_sieve_name")))),DIV({class:"form-group"},LABEL({class:"control-label col-md-2",for:"sieve-schedule"},Object(a.a)("l_schedule")),DIV({class:"col-md-10"},this.scheduleEditor.el)),DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},Object(a.a)("l_actions")),DIV({class:"col-md-10"},this.actionEditor.el,P({class:"help"},Object(a.a)("h_sieve_actions")))),DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},Object(a.a)("l_conditions")),DIV({class:"col-md-10"},this.rulesEditor.el,P({class:"help"},Object(a.a)("h_sieve_rules")))),DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},Object(a.a)("l_label")),DIV({class:"col-md-10"},this.tagsEditor.el)),DIV({class:"form-group"},DIV({class:"col-md-offset-2 col-md-10 xtbar-form"},BUTTON({class:"btn btn-primary xbtn-default","data-action":"sieve_save"},Object(a.a)("a_save")),BUTTON({class:"btn btn-default","data-action":"go_back"},Object(a.a)("a_discard")))))},onChanges:function(){},onModelSelect:function(e){const t=(be.result(App.sieveList,"routePrefix")||"").split("/"),i=App.labels.findByName(decodeURIComponent(t[1])),n=new this.collection.model(be.defaults(e,{client_id:this.clients.defaultId,schedule:{type:"INTERVAL",params:{interval:10800}},tags:i?i.id:null,version:1}),{parse:!0});this.setModel(n,{skipSelector:!0})},onNewSourceSelectorDiscard:function(){this.sourceSelector.remove(),App.navBack()},setModel:async function(e,t={useProfile:!1,skipSelector:!1,defaultsModel:null,editURL:!1}){this.showProgress();let i={};this.model&&this.stopListening(this.model),this.model=e,this.sourceSelector&&this.sourceSelector.remove(),this.listenTo(e,"change",this.onChanges),ve(this.elUnsavedMsg).text("");try{i=await Object(O.a)(1)}catch(e){console.error(e),i={isOverLimit:!1}}this.model.isNew()&&i.isOverLimit?(this.sieveConstraints=new D.a({model:i,parent:this,url:URL_ROOT}).render(),ve(this.elHeading).text(Object(a.a)("m_monitor_limit")),ve(this.elContent).empty().append(this.sieveConstraints.el)):e.isEmpty()&&!0!==t.skipSelector?(e.prop("session",t.useProfile),this.showSourceSelector(e)):(await this.initEditors(e,t.defaultsModel),this.renderOptions(),t.editURL&&this.sourceEditor.action_edit_url()),this.removeProgress()},showSourceSelector(e){const t=new ke({model:e,parent:this}).render();t.on("save",this.onModelSelect),t.on("discard",this.onNewSourceSelectorDiscard),this.sourceSelector=t,ve(this.elHeading).text(Object(a.a)("l_source")),ve(this.elContent).empty().append(t.el)}});var je=c.a.Base.extend({initialize:function(e){je.__super__.initialize.call(this,e),this.oldModel=e.oldModel},getDiffCount:function(){return[0,0]},getDiffCount:function(){return[0,0]},setState:function(e){this.state=e,this.show(e)},show:function(e){if(!e.diff)return this.render();const t=this,i=this.model;l.a.start("diff",{info:"l_loading"});try{const e=new ge,n=i.get("data"),s=t.oldModel.get("data"),a=e.diff_main(s,n);e.diff_cleanupSemantic(a),t.$el.empty().append(e.diff_prettyHtml(a))}catch(e){t.$el.empty().append("Error showing diff: ",e.message).append(e.stack)}l.a.stop("diff")},showDiffModal:function(){throw new Error("Not implemented")}});const Re=je.extend({name:"SieveFeedView",tagName:"iframe",attributes:{frameborder:0,style:"width:100%;height:80px"},onFrameLoad:function(){this.el.style.height=this.el.contentDocument.documentElement.scrollHeight+"px",this.frame_loaded=!0,this.trigger("frame_loaded")},getDiffCount:function(){return[this.newFeedCount,this.updatedFeedCount]},postInit:function(){this.el.onload=this.onFrameLoad},show:function(e){const t=this;if(!this.frame_loaded)return void this.once("frame_loaded",(function(){t.show(e)}));const i=JSON.parse(this.model.get("data")),n=this.oldModel&&JSON.parse(this.oldModel.get("data")),s={},a=(new DOMParser,document.createElement("style"));this.el.contentDocument;let o;s.newHashedFeed=i,s.oldHashedFeed=n,o=".inserted{background-color:#b7fdcb;}",o+=".removed{background-color:#ff9494;}",o+="img{margin-top:2px;margin-bottom:5px;}",o+=e.removed?".removed{display:inline}":".removed{display:none}",o+="body{width:700px;margin:0 auto;padding:0 10px;}",o+=".summary{padding-top:5px;}",a.type="text/css",ve(a).attr("class","xdistill").text(o),xe.getUpdatedEntries(ot,s,t.model.id,(function(e,i){if(e)return console.error("Error in update feed: ",e),void l.a.error("Error finding changes in feed");0==i.changes.length?i.changes=s.newHashedFeed.entries:i.changes=i.newEntries.concat(i.updatedEntries),t.newFeedCount=i.newEntries.length,t.updatedFeedCount=i.updatedEntries.length;const n=new g.a.FeedEntryList({model:new f.a.FeedEntryCollection(i.changes)}).render();n.$el.append(a),t.once("frame_loaded",(function(){t.bubbleEvent("sieve:data:loaded")})),t.el.setAttribute("srcdoc",n.el.outerHTML)}))}});var Ne=je.extend({name:"SieveXMLView",postInit:function(e){Ne.__super__.postInit.call(this,e),this.show({diff:!0}),be.defer((function(){self.bubbleEvent("sieve:data:loaded")}))}});const Ce=je.extend({name:"SieveHTMLView",attributes:{src:window.IE?"javascript:document.write('<script>document.open();document.domain=\""+document.domain+"\";document.close();<\/script>')":"about:blank",frameborder:0,style:"width:100%;height:40px"},tagName:"iframe",getDiffCount:function(){return[ve(this.doc).find(".inserted").length,ve(this.doc).find(".removed").length]},postInit:function(){this.showingDiff=!1,this.el.onload=this.onFrameLoad,this.sieve=this.model.parent;this.model.get("text");this.el.style.height="40px"},onFrameLoad:function(){this.frameReady=!0,this.trigger("frame_ready"),ve(this.el.contentDocument).on("click",(function(e){"javascript:"==(e.target.href||"").slice(0,11)&&e.preventDefault()}))},onFrameReady:function(e){try{this.frameReady?e():this.once("frame_ready",e)}catch(e){console.error("Error calling frame ready callback",e)}},renderHTML:function(e,t){const i=this;this.model.id;let n=0;const s=this.el,a=s.contentWindow.document,o=a.documentElement,r=this.sieve.get("uri");rt(a,r,e),we.map(ve(o).find("link[rel=stylesheet]").toArray(),(function(e,t){const i=a.createElement("img");i.onerror=function(){t()},i.src=e.href}),(function(e,t){i.syncIntervalId&&clearInterval(i.syncIntervalId),i.syncIntervalId=setInterval((function(){try{const e=s.contentWindow;if(!e||!e.document)return void clearInterval(i.syncIntervalId);const t=e.document.body||o,a=Math.min(1e4,Math.max(o.scrollHeight,t.scrollHeight));a>e.innerHeight&&(s.style.height=a+"px"),(n+=1)>10&&clearInterval(i.syncIntervalId)}catch(e){throw clearInterval(i.syncIntervalId),e}}),100)})),setTimeout((function(){i.$("span").css({left:0,position:"relative"}),ve(o).find("a[href]").attr("target","_blank").attr("rel","noopener"),i.bubbleEvent("sieve:data:loaded")}),200)},show:function(e){if(this.state=e,this.shown)return this.doc&&this.showDoc(e);this.shown=!0;const t=this;l.a.start("diff",{info:"l_loading"});const i=t.model.get("data"),n=t.oldModel.get("data"),s=new DOMParser;Date.now();if(i==n)return a(i);function a(e){t.markedHTML=e,t.doc=s.parseFromString(e,"text/html"),0==t.doc.querySelectorAll(".inserted,.removed").length&&(t.markedHTML=i,t.doc=s.parseFromString(i,"text/html")),t.showDoc(t.state),l.a.stop("diff")}ot(n,i,t.model.id,(function(e,t){a(e?i:t)}))},showDoc:function(e){const t=this,i=this.doc,n=this.styleSheet||i.createElement("style");let s,a="";a=".inserted{background-color:#b7fdcb;}",a+=".removed{background-color:#ff9494;}",a+="span.inserted, span.removed{padding: 1px 4px;}",a+="a.removed, a .removed{color: #008}",a+="img.inserted{border: solid 2px green; background-color: transparent; padding: 2px;}",a+="img.removed{border: solid 2px red; background-color: transparent; padding: 2px;}",a+=e.removed?".removed{display:inline}":".removed{display:none}",e.snipped?(a+=".nonDiffHide {display:none}",this.srcStylesheet=i.querySelectorAll("link[rel=stylesheet], style:not(.xdistill)"),ve(this.srcStylesheet).remove(),t.styledElements2=ve(i).find("[style]").each((function(){this.dataset.oldStyle2=this.getAttribute("style"),this.removeAttribute("style")})),this.snippedHeight&&this.$el.height(this.snippedHeight)):(this.snippedHeight=this.snippedHeight||this.$el.height(),ve(i).find("head").append(this.srcStylesheet),t.styledElements2&&t.styledElements2.each((function(){this.setAttribute("style",this.dataset.oldStyle2)}))),ve(i).find('link[rel="stylesheet"], style:not(.xdistill)').length||(a+="body {padding: 10px;}",a+="td {padding: 10px}",a+="body {font-size: 0.94em}"),n.type="text/css",ve(n).attr("class","xdistill").text(a),i.body.appendChild(n),this.styleSheet=n,s=i.documentElement.outerHTML,t.onFrameReady((function(){t.renderHTML(s,e)}))},showDiffModal:function(){this.diffModal=new He({title:Object(a.a)("Highlighted Changes"),parent:this.getRoot(),model:this.model,html:this.markedHTML,width:"100%",height:"100%"}),this.diffModal.show()}}),Me=c.a.ContextMenu.extend({name:"DiffPrefMenu",events:{"change input":"event_change"},event_change:function(e){e.stopPropagation(),this.save()},getPrefs:function(){const e={};return this.$(":checkbox").each((function(t,i){e[i.name]=i.checked?1:0})),e},load:function(){const e=this;h.a.api("/users/prefs/ui_diff","GET",(function(t,i){t?(console.error("Failed to get prefs",t),e.showApiErr()):e.showPrefs(i),e.show()}))},renderMenu:function(){this.load(),this.$el.empty().append(LI({class:"xview"},DIV(Object(a.a)("l_loading"),"...")))},save:function(){const e=this.getPrefs();h.a.api("/users/prefs/ui_diff","PUT",e,(function(t,i){t?l.a.error("e_req"):(USER.prefs.ui_diff=e,v.a.agents.local&&n.a.SyncMan.get(n.a.store.UserStore,(function(){})))}))},showApiErr:function(e){this.$el.empty().append(LI({class:"xview error"},DIV("Couldn't get prefs. ",A({href:"/ui/settings.html#general"},"Sign in to account."))))},showPrefs:function(e){const t=Date.now()*Math.random()|0;be.defaults(e,Se),this.$el.empty().append(LI({class:"xview"},DIV({style:"font-size: 1.1em; "},Object(a.a)("Defaults")),DIV(INPUT({id:"removed"+t,name:"removed",type:"checkbox",style:"position: relative; top: 2px;"}),LABEL({for:"removed"+t,style:"margin:0 4px;padding:0;font-size:.9em; user-select: none;"},Object(a.a)("Deleted"))),DIV(INPUT({id:"snipped"+t,name:"snipped",type:"checkbox",style:"position: relative; top: 2px;"}),LABEL({for:"snipped"+t,style:"margin:0 4px;padding:0;font-size:.9em; user-select: none;"},Object(a.a)("Snipped"))))),this.$(":checkbox").each((function(t,i){e[i.name]&&(i.checked=1)}))}}),Ve=c.a.Base.extend({event_settings:function(e){Ae&&Ae.el.parentNode?(Ae.remove(),Ae=null):(Ae=new Me({parent:this})).toggle(this.name,e.currentTarget)}}),Ue=Ve.extend({name:"FeedBar",events:{"click .xsettings":"event_settings","click .xremoved":"event_show_removed"},event_show_removed:function(e){this.state.removed=e.target.checked,this.updateState()},postInit:function(e){this.state=be.extend({},Se,USER.prefs.ui_diff),this.view=e.view,this.view.setState(this.state)},render:function(){const e=Date.now()*Math.random()|0;return this.$el.css({position:"absolute",right:1,borderBottom:"solid 1px #ddd",backgroundColor:"#f3f3f3",backgroundColor:"#f0f0f0",marginTop:"-4px",padding:0}).append(DIV({class:"inline-block"},DIV({class:"btn",style:"padding:0 6px;",title:"Shows the number of new and updated feeds"},SPAN({style:"font-weight: bold;"},this.elNewFeed=SPAN(0)," new, ")," ",SPAN({style:"font-weight: bold;",title:"Shows the number of new and updated feeds"},this.elChangedFeed=SPAN(0)," updated. ")),INPUT({class:"xremoved",type:"checkbox",id:"show-del"+e}),LABEL({for:"show-del"+e,style:"margin:0 4px;font-size:.9em; user-select: none;",title:"Shows deleted content in changed feed entry"},"Deleted"),BUTTON({class:"btn btn-default btn-sm xsettings",style:"min-width:20px;padding:0;margin:0;"},I({class:"fa fa-cog"})))),this},setDiffCount:function(e){this.elNewFeed.textContent=Math.min(e[0],999),this.elChangedFeed.textContent=Math.min(e[1],999)},updateState:function(){this.$(".xremoved").prop("checked",this.state.removed),this.view.setState(this.state)}}),Be=Ve.extend({name:"DiffBar",events:{"click .xpopup":"event_popup","click .xsettings":"event_settings","click .xsnipped":"event_show_snipped","click .xremoved":"event_show_removed"},event_popup:function(e){this.popWindow(e)},event_show_removed:function(e){this.state.removed=e.target.checked,this.updateState()},event_show_snipped:function(e){this.state.snipped=e.target.checked,this.updateState()},postInit:function(e){this.state=be.extend({},Se,USER.prefs.ui_diff),this.view=e.view,this.view.setState(this.state)},render:function(){const e=this,t=Date.now()*Math.random()|0;return this.$el.css({position:"absolute",right:1,borderBottom:"solid 1px #ddd",backgroundColor:"#f3f3f3",backgroundColor:"#f0f0f0",marginTop:"-4px",padding:0}).append(DIV({class:"inline-block"},A({class:"btn btn-default btn-sm xpopup",style:"padding:0 6px; margin-right: 4px;"},Object(a.a)("Explore diff (beta)")," ",SPAN({style:"color: green;font-weight: bold;"},this.elPlus=SPAN(0),"+")," ",SPAN({style:"color: red;font-weight: bold;"},this.elMinus=SPAN(0),SPAN({style:"font-size: 1.1em; line-height: 1.1"},"–"))),INPUT({id:"removed"+t,class:"xremoved",name:"removed",type:"checkbox",style:"position: relative; top: 2px;"}),LABEL({for:"removed"+t,style:"margin:0 4px;padding:0;font-size:.9em; user-select: none;"},Object(a.a)("Deleted")),INPUT({id:"snipped"+t,class:"xsnipped",name:"snipped",type:"checkbox",style:"position: relative; top: 2px;"}),LABEL({for:"snipped"+t,style:"margin:0 4px;padding:0;font-size:.9em; user-select: none;"},Object(a.a)("Snipped")),BUTTON({class:"btn btn-default btn-sm xsettings",style:"min-width:20px;padding:0;margin:0;"},I({class:"fa fa-cog"})))),this.$(":checkbox").each((function(t,i){e.state[i.name]&&(i.checked=!0)})),this},setDiffCount:function(e){this.elPlus.textContent=Math.min(e[0],999),this.elMinus.textContent=Math.min(e[1],999),e[0]+e[1]==0&&this.$(".xpopup,.xsnipped,.xremoved").attr("disabled",1)},updateState:function(){this.$(".xsnipped").prop("checked",this.state.snipped),this.$(".xremoved").prop("checked",this.state.removed),this.view.setState(this.state)},popWindow:function(e){this.view.showDiffModal()}}),Fe=c.a.Base.extend({attributes:{style:"width: 100%;"},getScrollHeight:function(){return this.frameReady?this.iframe.contentWindow.document.body.scrollHeight:400},toggleStyle:function(e){const t=this;this.onFrameReady((function(){const i=t.iframe.contentWindow.document;e?(t.styleSheets=i.querySelectorAll("link[rel=stylesheet],style:not(.xdistill)"),ve(t.styleSheets).remove(),t.styledElements=ve(i).find("[style]").each((function(){this.dataset.oldStyle=this.getAttribute("style"),this.removeAttribute("style")}))):(ve(i.head).append(t.styleSheets),t.styledElements.each((function(){this.setAttribute("style",this.dataset.oldStyle)})))}))},hideRemoved:function(){const e=this;this.onFrameReady((function(){ve(e.iframe.contentWindow.document).find(".removed").addClass("xdistill-hide")}))},hideInserted:function(){const e=this;this.onFrameReady((function(){ve(e.iframe.contentWindow.document).find(".inserted").addClass("xdistill-hide")}))},moveToNextDiff:function(){let e=0;const t=this.options.scrollCt,i=t.scrollTop,n=ve(t).height(),s=ve(this.iframe.contentWindow.document).find(".diffMark:visible");for(;e<s.length&&s.eq(e++).offset().top-i<n;);return!!s[e-=1]&&(s[e].scrollIntoView({behavior:"smooth"}),!0)},moveToPrevDiff:function(){const e=this.options.scrollCt,t=e.scrollTop,i=(ve(e).height(),ve(this.iframe.contentWindow.document).find(".diffMark:visible"));let n=i.length;for(;--n>0&&i.eq(n).offset().top+i.eq(n).height()>t;);i[n].scrollIntoView({behavior:"smooth"})},onFrameReady:function(e){try{this.frameReady?e():this.once("frame_ready",e)}catch(e){console.error("Error calling frame ready callback",e)}},onViewReady:function(e){try{this.viewReady?e():this.once("view_ready",e)}catch(e){console.error("Error calling view ready callback",e)}},render:function(){const e=this,t=IFRAME({class:"data-pad",width:"100%",scrolling:"no",style:"border: none;"});return this.iframe=t,this.$el.append(t),t.onload=function(){e.frameReady=!0,e.trigger("frame_ready")},this.onFrameReady(this.renderFrameContent),this},renderFrameContent:function(){const e=this,t=this.options.model.parent,i=this.options.html,n=this.iframe.contentWindow.document,s=n.createElement("style");rt(n,t.get("uri"),i),ve(s).attr({class:"xdistill",type:"text/css"}).text(".removed {background-color:#ff9494; display:inline !important}a.removed, a .removed {color: #008}.inserted {background-color:#b7fdcb; display:inline !important}span.inserted, span.removed{padding: 1px 4px;}.xdistill-hide {display: none !important} img.inserted{border: solid 2px green; background-color: transparent; padding: 2px;}img.removed{border: solid 2px red; background-color: transparent; padding: 2px;}"),ve(n).find("body").append(s);const a=ve(n).find('link[rel="stylesheet"]');we.each(a,(function(e,t){e.addEventListener("load",t)}),(function(t,i){e.viewReady=!0,e.trigger("view_ready")}))},scrollFirstDiffIntoView:function(){const e=ve(this.iframe.contentWindow.document).find(".diffMark:visible")[0];return!!e&&(e.scrollIntoView({behavior:"smooth"}),!0)},setFrameHeight:function(e){ve(this.iframe).css("height",e)},showDiff:function(){const e=this;this.onFrameReady((function(){ve(e.iframe.contentWindow.document).find(".inserted").removeClass("xdistill-hide"),ve(e.iframe.contentWindow.document).find(".removed").removeClass("xdistill-hide")}))}});var He=c.a.Modal.extend({events:{"click .xdiff-toggle-mode":"toggleMode","click .xdiff-toggle-style":"toggleStyle","click .xleft-frame-up":"moveToPrevDiffLeftEle","click .xleft-frame-down":"moveToNextDiffLeftEle","click .xright-frame-up":"moveToPrevDiffRightEle","click .xright-frame-down":"moveToNextDiffRightEle"},headerClass:"panel-heading xpanel-heading-alt",showSplitView:function(){this.view1.$el.parent().css("width","50%"),this.view2.$el.parent().css("width","50%"),ve(this.elView2).show(),this.view1.hideRemoved(),this.view2.hideInserted(),ve(this.toolbarView1).css("right","51%"),this.syncHeight()},showInlinedView:function(){this.view1.$el.parent().css("width","100%"),ve(this.elView2).hide(),this.view1.showDiff(),ve(this.toolbarView1).css("right","10px"),this.syncHeight()},syncHeight:function(){const e=Math.max(this.view1.getScrollHeight(),this.view2.getScrollHeight());this.view1.setFrameHeight(e),this.view2.setFrameHeight(e),ve(this.scrollCt).css("height",ve(window).height()-this.scrollCt.getBoundingClientRect().y)},toggleMode:function(e){this.isModeInlined=!this.isModeInlined,this[this.isModeInlined?"showInlinedView":"showSplitView"]();const t=ve(e.currentTarget);t.find(".active").removeClass("active").removeClass("btn-primary"),t.find(this.isModeInlined?".xdiff-mode-inlined":".xdiff-mode-sbs").addClass("active btn-primary"),this.syncHeight()},toggleStyle:function(e){this.isStyleRemoved=!this.isStyleRemoved,this.view1.toggleStyle(this.isStyleRemoved),this.view2.toggleStyle(this.isStyleRemoved);const t=ve(e.currentTarget);t.find(".active").removeClass("active").removeClass("btn-primary"),t.find(this.isStyleRemoved?".xdiff-style-restore":".xdiff-style-remove").addClass("active btn-primary"),this.syncHeight()},moveToPrevDiffLeftEle:function(){this.view1.moveToPrevDiff()},moveToNextDiffLeftEle:function(){this.view1.moveToNextDiff()},moveToPrevDiffRightEle:function(){this.view2.moveToPrevDiff()},moveToNextDiffRightEle:function(){this.view2.moveToNextDiff()},renderHeader:function(){let e,t,i;return t=DIV(i=DIV({class:"xtbar xvbar-margin pull-right"},BUTTON({class:"close","data-action":"modal close",title:Object(a.a)("a_window_close")},"✕")),e=DIV({class:"xtbar xvbar-margin"},DIV({class:"btn-group btn-toggle xdiff-toggle-mode"},BUTTON({class:"btn btn-default xdiff-mode-sbs btn-primary active"},Object(a.a)("Side-by-side diff")),BUTTON({class:"btn btn-default xdiff-mode-inlined"},Object(a.a)("Inlined diff"))),DIV({class:"btn-group btn-toggle xdiff-toggle-style"},BUTTON({class:"btn btn-default xdiff-style-remove btn-primary active"},Object(a.a)("Styled Page")),BUTTON({class:"btn btn-default xdiff-style-restore"},Object(a.a)("Unstyled Page"))),A({href:this.model.parent.get("uri"),class:"btn btn-default",target:"_blank",rel:"noopener"},I({class:"fa fa-external-link"}))))},renderView:function(){const e=this,t=DIV({style:"overflow-y: scroll;"},this.elView1=DIV({style:"width: 50%; height: 100%; float: left"},this.toolbarView1=DIV({class:"btn-group",style:"position: fixed; right: 51%"},BUTTON({class:"btn btn-default xleft-frame-up"},I({class:"fa fa-chevron-up"})),BUTTON({class:"btn btn-default xleft-frame-down"},I({class:"fa fa-chevron-down"})))),this.elView2=DIV({style:"width: 50%; height: 100%; float:right;"},DIV({class:"btn-group",style:"position: fixed; right: 15px;"},BUTTON({class:"btn btn-default xright-frame-up"},I({class:"fa fa-chevron-up"})),BUTTON({class:"btn btn-default xright-frame-down"},I({class:"fa fa-chevron-down"})))));function i(){e.view1.frameReady&&e.view2.frameReady&&(e.syncHeight(),ve(e.view2.iframe).css("border-left","solid 1px #666"),console,e.view1.scrollFirstDiffIntoView()||e.view2.scrollFirstDiffIntoView()),ve(window).resize(e.syncHeight),e.on("remove",(function(){ve(window).off("resize",e.syncHeight)}))}return this.scrollCt=t,this.view1=new Fe({parent:this.parent,model:this.model,html:this.options.html,scrollCt:t}).render(),this.elView1.appendChild(this.view1.el),this.view2=new Fe({parent:this.parent,model:this.model,html:this.options.html,scrollCt:t}).render(),this.elView2.appendChild(this.view2.el),this.view1.hideRemoved(),this.view2.hideInserted(),this.view1.onViewReady(i),this.view2.onViewReady(i),t}});const Ye=c.a.Base.extend({name:"SieveDataView",className:"xsieve-data-item",action_email:async function(){l.a.info("loading");let e=await h.a.api("/users/attrs",{name:"email",state:40});l.a.reset();const t=SELECT(e.data.map(e=>OPTION({value:e.value},e.value))),i=new c.a.Base({el:DIV({style:"margin: 5px;"},t)}),n=new c.a.SaveDiscardModal({name:"SieveData$Email",parent:this,title:"Email",a_save:"Send",view:i});n.on("save",async()=>{try{let e=this.view.el.contentDocument.cloneNode(!0);!function(e){lt(e.querySelectorAll(".removed"),"background-color","#ff9494"),lt(e.querySelectorAll(".inserted"),"background-color","#b7fdcb"),lt(e.querySelectorAll("span.inserted, span.removed"),"padding","1px 4px"),lt(e.querySelectorAll("a.removed, a .removed"),"color","#008"),lt(e.querySelectorAll("img.removed"),"border","solid 2px red"),lt(e.querySelectorAll("img.removed"),"background-color","transparent"),lt(e.querySelectorAll("img.removed"),"padding","2px"),lt(e.querySelectorAll("img.inserted"),"border","solid 2px green"),lt(e.querySelectorAll("img.inserted"),"background-color","transparent"),lt(e.querySelectorAll("img.inserted"),"padding","2px")}(e),await h.a.api("/agents/actions/email","POST",{action:{config:{email:t.value}},sieve:this.model.parent.pick("id","name","uri","ts"),sieve_data:this.model.pick("id","text","ts"),emailContent:`<div id="highlighted-inlined"\n            style="padding: 10px; background-color: #fff">\n            ${e.body.innerHTML}\n          </div>`,hasDiff:!0}),n.remove()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}}),n.on("discard",()=>n.remove()),n.show()},createView:function(){const e=this.model,t=this.options.oldModel,i={index:this.options.index,parent:this,model:e,oldModel:t};switch(e.get("data_type")){case r.a.TYPE_HTML:return new Ce(i);case r.a.TYPE_FEED:return new Re(i);case r.a.TYPE_XML:return new Ne(i);case r.a.TYPE_PDF_HTML:case r.a.TYPE_DOC:return new Ce(i);default:return new ye.View({el:SPAN("ERR! Unknown data type")})}},onViewLoad:function(){this.bubbleEvent("sieve:data:loaded"),this.diffBar&&this.diffBar.setDiffCount(this.view.getDiffCount())},postInit:function(){this.view=this.createView(),this.view.on("sieve:data:loaded",this.onViewLoad),this.model.get("data_type")==r.a.TYPE_FEED&&(this.diffBar=new Ue({parent:this,view:this.view})),this.model.get("data_type")==r.a.TYPE_HTML&&(this.diffBar=new Be({parent:this,view:this.view})),this.model.get("data_type")==r.a.TYPE_DOC&&(this.diffBar=new Be({parent:this,view:this.view})),this.model.get("data_type")==r.a.TYPE_PDF_HTML&&(this.diffBar=new Be({parent:this,view:this.view})),this.listenTo(this.model,"destroy",this.remove)},render:function(){const e=_e(this.model.get("ts_mod"));let t,i;return this.$el.empty().append(this.diffBar?this.diffBar.render().el:"",DIV({style:"display:flex;margin:4px 0;"},DIV({style:"margin-right:10px;",title:e.format()},t=A({href:"#"},I({class:"fa fa-caret-down f4"})," ",e.format("hh:mm A")),DIV({style:"position: relative"},A({href:"#",class:"dropdown-toggle","data-toggle":"dropdown"},I({class:"fa fa-caret-down f4"})," ",e.format("MMM DD")),UL({class:"dropdown-menu",role:"menu"},LI(i=A({tabindex:-1,href:"#"},Object(a.a)("Email")))))),DIV({style:"flex:1;background-color:#fff;border-bottom:solid 1px #ccc;"},DIV({style:"flex:1;background-color:#fff;border-bottom:solid 1px #ccc;"},this.view.render().el)))),ve(t).click(e=>{e.preventDefault(),this.collapsed=!this.collapsed,ve(t).find(".fa").toggleClass("fa-caret-right").toggleClass("fa-caret-down"),this.view.$el[this.collapsed?"hide":"show"]()}),ve(i).click(e=>{e.preventDefault(),this.action_email()}),this}}),Je=c.a.Base.extend({name:"Work",render:function(){const e=this.model.attributes,t=e.err,i=this;return t?this.$el.append(A({href:"#",class:"error"},SPAN(st(e.ts))," ",SPAN(t.code||"EUNKOWN"))," ",e.snap_id?A({href:`${URL_ROOT}/snaps/${t.id}/index.html/`,target:"_blank"},Object(a.a)("l_snapshot")):"").find("a:first-child").popover({placement:"left",html:!0,trigger:"click|focus",content:function(){return DIV(DIV(LABEL("Code:")," ",SPAN(t.code||"NA")),DIV(LABEL("Msg:")," ",SPAN(t.msg||t.message||JSON.stringify(t))),DIV({style:"padding-top: 5px;"},STRONG("Recommended Actions"),i.getSuggestions(t)),DIV({style:"padding-top: 5px;"},STRONG("Need help?"),DIV("Contact us at support@distill.io"))).outerHTML}}).click((function(e){e.preventDefault()})):this.$el.append(SPAN(st(e.ts))),this},getSuggestions:function(e){switch(e.code||"NA"){case"SELECTION_EMPTY":return UL({style:"padding-left:14px;"},LI("Ensure that seleced elements has text content."),LI("If website needs login, make sure that you are logged in."));case"TIMEOUT":case"ENOTFOUND":case"EREQUEST":case"ETIMEDOUT":case"ECONNREFUSED":return DIV("Please ensure that the webpage is accessible.");case"JAVASCRIPT":return DIV("Ensure that JavaScript is working in the page.");default:return 0===e.status?DIV("Ensure that internet connection is working."):DIV("There is no information about this error.")}}}),qe=c.a.Collection.extend({name:"Works",postInit:function(){this.sieve=this.collection.parent,this.collection.fetch(),this.collection.on("sync",this.onSync)},addOne:function(e){const t=new Je({model:e,parent:this});return this.$msg.empty(),this.$list.append(t.render().el),t},onSync:function(){0==this.collection.length&&(this.sieve.get("client_id")==App.clients.defaultId?this.$msg.text(Object(a.a)("m_log_na")):this.$msg.text(Object(a.a)("Log for this monitor will be available on device that runs this monitor")))},renderBase:function(){this.$msg=ve(DIV(Object(a.a)("l_loading"))),this.$list=ve(DIV()),this.$el.append(this.$msg,this.$list)}}),Qe=c.a.ActionProvider.extend({render:function(){return this.$el.empty().append(DIV({class:"form-actions btn-toolbar flex align-item justify-center pa3"},BUTTON({class:"btn btn-default ","data-action":"sieve more data"},Object(a.a)("Show More")),BUTTON({class:"btn btn-default ","data-action":"sieve edit"},Object(a.a)(Object(a.a)("a_edit_options"))),BUTTON({class:"btn btn-default","data-action":"sieve view close"},Object(a.a)("Close")))),this}}),We=c.a.ActionProvider.extend({name:"SieveDataList",fetch:function(){const e=this,t=this.$('[data-action="sieve more data"]'),i=this.$(".xmsg"),n=!this.lastData,s=n&&this.options.initialFetchCount||2,o={_opt:{limit:s}};n||(o["ts.lt"]=this.lastData.ts),t.button("loading"),l.a.start("sieve:data:fetch",{info:"l_loading"}),h.a.api("/sieves/"+this.model.id+"/data","GET",o,(function(o,r){if(t.button("reset"),o)return e.removeProgress(),l.a.stop("sieve:data:fetch",{error:"err:sieve:data:fetch"});const c=e.data,d=r.data;let h=[];if(l.a.stop("sieve:data:fetch"),n&&0==r.count)return e.$data.append(DIV({class:"xinfo"},Object(a.a)("m_history_empty"))),void e.removeProgress();i.removeClass("hide").find(".info > span").text(r.count),n?(h=d.slice(0)).length>s-1&&h.pop():(e.lastData.id!=e.lastDisplayedData.id&&h.push(c[c.length-1]),d.length>1&&(h=h.concat(d)).pop()),d.length>0&&(e.lastData=d[d.length-1]);for(let t=0;t<h.length;t+=1)e.addDataView(h[t],h[t+1]||e.lastData,t);h.length>0&&(e.lastDisplayedData=h[h.length-1]),e.data=c.concat(d),r.count}))},addDataView:function(e,t,i){const n=new ye.Model(e);n.parent=this.model;const s=new Ye({index:i,model:n,oldModel:t&&new ye.Model(t),parent:this}).render();this.listenTo(s,"sieve:data:loaded",this.removeProgress),this.$(".xinfo").remove(),this.$data.append(s.el)},postInit:function(e){this.listenTo(this.model,"change:ts_data",this.renderUpdateMsg),this.resetData()},removeProgress:function(){this.$(".xprogress").remove()},render:function(){const e=this.model.get("err"),t=A({href:"https://distill.io/help/check-log","data-action":"sieve log menu","data-action-param":this.model.id},"View log for details."),i=e&&DIV({class:"xinfo"},SPAN({class:"error"},Object(a.a)("Error encountered checking for updates. It may correct automatically on next check.")," ",t)," ",A({href:"https://distill.io/help/contact"},"Get help."))||"",n=DIV({class:"xprogress",style:"margin-top: -2px;position:absolute;"},DIV({class:"xindeterminate"})),s=DIV({class:"xsieve-data"},i),o=DIV({class:"xmsg centered hide"},SPAN({class:"info"}));return this.$el.append(DIV({class:"xview-body"},n,s),o).css({margin:"4px 0"}),this.$data=ve(s),this},resetData:function(){delete this.lastData,delete this.lastDisplayedData,this.data=[],this.removeChildren(),this.fetch()},renderUpdateMsg:function(){const e=ve(DIV({style:"text-align:center;"},"Updated. Reloading now... "));be.delay(this.resetData,100),be.delay((function(){e.remove()}),1400)}}),Ge=c.a.ActionProvider.extend({name:"SieveDetail",actions:{"sieve edit":{fn:"action_edit"},"sieve more data":{fn:"action_more"},"sieve view close":{fn:"action_close"}},action_close:function(){this.parent.route()},action_edit:function(){App.edit(this.model.id)},action_more:function(){this.list.fetch()},postInit:function(){this.toolbar=new Qe({parent:this}),this.list=new We({parent:this,model:this.model,initialFetchCount:3})},render:function(){return this.$el.empty().append(this.list.render().el,this.toolbar.render().el),this}});var ze=c.a.Base.extend({name:"SieveRow",className:"xitem",tagName:"tr",events:{"click :checkbox":"event_check"},event_check:function(){this.model.prop("select",this.$("input[type=checkbox]:checked").length>0)},onSelect:function(e){this.$el[e?"addClass":"removeClass"]("active")},postInit:function(e){const t=this.model,i=t.id;this.listenTo(t,"change",this.renderRow),this.listenTo(t,"destroy",this.remove),this.listenTo(t,"remove",this.remove),this.listenTo(t,"sync",this.onSync),this.listenTo(t,"prop:select",this.onSelect),this.elDetail=TR(TD({colspan:8})),this.listenTo(j.a,"sieves:"+i,this.onSieveUpdate),this.listenTo(j.a,"sieves:run_state:"+i,this.onSieveRunState)},reattach:function(){const e=this.el.parentNode;e&&e.removeChild(this.el),e&&e.appendChild(this.el),this.elDetail.parentNode&&(e.removeChild(this.elDetail),e.appendChild(this.elDetail))},isSelected:function(){return this.model.prop("select")},markRead:function(){if(!this.model.isRead()){const e=this.model.getTags(App.labels).map((function(e){return e.id}));this.model.save({tags:e.join(","),ts_view:at(new Date)},{patch:!0})}},onSieveRunState:function(e){this.runState=e.doc.state,this.renderRow()},onSieveUpdate:function(e){e.doc?(this.model.set(this.model.parse(e.doc),{silent:!0}),this.model.trigger("change")):this.model.fetch()},onSync:function(){this.render()},remove:function(){ze.__super__.remove.call(this),ve(this.elDetail).remove()},removeDetail:function(){this.$el.removeClass("active"),this.detail&&this.detail.remove(),ve(this.elDetail).remove(),this.setSelected(!1),delete this.detail},render:function(){return this.renderRow(),this.detail&&this.showDetail(this.detail),this.setSelected(this.isSelected()),this},renderRow:function(){let{runState:e}=this;Object(G.c)((t=>Object(G.b)(he||(he=me`
      <td data-action = 'void 0'>
        <label class='xtd xdata xaction'>
          <input type="checkbox" style='margin:0;vertical-align:middle;'>
        </label>
      </td>
      <td data-action = 'void 0'>
        <button class='xtd xbtn xaction' style='margin: 0;' data-action= 'sieve context menu' data-action-param= '$parents [data-id]@data-id'>
          <i class="fa fa-caret-down"></i>
        </button>
      </td>
      <td>
        <a @click=${0} class='xtd xdata' href=${0} rel='noopener' target='_blank' title=${0}>
          <img width= 14 src=${0} loading='lazy'></img>
          ${0}
        </a>
      </td>
      <td data-action= 'sieve view' data-action-param=${0}>
        <div class= 'xtd xdata xaction', title= 'Click to view history'>
          <i class="xcaret fa fa-angle-double-down fa-lg"></i>
          ${0}
          <span>
            ${0}
          </span>
          <span>
          ${0}
          </span>
        </div>
      </td>
      <td class= ${0}>
        <a 
          class= 'xtd xdata xaction'
          title= 'Click to edit schedule'
          data-action= 'sieve schedule menu'
          data-action-param= '$parents [data-id]@data-id'
          data-toggle= 'tooltip'>
            <small>${0}</small>
            <i class="xcaret fa fa-caret-down"></i>
        </a>
      </td>
      <td>
        <a
        class= ${0}
        title= 'Click to view check/error log'
        data-action= 'sieve log menu'
        data-action-param= '$parents [data-id]@data-id'
        data-toggle= 'tooltip'>
          <small>${0}</small>
          <i class="xcaret fa fa-caret-down"></i>
        </a>
      </td>
      <td style='padding: 0'>
        <a
        class= 'xtd xdata xaction xbtn'
        title= 'Click to edit device'
        data-action= 'sieve client menu'
        data-action-param= '$parents [data-id]@data-id'
        data-toggle= 'tooltip'
        style= 'text-align:center'>
          <i class="fa fa-lg ${0}"  style= 'margin: auto;'></i>
          <i class="xcaret fa fa-caret-down"></i>
        </a>
      </td>
      <td data-action= 'void 0' style= 'padding: 0'>
        <button
          class= ${0}
          style= 'border-radius:0'
          data-action= 'sieve switch'
          data-action-param= '$parents [data-id]@data-id'
          title= 'Turn monitor ON or OFF'
          data-placement= 'left'>
          ${0}
        </button>
      </td>
    `),e=>this.markRead(),t.attributes.uri||"#",t.attributes.name,URL_ROOT+"/v1/getfavicon?url="+escape(t.attributes.uri),t.attributes.name||Object(o.a)("l_untitled"),t.id,t.attributes.state==r.a.STATE_DISCARD||t.attributes.state==r.a.STATE_DEL?Object(G.b)(ue||(ue=me`<span class= 'label label-danger xlabel xlabel-small'>Deleted</span>`)):Object(G.b)(pe||(pe=me`<span></span>`)),be.map(t.getTags(App.labels),e=>Object(G.b)(fe||(fe=me`<span class='label label-info xlabel xlabel-small'>${0}</span>`),e.get("name"))),null!=t.attributes.text?t.attributes.text||"<"+Object(o.a)("h_sieve_empty")+">":"<"+Object(o.a)("h_sieve_new")+">",t.attributes.schedule?t.attributes.schedule.getFrequencyClass():"error",t.attributes.schedule?t.attributes.schedule.getShortDisplayText():"err: unset","xtd xdata xaction xsieve-ts-data "+(t.attributes.err&&JSON.parse(t.attributes.err)?"xsieve-err":""),e==r.a.RUN_STATE_WAIT?"Waiting":e==r.a.RUN_STATE_WIP?"Checking":st(t.attributes.ts_data,!0)||"NA",App.clients.get(t.attributes.client_id)?App.clients.get(t.attributes.client_id).getIcon():" error fa-question","xtd btn btn-xs "+(t.attributes.state==r.a.STATE_READY?"btn-success":"btn-default")+(t.attributes.state==r.a.STATE_DISCARD?" disabled":""),t.attributes.state==r.a.STATE_READY?"ON ":"OFF"))(this.model),this.el),this.model.attributes._state&&0!=this.model.attributes._state?this.$el.addClass("xdirty").attr("title",Object(a.a)("m_sync_to_save")):this.$el.removeClass("xdirty").removeAttr("title"),this.$('[data-toggle="tooltip"]').tooltip({delay:{show:400}}),this.model.isRead()?this.$el.addClass("xfade").removeClass("xunread"):this.$el.addClass("xunread").removeClass("xfade")},setSelected:function(e){this.$("input[type=checkbox]:checked").length>0!==e&&(this.$("input[type=checkbox]").prop("checked",e),this.model.prop("select",e))},showDetail:function(e){if(this.detail==e)return;const t=this;this.listenTo(e,"remove",(function(){this.detail==e&&(delete this.detail,this.removeDetail())}),this),this.elDetail.children[0].appendChild(e.el),this.detail=e,this.$el.addClass("active"),this.$el.after(this.elDetail),e.listenTo(e,"remove",(function(){t.markRead()})),this.setSelected(!0)}});const Xe=c.a.ContextMenu.extend({name:"LogMenu",actions:{"log menu close":{fn:"hide"},"clear-error":{fn:"clear_error"}},clear_error:function(){this.collection.get(this.id).save("err",null,{error:function(){l.a.error("e_err")}})},onSync:function(){this.show()},postInit:function(e){this.collection=this.options.collection},renderMenu:function(){const e=this.collection.get(this.id),t=new p.a.Works(null,{parent:e});this.$el.empty().append(LI(BUTTON({class:"btn xbtn-light pull-right","data-action":"log menu close"},I({class:"fa fa-times"})),SPAN({style:"margin-left: 18px;"},I(Object(a.a)("l_changed_on")))),LI({class:"xview"},SPAN(st(e.get("ts_data"))),I(Object(a.a)("l_check_log")),SPAN(new qe({parent:this,collection:t}).render().el)),LI({class:e.get("err")?"xview":"hide"},A({"data-action":"clear-error"},Object(a.a)("a_clear_error")))),this.listenTo(t,"sync",this.onSync)}}),Ze=c.a.ContextMenu.extend({name:"ScheduleMenu",actions:{"schedule menu close":{fn:"hide"}},postInit:function(e){this.collection=this.options.collection},onScheduleChange:function(e){const t=this.collection.get(this.id);l.a.start("save","l_loading"),t.set("schedule",e,{silent:!0}),t.save(null,{patch:!0,silent:!0,data:{schedule:JSON.stringify(e)},error:function(){l.a.stop("save",{error:"e_req"})},success:function(){l.a.stop("save",{info:"m_saved_schedule"})}})},renderMenu:function(){const e=this.collection.get(this.id).clone();if(!e)return this.$el.text("Model not found:"+this.id),this;this.editedModel=e;const t=new ce({model:e,parent:this});this.$el.empty().append(LI(BUTTON({class:"btn xbtn-light pull-right","data-action":"schedule menu close"},I({class:"fa fa-times"})),SPAN({style:"margin-left: 18px;"},I(Object(a.a)("l_schedule")))),LI({class:"xview"},t.render().el)),this.off(),this.listenTo(e,"change:schedule",this.onScheduleChange),setTimeout(()=>t.focus(),10)}}),Ke=c.a.ContextMenu.extend({name:"SieveClientMenu",actions:{"menu client change":{fn:"action_client_change"},"menu client settings":{fn:"action_client_settings"}},action_client_change:function(e){const t=this,i=this.collection.get(this.id);l.a.start("save","l_loading"),i.save("client_id",e,{wait:!0,error:function(){l.a.stop("save",{error:"e_req"})},success:function(){l.a.stop("save"),t.hide()}})},action_client_settings:function(){new c.a.Modal({parent:this.getRoot(),title:"l_devices",view:new m.a.ClientManager({parent:this.getRoot(),collection:App.clients})}).show()},postInit:function(e){this.collection=this.options.collection},renderMenu:function(){const e=this.collection.get(this.id);if(!e)return this.$el.text("Model not found:"+this.id),this;this.$el.empty(),this.$el.append(LI({class:"xview"},SPAN(Object(a.a)("a_select_device"))),LI({class:"divider"})).append(App.clients.map((function(t){return LI(t.id==e.get("client_id")?A({style:"font-weight:bold;"},I({class:"fa fa-check"})," ",t.getInfo()):A({"data-action":"menu client change","data-action-param":t.id},I({class:t.getIcon()})," ",t.getInfo()))}))).append(LI({class:"divider"}),LI(A({"data-action":"menu client settings"},I({class:"fa fa-edit"})," ",Object(a.a)("a_edit"))))}}),et=c.a.ContextMenu.extend({name:"SieveContextMenu",actions:{"menu check changes":{fn:"action_check_for_changes"},"menu del":{fn:"action_del"},"menu del permanent":{fn:"action_del_permanent"},"menu duplicate":{fn:"action_duplicate"},"menu edit":{fn:"action_edit"},menu_create_tpl:{fn:"action_create_tpl"}},action_check_for_changes:function(){const e=this.collection.get(this.id),t=[this.id];e.get("client_id")!==r.a.CLIENT_WEB?n.a.service.checkNow(t):l.a.info("m_check_local_only"),this.hide(),n.a.service.active||l.a.error("m_checks_paused")},action_create_tpl:function(){App.nav("add-tpl/"+this.id),this.hide()},action_del:function(){const e=this,t=this.collection.get(this.id);l.a.start("discard","l_loading"),t.save("state",r.a.STATE_DISCARD,{patch:!0,error:function(){l.a.stop("discard",{error:"e_req"})},success:function(){t.collection.remove(t),l.a.stop("discard"),e.hide()}})},action_duplicate:function(){App.nav("edit-dup/"+this.id),this.hide()},action_del_permanent:function(){const e=this,t=this.collection.get(this.id);l.a.start("destroy","l_loading"),t.destroy({error:function(){l.a.stop("destroy",{error:"e_req"})},success:function(){l.a.stop("destroy"),e.hide()}})},action_edit:function(){App.edit(this.id),this.hide()},onActionAdd:function(e){e.id||(l.a.start("save","m_saving"),e.save(null,{error:function(){l.a.stop("save",{error:"e_req"})},success:function(){l.a.stop("save",{info:"m_saved_action"})}}))},onActionChange:function(e){if(e.id)l.a.start("save","m_saving"),e.save(null,{silent:!0,error:function(){l.a.stop("save",{error:"e_req"})},success:function(){l.a.stop("save",{info:"m_saved_action"})}});else{const t=e.changed;e.once("sync",(function(){e.set(t)}),this)}},onActionRemove:function(e){e.id&&(l.a.start("save","m_saving"),e.destroy({error:function(){l.a.stop("save",{error:"e_req"})},success:function(){l.a.stop("save",{info:"m_deleted_action"})}}))},postInit:function(e){this.collection=this.options.collection},renderMenu:function(){const e=this.collection.get(this.id),t=new p.a.SieveActions(null,{parent:e});if(!e)return this.$el.text("Model not found:"+this.id),this;t.fetch({data:{state:0}}),this.actionEditor=new U({actions:t,sieve:e,parent:this}),this.$el.empty(),v.a.agents.local&&this.$el.append(LI(A({"data-action":"menu check changes"},Object(a.a)("a_check_changes")))),this.$el.append(LI(A({"data-action":"menu edit"},Object(a.a)("a_edit_options"))),LI(A({"data-action":"menu duplicate"},Object(a.a)("a_duplicate"))),LI(A({"data-action":"menu_create_tpl"},Object(o.a)("a_action_object","a_create","l_tpl"))),LI({class:"divider"}),LI({class:"xview"},this.actionEditor.render().el),LI({class:"divider"}),LI(A({"data-action":"menu del"},Object(a.a)("a_move_to_trash"))),LI(A({"data-action":"menu del permanent"},Object(a.a)("a_del_permanent")))),this.listenTo(this.actionEditor.models,"add",this.onActionAdd),this.listenTo(this.actionEditor.models,"change",this.onActionChange),this.listenTo(this.actionEditor.models,"remove",this.onActionRemove)}}),tt=c.a.ContextMenu.extend({name:"SievesListMenu",renderMenu:function(){const e=this;this.$el.empty().append(LI({class:"xview"},DIV(LABEL(Object(a.a)("l_sort_by"),": "),this.selSort=SELECT({class:"pull-right"},OPTION({value:"-ts_data"},Object(a.a)("l_time_changed_on")),OPTION({value:"name"},Object(a.a)("l_name")),OPTION({value:"client_id"},Object(a.a)("l_device"))))),LI({class:"xview"},DIV(LABEL(Object(a.a)("l_page_size"),": "),this.selPageSize=SELECT({class:"pull-right"},OPTION({value:5},5),OPTION({value:20},20),OPTION({value:50},50),OPTION({value:100},100),OPTION({value:200},"200!!"),OPTION({value:500},"500!!!")))),LI({class:"xview"},DIV(LABEL(Object(a.a)("l_device_filter"),": "),this.selClientFilter=SELECT({class:"pull-right"},OPTION({value:1},Object(a.a)("l_devices_all")),OPTION({value:2},Object(a.a)("l_device_this")))))),this.selSort.value=App.store.get("ui.list.sortby")||"-ts_data",this.selPageSize.value=App.store.get("ui.list.pagesize")||"50",this.selClientFilter.value=App.store.get("ui.list.clientfilter")||"1",ve(this.selSort).change((function(){App.store.set("ui.list.sortby",e.selSort.value),e.parent.fetchAndShow()})),ve(this.selPageSize).change((function(){const t=parseInt(e.selPageSize.value);App.store.set("ui.list.pagesize",t),e.parent.fetchAndShow()})),ve(this.selClientFilter).change((function(){App.store.set("ui.list.clientfilter",e.selClientFilter.value),e.parent.fetchAndShow()}))}}),it=c.a.ContextMenu.extend({name:"SievesPageMenu",actions:{"menu topage":{fn:"action_topage"}},action_topage:function(e){this.parent.goTo(parseInt(e,10)),this.hide()},renderMenu:function(){const e=this.parent.collection.info(),t=e.perPage;this.$el.empty().append(be.map(be.range(1,e.totalPages+1),(function(i){return LI(A({"data-action":"menu topage","data-action-param":i},(i-1)*t+1+" - "+Math.min(i*t,e.totalRecords)))}))).css({maxHeight:600,overflowY:"auto",fontSize:".8em"})}});var nt=c.a.Entities.extend({name:"Sieves",actions:{action_be_action_add:{fn:"action_be_action_add"},action_be_action_remove:{fn:"action_be_action_remove"},action_be_config:{fn:"action_be_config"},action_be_device:{fn:"action_be_device"},action_be_schedule:{fn:"action_be_schedule"},action_be_switch_on:{fn:"action_be_switch_on"},action_be_switch_off:{fn:"action_be_switch_off"},action_global_actions:{fn:"action_global_actions"},action_global_rules:{fn:"action_global_rules"},"sieve c4c":{fn:"action_check_for_changes"},"sieve client menu":{fn:"action_client_menu"},"sieve context menu":{fn:"action_context_menu"},"sieve del":{fn:"action_del"},"sieve del permanent":{fn:"action_del_permanent"},"sieve label apply":{fn:"action_apply_label"},"sieve list menu":{fn:"action_list_menu"},"sieve log menu":{fn:"action_log_menu"},"sieve mark_read":{fn:"action_mark_read"},"sieve mark_unread":{fn:"action_mark_unread"},"sieve nav next":{fn:"action_next"},"sieve nav prev":{fn:"action_prev"},"sieve nav topage":{fn:"action_topage"},"sieve restore":{fn:"action_restore"},"sieve schedule menu":{fn:"action_schedule_menu"},"sieve select all":{fn:"action_select_all"},"sieve select none":{fn:"action_select_none"},"sieve select read":{fn:"action_select_read"},"sieve select unread":{fn:"action_select_unread"},"sieve switch":{fn:"action_switch_on_off"},"sieve sync":{fn:"action_sync"},"sieve view":{fn:"action_view",doc:"View sieve details"},toggle_slidebar:{fn:"action_toggle_slidebar"}},events:{"click .xselect-all":"event_check"},ViewClass:Ge,action_apply_label:function(e,t){const i=this.getSelectedModels();l.a.info("l_loading"),we.eachSeries(i,(function(t,i){let n=t.get("tags");if(n){if(n.indexOf(e)>=0)return i();n+=","+e}else n=e;t.save("tags",n,{patch:!0,error:function(){i("e_req")},success:function(){i()}})}),(function(e){e?l.a.error("e_req"):l.a.reset()}))},action_be_action_add:function(){const e=new ye.Model,t=new p.a.SieveActions(null,{parent:e}),i=new U({actions:t,sieve:e,parent:this}).render(),n=new c.a.SaveDiscardModal({name:"BatchEdit$ActionAddModal",parent:this,title:"Add Actions - Batch Editor",view:i});n.on("save",async()=>{const e=this.getSelectedIds(),t=i.getPosts();try{for(let i=0;i<t.length;i+=1){const n=t[i].toJSON();await h.a.api("/batch/sieves/actions","POST",{...n,ids:e})}n.remove()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}}),n.on("discard",(function(){n.remove()})),n.show(),setTimeout(()=>i.$(".dropdown-toggle").click(),10)},action_be_action_remove:function(){const e=new c.a.PromptModal({name:"BatchEdit$ActionRemoveModal",parent:this.getRoot(),title:"Remove Actions - Batch Edit",a_save:"Remove",msg:"This action will remove all actions for selected monitors. Remove all actions?"});e.on("save",async()=>{const t=this.getSelectedIds();try{await h.a.api("/batch/sieves/actions","PUT",{ids:t,state:100}),e.remove()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}}),e.show()},action_be_config:function(){const e=this.getSelectedModels(),t=new p.a.Sieve({content_type:r.a.TYPE_HTML,config:e[0].get("config").clone(),uri:e[0].get("uri")});$e(t,"Config - Batch Edit",async e=>{l.a.info("l_loading"),e.remove();const i=this.getSelectedIds(),n=t.toJSON().config;try{await h.a.api("/batch/sieves","PUT",{ids:i,config:n}),l.a.reset()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}})},action_be_device:function(){const e=this.getSelectedModels();if(0==e.length)return;const t=e[0],i=new p.a.Sieve({content_type:r.a.TYPE_HTML,client_id:t.get("client_id")}),n=new m.a.ClientSelector({model:i}),s=new c.a.Base({el:DIV({style:"margin: 5px;"},n.el)}),a=new c.a.SaveDiscardModal({name:"BatchEdit$Device",parent:this,title:"Device - Batch Editor",view:s});a.on("save",async()=>{try{const e=this.getSelectedIds(),t=i.get("client_id"),n=i.get("proxy_id"),s=i.get("session_id");await h.a.api("/batch/sieves","PUT",{ids:e,client_id:t,proxy_id:n,session_id:s}),a.remove()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}}),a.on("discard",(function(){a.remove()})),a.show()},action_be_schedule:function(){const e=new ye.Model({schedule:new p.a.Schedule}),t=new ce({model:e,parent:this}).render(),i=new c.a.SaveDiscardModal({name:"BatchEdit$ActionAddModal",parent:this,title:"Schedule - Batch Editor",view:t});i.on("save",async()=>{const t=this.getSelectedIds(),n=e.toJSON().schedule;try{await h.a.api("/batch/sieves","PUT",{ids:t,schedule:n}),i.remove()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}}),i.on("discard",(function(){i.remove()})),i.show()},action_be_switch_on:function(){const e=this.getSelectedIds(),t=new c.a.PromptModal({name:"BatchEdit$ActionRemoveModal",parent:this.getRoot(),title:"Switch On Monitors - Batch Edit",a_save:"Switch ON",msg:`${e.length} monitors will be switched ON.`});t.on("save",async()=>{try{await h.a.api("/batch/sieves","PUT",{ids:e,state:r.a.STATE_READY}),t.remove()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}}),t.show()},action_be_switch_off:function(){const e=this.getSelectedIds(),t=new c.a.PromptModal({name:"BatchEdit$ActionRemoveModal",parent:this.getRoot(),title:"Switch Off Monitors - Batch Edit",a_save:"Switch OFF",msg:`${e.length} monitors will be switched OFF.`});t.on("save",async()=>{try{await h.a.api("/batch/sieves","PUT",{ids:e,state:r.a.STATE_PAUSED}),t.remove()}catch(e){console.error(e),l.a.error(`Please try again later - error in batch action ${e.message||e.msg}`)}}),t.show()},action_global_actions:function(){F()},action_global_rules:function(){W()},action_check_for_changes:function(e){if(!v.a.agents.local)return;const t=this.getSelectedModels(),i=be.pluck(be.filter(t,(function(e){return e.get("client_id")!==r.a.CLIENT_WEB})),"id");n.a.service.checkNow(i),t.length>i.length&&l.a.info("m_check_local_only"),n.a.service.active||l.a.error("m_checks_paused")},action_client_menu:function(e,t){this.clientMenu||(this.clientMenu=new Ke({parent:this,collection:this.collection})),this.clientMenu.toggle(e,"I"==t.nodeName?t.parentNode:t)},action_context_menu:function(e,t){this.contextMenu||(this.contextMenu=new et({parent:this,collection:this.collection})),this.contextMenu.toggle(e,"I"==t.nodeName?t.parentNode:t)},action_del:function(){const e=this,t=this.getSelectedModels();return we.map(t,(function(e,t){e.save("state",r.a.STATE_DISCARD,{patch:!0,error:function(){t(new Error("sieve:del:err"))},success:function(){e.collection.remove(e),t()}})}),(function(i){if(i)l.a.error("sieve:del:err");else{const i=t.length,n=s.a.translate("m_del_item").ifPlural(i,Object(a.a)("m_del_items")).fetch(i);l.a.info(n),e.route()}})),!0},action_del_permanent:function(){const e=this,t=this.getSelectedModels();we.eachLimit(t,5,(function(e,t){e.destroy({error:function(){t(new Error("sieve:del:err"))},success:function(){t()}})}),(function(t){t?l.a.error("sieve:del:err"):(l.a.info("Permanently deleted selected items."),e.route())}))},action_list_menu:function(e,t){this.listMenu||(this.listMenu=new tt({parent:this})),this.listMenu.toggle("list",ve(t).parent(".btn-group")[0])},action_log_menu:function(e,t){this.logMenu||(this.logMenu=new Xe({parent:this,collection:this.collection})),this.logMenu.toggle(e,t||this.getRow(e).$el.find(".xsieve-ts-data")[0])},action_mark_read:function(){const e=this.getSelectedModels();we.map(e,(function(e,t){e.save({ts_view:at(Date.now())},{patch:!0,error:function(){t(new Error("sieve:update:err"))},success:function(){t()}})}),(function(e){e&&l.a.error("sieve:update:err")}))},action_mark_unread:async function(){const e=this.getSelectedModels();for(let t=0;t<e.length;t+=1){let i=e[t],n=at(0);await h.a.api(`/sieves/${i.id}`,"PATCH",{ts_view:n}),i.set({ts_view:n})}},action_next:function(){l.a.info("l_loading"),this.collection.nextPage({sort:!1,data:be.extend({_opt:{order:[this.getSortField()]}},this.getQuery()),success:function(e,t,i){be.each(i.previousModels,(function(e){e.trigger("remove")})),l.a.reset()}})},action_prev:function(){l.a.info("l_loading"),this.collection.prevPage({sort:!1,data:be.extend({_opt:{order:[this.getSortField()]}},this.getQuery()),success:function(e,t,i){be.each(i.previousModels,(function(e){e.trigger("remove")})),l.a.reset()}})},action_topage:function(e,t){this.pageMenu||(this.pageMenu=new it({parent:this})),this.pageMenu.toggle("list",t)},action_restore:async function(){const e=this,t=this.getSelectedModels();let i={};try{i=await Object(O.a)(t.length)}catch(e){console.error(e),i={isOverLimit:!1}}i.isOverLimit?l.a.error("m_monitor_limit"):we.map(t,(function(e,t){e.save("state",r.a.STATE_READY,{patch:!0,error:function(){t(new Error("sieve:restore:err"))},success:function(){e.collection.remove(e),t()}})}),(function(t){t?l.a.error("sieve:restore:err"):(l.a.info("m_restored_from_trash"),e.route())}))},action_schedule_menu:function(e,t){this.scheduleMenu||(this.scheduleMenu=new Ze({parent:this,collection:this.collection})),this.scheduleMenu.toggle(e,t)},action_select_all:function(){this._select(be.identity,!0)},action_select_none:function(){this._select(be.identity,!1)},action_select_read:function(){this.action_select_none(),this._select((function(e){return e.model.isRead()}),!0)},action_select_unread:function(){this.action_select_none(),this._select((function(e){return!e.model.isRead()}),!0)},action_switch_on_off:function(e){const t=this.collection.get(e),i=t.get("state")==r.a.STATE_READY?r.a.STATE_PAUSED:r.a.STATE_READY;l.a.start("sieve:save",{info:"l_saving"}),t.save(null,{data:{state:i},patch:!0,err:function(e,t){l.a.stop("sieve:save",{error:"e_req"})},success:function(){l.a.stop("sieve:save"),t.set("state",i)}})},action_sync:function(){if(!v.a.agents.local)return;l.a.info("l_syncing");let e=!1;n.a.service.SyncMan.sync(!0,(function(t){e=!0,t?n.a.service.initSync((function(e){e&&l.a.error(t.msg||t.message||JSON.stringify(t))})):l.a.reset()})),setTimeout((function(){e||l.a.info("l_syncing_wait")}),5e3)},action_toggle_slidebar:function(){App.toggleSlidebar()},action_view:function(e){this.modelView&&this.modelView.model.id==e?this.route():this.route(e)},event_check:function(e){this._select(be.identity,e.target.checked)},_select:function(e,t){be.each(this.views,(function(i){e(i)&&i.setSelected(t)}))},addOne:function(e,t){if(!this.$list)return;const i=new ze({model:e,parent:this}),n=this.collection.indexOf(e);return this.$list[!0===t||0==n?"prepend":"append"](i.render().el),i},close_edit:function(){this.optsPanel.remove(),this.opts=null},recentFetchAndShow:function(e){const t=this.collection.length>0?this.collection.max(e=>new Date(e.get("ts_mod")).valueOf()).get("ts_mod"):new Date(0).toISOString(),i=new p.a.Sieves;l.a.start("fetch",{info:"l_loading"}),i.fetch({data:be.extend({"ts_mod.gt":t,_opt:{}},this.getQuery()),success:()=>{l.a.stop("fetch"),this.collection.add(i.models,{merge:!0,at:0})}})},fetchAndShow:function(e){const t=this,i=App.store.get("ui.list.pagesize");l.a.start("fetch",{info:"l_loading"}),this.tbar.setAttribute("context",this.routePrefix+(v.a.agents.local?" local":"cloud")),this.collection.perPage!=i&&(this.collection.currentPage=0,this.collection.perPage=i),this.collection.fetch({sort:!1,data:be.extend({_opt:{order:[this.getSortField()]}},this.getQuery()),error:function(e){l.a.stop("fetch",e&&{error:"err:fetch"})},success:function(){l.a.stop("fetch"),e?t.show(e):(t.removeModelView(),t.el.scrollIntoView()),t.onSelectionChange(),0==t.collection.length?t.renderEmpty():t.removeEmpty()}})},getQuery:function(){const e=App.store.get("ui.list.clientfilter");let t=this._query;return 2==e&&(t=be.extend({client_id:this.clients.defaultId},t)),t},getRow:function(e){return be.find(this.views,(function(t){return t.model.id==e}))},getSelectedIds:function(){return be.chain(this.children).select((function(e){return e.isSelected&&e.isSelected()})).map((function(e){return e.model.id})).value()},getSelectedModels:function(){const e=this;return be.chain(this.children).select((function(e){return e.isSelected&&e.isSelected()})).map((function(t){return e.collection.get(t.model.id)})).value()},getSortField:function(){const e=App.store.get("ui.list.sortby")||"-ts_data";return this.collection.sortField=e,"name"==e&&v.a.agents.local?"name nocase":e},goTo:function(e){l.a.info("l_loading"),this.collection.goTo(e?e-1:0,{sort:!1,data:be.extend({_opt:{order:[this.getSortField()]}},this.getQuery()),success:function(e,t,i){be.each(i.previousModels,(function(e){e.trigger("remove")})),l.a.reset()}})},labelAddOne:function(e){this.$labelList.append(LI(A({href:"#","data-action":"sieve label apply","data-action-param":e.id},e.get("name"))))},labelRemoveOne:function(e){},labelReset:function(){this.$labelList.empty(),this.labels.each(this.labelAddOne)},onChangeUnreadError:function(e){const t=this.errorUnreadModel.get("error"),i=this.errorUnreadModel.get("unread");this.errorUnreadModel.set(e);const n=e.error,s=e.unread;t<n&&"filter/error"==this.routePrefix&&0==this.collection.currentPage&&this.recentFetchAndShow(),i<s&&"filter/unread"==this.routePrefix&&0==this.collection.currentPage&&this.recentFetchAndShow()},onClientsUpdate:function(e){"I"==e.op&&(this.clients.get(e.id)||this.clients.fetch())},onSelectionChange:function(){this.getSelectedModels().length>0?ve(this.tbar).addClass("xselected"):ve(this.tbar).removeClass("xselected")},onSieveInsert:be.debounce((function(){this.fetchAndShow()}),15e3,!0),onSieveUpdate:function(e){"I"==e.op&&(this.collection.get(e.id)||this.onSieveInsert())},onSort:function(){const e=this.collection.pluck("id"),t=be.keys(this.views);be.isEqual(e,t)||this.collection.each((function(e){this.views[e.id].reattach()}),this)},postInit:function(e){this.listenTo(this.collection,"sort",this.onSort),this.listenTo(this.collection,"sync",this.updatePageInfo),this.listenTo(this.collection,"prop:select",this.onSelectionChange),this.clients=e.clients,this.labels=e.labels,this.labels.on("add",this.labelAddOne),this.labels.on("remove",this.labelRemoveOne),this.labels.on("reset",this.labelReset),this.listenTo(j.a,"sieves",this.onSieveUpdate),this.listenTo(j.a,"clients",this.onClientsUpdate),this.errorUnreadModel=new ye.Model,this.listenTo(j.a,"user_states",this.onChangeUnreadError)},removeOne:function(e){c.a.Entities.prototype.removeOne.call(this,e),this.model&&this.model.id==e.id&&this.removeModelView(),e.trigger("remove")},renderBase:function(){const e=UL({class:"dropdown-menu",style:"overflow-y:auto;max-height:"+(ve(window).height()-120)+"px"});let t,i;this.$el.append(this.tbar=DIV({class:"xtbar xvbar-margin xtbar-padded xalt"+(v.a.agents.local?" xlocal":"")},DIV({class:"btn-group"},INPUT({class:"xselect-all",type:"checkbox",style:"margin: 0 6px 0 0;"}),BUTTON({type:"button",class:"dropdown-toggle xbtn-light","data-toggle":"dropdown"},SPAN({class:"caret"}),SPAN({class:"sr-only"},"Dropdown Toggle")),UL({class:"dropdown-menu",role:"menu"},LI(A({href:"#","data-action":"sieve select all"},Object(a.a)("l_all"))),LI(A({href:"#","data-action":"sieve select none"},Object(a.a)("l_none"))),LI(A({href:"#","data-action":"sieve select read"},Object(a.a)("l_read"))),LI(A({href:"#","data-action":"sieve select unread"},Object(a.a)("l_unread"))))),BUTTON({"data-action":"sieve c4c",class:"btn btn-default",context:"selected local notrash nocloud",title:Object(a.a)("a_check_changes")},I({class:"im-run"})),BUTTON({"data-action":"sieve restore",class:"btn btn-default",context:"trash"},Object(a.a)("a_restore")),USER.account_id?DIV({class:"btn-group",context:"selected all notrash"},A({"data-action":"sieve mark_read",class:"btn btn-default",context:"selected all notrash",title:Object(a.a)("a_mark_read")},I({class:"fa fa-check"})),BUTTON({class:"btn btn-default dropdown-toggle","data-toggle":"dropdown",style:"min-width: 20px"},I({class:"caret"})),UL({class:"dropdown-menu",role:"menu"},LI(A({tabindex:-1,href:"#","data-action":"sieve mark_unread"},Object(a.a)("Mark as unread"))))):BUTTON({"data-action":"sieve mark_read",class:"btn btn-default",context:"selected all notrash",title:Object(a.a)("a_mark_read")},I({class:"fa fa-check"})),BUTTON({"data-action":"sieve del",class:"btn btn-default",context:"selected all notrash",title:Object(a.a)("a_move_to_trash")},I({class:"im-trash"})),BUTTON({"data-action":"sieve del permanent",class:"btn btn-default",context:"trash"},Object(a.a)("a_del_permanent")),DIV({class:"btn-group",context:"selected all notrash",title:Object(a.a)("l_label")},BUTTON({class:"btn btn-default dropdown-toggle","data-toggle":"dropdown"},I({class:"fa fa-tags"})," ",SPAN({class:"caret"})),e),BUTTON({class:"btn btn-default",context:"all nocloud","data-action":"sieve sync",title:Object(a.a)("l_sync")},I({class:"fa fa-refresh"})),DIV({class:"btn-group",context:"all"},BUTTON({class:"btn btn-default dropdown-toggle","data-toggle":"dropdown"},I({class:"fa fa-bars"})," ",SPAN({class:"caret"})),UL({class:"dropdown-menu",role:"menu"},LI({class:"dropdown-submenu"},A({href:"#"},Object(a.a)("a_export")),UL({class:"dropdown-menu",role:"menu"},LI(A({href:"#export_json"},"JSON")),LI(A({href:"#export_csv"},"CSV")))),LI({class:"dropdown-submenu"},A({href:"#"},Object(a.a)("a_import")),UL({class:"dropdown-menu",role:"menu"},LI(A({href:"#import_csv"},"CSV")),LI(A({href:"#import_json"},"JSON")))),LI(A({href:"#profiles/",class:v.a.agents.local&&"hide"},Object(a.a)("Profiles"))),LI(A({href:"#proxies/",class:v.a.agents.local&&"hide"},Object(a.a)("Proxies"))),LI(A({href:"#tpls"},Object(a.a)("l_sieve_tpl_list"))),USER.account_id?LI(A({href:"#sieve-sources"},Object(a.a)("Websites"))):"","")),DIV({class:"btn-group",context:"selected all"},BUTTON({class:"btn btn-default dropdown-toggle","data-toggle":"dropdown"},`${Object(a.a)("a_bulk_edit")} `,SPAN({class:"caret"})),USER.id?UL({class:"dropdown-menu",role:"menu"},LI({class:"dropdown-submenu"},A({href:"#"},"Actions"),UL({class:"dropdown-menu",role:"menu"},LI(A({href:"#","data-action":"action_be_action_add"},"Add")),LI({class:"divider"}),LI(A({href:"#","data-action":"action_be_action_remove",style:"color: red"},"Remove All")))),LI(A({href:"#","data-action":"action_be_config"},Object(a.a)("Config"))),LI(A({href:"#","data-action":"action_be_device"},Object(a.a)("l_device"))),LI(A({href:"#","data-action":"action_be_schedule"},Object(a.a)("l_schedule"))),LI(A({href:"#","data-action":"action_be_switch_on"},Object(a.a)("Switch ON"))),LI(A({href:"#","data-action":"action_be_switch_off"},Object(a.a)("Switch OFF"))),LI({class:"divider"}),LI(A({href:"#","data-action":"action_global_actions"},Object(a.a)("Global Actions"))),LI(A({href:"#","data-action":"action_global_rules"},Object(a.a)("Global Conditions"))),""):UL({class:"dropdown-menu",role:"menu"},LI(A({href:"/ui/settings.html#general"},Object(a.a)("Sign in"))))),BUTTON({class:"btn btn-default right xoptional",style:"margin-right: 0;min-width: 40px;","data-action":"toggle_slidebar"},I({class:"fa fa-caret-square-o-left"})),DIV({class:"btn-group right xoptional"},BUTTON({class:"btn btn-default","data-action":"sieve list menu"},I({class:"fa fa-cog"})," ",SPAN({class:"caret"}))),UL({class:"pagination pagination-sm right",style:"margin: 0 5px 0 0"},LI(A({href:"#","data-action":"sieve nav topage"},this.pageInfo=SPAN(Object(a.a)("l_loading"))," ",I({class:"fa fa-caret-down"}))),this.pagePrev=LI(A({href:"#","data-action":"sieve nav prev"},I({class:"fa fa-chevron-left"}))),this.pageNext=LI(A({href:"#","data-action":"sieve nav next"},I({class:"fa fa-chevron-right"}))))),TABLE({class:"xlist",cellpadding:0,style:"box-shadow: 3px 3px 3px #ccc"},COLGROUP(COL({style:"width:28px"}),COL({style:"width:28px"}),COL({style:"width:304px; padding: 0 10px;"}),COL({style:""}),COL({style:"width:72px; padding: 0 10px;"}),COL({style:"width:72px"}),COL({style:"width:42px"}),COL({style:"width:40px"})),t=TBODY()),i=DIV()),this.$empty=ve(i),this.$list=ve(t),this.$labelList=ve(e),this.labelReset()},removeEmpty:function(){this.$empty.empty()},renderEmpty:function(){App.sieves.reset();const e="inbox"==this.routePrefix;this.$empty.empty().append(e&&!v.a.agents.local?DIV(H3("Cloud Watchlist"),P("This is your Watchlist in cloud at distill.io accessible from any device. ","It is currently empty. To start monitoring web, get started by adding a few monitors. ","In case you have installed Distill's browser extensions and are looking for the browser extension's Watchlist, ","use Distill's button in the browser toolbar to access it. "),P(A({href:"https://distill.io/help/watchlist"},"Learn More"))):H4("No monitor found."))},renderModelView:function(e,t){const i=this.getRow(e.id);i&&i.showDetail(t.render())},setRoutePrefix:function(e){this.routePrefix=e,this.collection.currentPage=0},show404:function(){return l.a.error("err_sieve_na"),!1},showDefault:function(){this.removeModelView()},showErred:function(e){v.a.agents.local&&n.a.ErrorActions.clearErrorUnreadList(),this._query={"state.in":[r.a.STATE_INIT,r.a.STATE_READY,r.a.STATE_PAUSED],"err.ne":"$null"},this.modelId=e,"filter/error"!=this.routePrefix?(this.setRoutePrefix("filter/error"),this.fetchAndShow(e)):e?this.show(e):this.showDefault()},showInbox:function(e){this._query={"state.in":[r.a.STATE_INIT,r.a.STATE_READY,r.a.STATE_PAUSED]},this.modelId=e,"inbox"!=this.routePrefix?(this.setRoutePrefix("inbox"),this.fetchAndShow(e)):e?this.show(e):this.showDefault()},showLabel:function(e,t){const i="label/"+encodeURIComponent(e.get("name"));this._query={"state.in":[r.a.STATE_INIT,r.a.STATE_READY,r.a.STATE_PAUSED]},this._query["tags.like"]="%"+e.id+"%",this.modelId=t,this.routePrefix!=i?(this.setRoutePrefix(i),this.fetchAndShow(t)):t?this.show(t):this.showDefault()},showModelView:function(e){return this.getRow(e.id).markRead(),nt.__super__.showModelView.call(this,e)},showSearch:function(e,t){const i="search/"+encodeURIComponent(e),n=this;R(e,(function(e,s){n._query=n.buildQuery(s),be.isEmpty(n._query)?(n.setRoutePrefix(i),n.renderEmpty()):n.routePrefix!=i?(n.setRoutePrefix(i),n.fetchAndShow(t)):t?n.show(t):n.showDefault()}))},showSearchWithOperators:function(e,t){const i="search/"+encodeURIComponent(e),n=this;n._query=this.assignValues(e),be.isEmpty(n._query)?(n.setRoutePrefix(i),n.renderEmpty()):n.routePrefix!=i?(n.setRoutePrefix(i),n.fetchAndShow(t)):t?n.show(t):n.showDefault()},assignValues:function(e){var t=this;let i={};const n=e.split(" OR ");if(n.length>1){let e=!1;for(let t=0;t<n.length;t++){let s=n[t].trim(),a=s.split(" AND "),o=s.split(" ");if(a.length>1){let t=[];for(let e=0;e<a.length;e++){let i=a[e].split(" ");t=[...t,...i]}if((a=t.length>0?this.handleLabelsWithSpace(t):this.handleLabelsWithSpace(a)).length>1){let t=this.groupANDoperations(a),n=t.response||[];i={...i,$or:[...i.$or||[],[...n]]},t.stateInFound&&(e=!0)}else if(1==a.length){let t=this.getQueryParams(a[0])||[];i={...i,$or:[...i.$or||[],[...t]]},be.contains(t,"state.in")&&(e=!0)}}else if(o.length>1){if((o=this.handleLabelsWithSpace(o)).length>1){let t=this.groupANDoperations(o),n=t.response||[];i={...i,$or:[...i.$or||[],[...n]]},t.stateInFound&&(e=!0)}else if(1==o.length){let t=this.getQueryParams(o[0])||[];i={...i,$or:[...i.$or||[],[...t]]},be.contains(t,"state.in")&&(e=!0)}}else{let t=this.getQueryParams(s)||[];i={...i,$or:[...i.$or||[],[...t]]},be.contains(t,"state.in")&&(e=!0)}}e||(i["state.in"]=[r.a.STATE_INIT,r.a.STATE_READY,r.a.STATE_PAUSED])}else N(e,["and","or"],(function(e,n){i=t.buildQuery(n)}));return i},groupANDoperations:function(e){let t={},i=!1;for(let n=0;n<e.length;n++){let s=e[n].trim(),a=this.getQueryParams(s)||[];t={...t,$and:[...t.$and||[],[...a]]},be.contains(a,"state.in")&&(i=!0)}return{response:["$and",t.$and],stateInFound:i}},handleLabelsWithSpace:function(e){const t=new RegExp(/(\"|\').*/),i=new RegExp(/.*(\"|\')$/);let n="",s="",a=!1,o=[];for(let l=0;l<e.length;l++){let c=e[l];if(a){for(let t=l;t<e.length;t++)if(n=(n||"")+" "+(c=e[t]),c.match(i)){a=!1,l=t,n=n.replace('"',"");break}let t=s+":"+n;o.push(t),n="",s=""}else if(c.indexOf(":")>-1){s=c.split(":")[0];var r=c.split(":")[1].trim();if(r)if(r.match(t)&&r.match(i)){let e=s+":"+(n=(n||"")+r.match(t)[0].replace(/(\"|\')/gm,""));o.push(e),n="",s=""}else if(r.match(t))n=(n||"")+r.match(t)[0].replace(/(\"|\')/gm,""),a=!0;else{let e=s+":"+(n=(n||"")+r);o.push(e),n="",s=""}}else a&&(n=(n||"")+" "+r)}return o},getQueryParams(e){let t=[];const i=e.split(":");if(i.length>1){let e=i[0],s=i[1];switch(e){case"label":var n=App.labels.where({name:s});if(!(n&&n.length>0))return void(t=[]);be.forEach(n,(function(e){t.push("tags.ilike"),t.push("%"+e.id+"%")}));break;case"is":if(s.match(/on/i)&&!t["state.in"]){t.push("state.in"),t.push([r.a.STATE_READY]);break}if(s.match(/on/i)&&t["state.in"].indexOf(r.a.STATE_READY)>=0)break;if(s.match(/off/i)&&!t["state.in"]){t.push("state.in"),t.push([r.a.STATE_PAUSED,r.a.STATE_INIT]);break}if(s.match(/off/i)&&t["state.in"].indexOf(r.a.STATE_PAUSED)>=0)break;if(s.match(/unread/i)){t.push("ts_view.lt"),t.push({name:"ts_data",type:"field"});break}if(s.match(/read/i)){t.push("ts_view.gt"),t.push({name:"ts_data",type:"field"});break}return void(t={});case"has":if(s.match(/error/i)){t.push("err.ne"),t.push("$null");break}return void(t={});case"keyword":t.push("$or"),t.push({"uri.ilike":"%"+s+"%","name.ilike":"%"+s+"%"});break;case"in":if(s.match(/trash/i)&&!t["state.in"])t.push("state.in"),t.push([r.a.STATE_DISCARD]);else if(!s.match(/trash/i)||!t["state.in"])return void(t={});break;default:t.push("state.ne"),t.push(r.a.STATE_DEL),t.push("$or"),t.push({"uri.ilike":"%"+e+":"+s+"%","name.ilike":"%"+e+":"+s+"%"})}}return t},buildQuery:function(e){let t={};for(let n=0;n<e.length;n++){const s=e[n].name.toLowerCase();if(!e[n].val)continue;const a=e[n].val.trim();switch(s){case"label":var i=App.labels.where({name:a});if(!(i&&i.length>0))return void(t={});t["tags.ilike"]=t["tags.ilike"]||[],be.forEach(i,(function(e){t["tags.ilike"].push(e.id)}));break;case"is":if(a.match(/on/i)&&!t["state.in"]){t["state.in"]=[r.a.STATE_READY];break}if(a.match(/on/i)&&t["state.in"].indexOf(r.a.STATE_READY)>=0)break;if(a.match(/off/i)&&!t["state.in"]){t["state.in"]=[r.a.STATE_PAUSED,r.a.STATE_INIT];break}if(a.match(/off/i)&&t["state.in"].indexOf(r.a.STATE_PAUSED)>=0)break;if(a.match(/unread/i)){t["ts_view.lt"]={name:"ts_data",type:"field"};break}if(a.match(/read/i)){t["ts_view.gt"]={name:"ts_data",type:"field"};break}return void(t={});case"keyword":t.$or={"uri.ilike":"%"+a+"%","name.ilike":"%"+a+"%"};break;case"has":if(a.match(/error/i)){t["err.ne"]="$null";break}return void(t={});case"in":if(a.match(/trash/i)&&!t["state.in"])t["state.in"]=[r.a.STATE_DISCARD];else if(!a.match(/trash/i)||!t["state.in"])return void(t={});break;default:t["state.ne"]=r.a.STATE_DEL,t.$or={"uri.ilike":"%"+s+":"+a+"%","name.ilike":"%"+s+":"+a+"%"}}}return t["tags.ilike"]&&t["tags.ilike"].length>0&&(1==t["tags.ilike"].length?t["tags.ilike"]="%"+t["tags.ilike"].join("%")+"%":(t.$andTAGS=be.map(t["tags.ilike"],(function(e){return["tags.ilike","%"+e+"%"]})),delete t["tags.ilike"])),be.isEmpty(t)||t["state.in"]||(t["state.in"]=[r.a.STATE_INIT,r.a.STATE_READY,r.a.STATE_PAUSED]),t},showTrash:function(e){this._query={state:r.a.STATE_DISCARD},this.modelId=e,"trash"!=this.routePrefix?(this.setRoutePrefix("trash"),this.fetchAndShow(e)):e?this.show(e):this.showDefault()},showUnread:function(e){this._query={"state.in":[r.a.STATE_INIT,r.a.STATE_READY,r.a.STATE_PAUSED],"ts_view.lt":{name:"ts_data",type:"field"}},this.modelId=e,"filter/unread"!=this.routePrefix?(this.setRoutePrefix("filter/unread"),this.fetchAndShow(e)):e?this.show(e):this.showDefault()},updatePageInfo:function(){const e=this.collection,{currentPage:t,totalPages:i}=e.info(),{length:n,offset:s,totalRecords:a}=e;this.pageInfo.textContent=Object(o.a)("m_start_end_of_total",s+(n>0?1:0),s+n,a),ve(this.pagePrev)[t<=0?"addClass":"removeClass"]("disabled"),ve(this.pageNext)[t+1>=i?"addClass":"removeClass"]("disabled")}});t.a={SieveActionsEditor:U,SieveDataList:We,Sieves:nt,SieveOptions:Pe,SieveScheduleEditor:ce,TagsEditor:de};function st(e,t){if(!e)return"";const i=_e(e),n=_e(),s=n.diff(i)/1e3|0;return s<60?i.format("h:mm a"):s<86400&&n.date()==i.date()?i.format("h:mm a"):s<31536e3?t?i.format("MMM DD"):i.format("MMM DD h:mm a"):t?i.format("YYYY/MM"):i.format("h:mm a, MMM DD, YYYY")}function at(e){return _e(e).format()}function ot(e,t,i,n){const s=[e||"<html></html>",t||"<html></html>",i];if("undefined"!=typeof Worker){Date.now();const e=v.a.agents.local?"/ui":window.URL_STATIC+"/scripts";Ie||(Ie=new Worker(e+"/lib/diff_html.js")).addEventListener("message",(function(e){const t=e.data,i=t[0],n=t[1],s=De[i];if(!s||0==s.length)throw new Error("No callback found for resCtx:"+i);try{for(let e=0;e<s.length;e+=1)s[e](null,n)}catch(e){console.error("Error calling diff callbacks",e)}delete De[i]}));const t=De[i]||[];t.push(n),De[i]=t,Ie.postMessage(s)}else document.getElementById("result").innerHTML="Sorry, your browser does not support Web Workers..."}function rt(e,t,i){const n=e.createElement("base"),s=i.match(/<base\s*href=\"(.*?)\"/);let a;if(s)a=s[1];else{a=t;const e=i.indexOf("</head>");i=i.slice(0,e)+'<base href="'+a+'">'+i.slice(e)}n.setAttribute("href",a),ve(e.head||e.documentElement).prepend(n),window.IE&&(i=i.match(/^<html.*?>([\s\S]*)<\/html>$/)[1]),e.documentElement.innerHTML=i,ve(e.head||e.documentElement).prepend(n),ve(e.documentElement).find("a[href]").attr("target","_blank").attr("rel","noopener")}function lt(e,t,i){be.each(e,(function(e){e.style[t]=i}))}},47:function(e,t,i){"use strict";i.r(t);var n=i(14),s=i(51),a=i(0),o=i(16),r=i(3),l=r.a.store.SimpleStore;var c=function(e){e||(e="_s"),this.__init__=function(e){e&&e()},this.del=function(t){t=e+t,document.cookie=escape(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"},this.get=function(t){t=e+t;const i=unescape(document.cookie.replace(new RegExp("(?:(?:^|.*;\\s*)"+escape(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*)|.*"),"$1"));return i?JSON.parse(i):void 0},this.set=function(t,i){t=e+t,document.cookie=escape(t)+"="+escape(JSON.stringify(i))+"; expires=Fri, 31 Dec 9999 23:59:59 GMT"}},d=l.storage?l:c,h=i(2),u=i(4),p=i(5),f=i(15),m=i(13);i(12);if(!window.Backbone)throw new Error("ADD Backbone");const g=m.a.Model.extend({});var v={Label:g,Labels:m.a.Collection.extend({model:g,url:"/tags",findByName:function(e){return this.find((function(t){return t.get("name")===e}))},getOrCreateLabels:async function(e){_.isString(e)&&(e=e.split(",").map(e=>e.trim()));const t=App.labels.filter(t=>e.includes(t.get("name"))).map(e=>e.toJSON()),i=App.labels.pluck("name"),n=_.difference(e,i);for(let e=0;e<n.length;e+=1){const i=n[e],s=await p.a.api("/tags","POST",{name:i});t.push(s)}return t}})},b=i(8),w=i(1),y=i(11);if(!window.Backbone)throw new Error("ADD Backbone");const x=m.a.Model,S=m.a.Collection,D=x.extend({defaults:{name:"",type:"text"}});var O=x.extend({encodedFields:["params","sieve_config","sieve_rule"],urlRoot:"/tpls/sieves",defaults:function(){return{desc_name:"Search Result",desc_uri:"https://www.domain.tld",desc_info:"Selection contains search result containing url and snippet. Does not contain ads.",sieve_type:w.a.TYPE_HTML,sieve_uri:null,sieve_config:{selections:[{frames:[{index:0,excludes:[],includes:[{type:"css",expr:"body"}]}],dynamic:!0}],includeStyle:!1,dataAttr:"text"},params:new S([])}},parse:function(e){return(e=O.__super__.parse.call(this,e)).params=new S(e.params),e}});const E=m.a.PagedCollection.extend({model:O,paginator_ui:{currentPage:0,perPage:50},url:"/tpls/sieves"});var T=x.extend({encodedFields:["pattern_params"],defaults:function(){return{pattern:null,uri_ref:null,pattern_params:new S}},parse:function(e){return(e=T.__super__.parse.call(this,e)).pattern_params=new S(e.pattern_params),e}});const k=S.extend({model:T,url:function(){return["/tpls/sieves",this.tpl.id,"patterns"].join("/")}});var $={Pattern:T,Patterns:k,InputParam:D,Tpl:O,Tpls:E};if(!window.domo)throw new Error("ADD domo");var L=DIV({class:"footer container-fluid"},HR(),DIV({class:"row"},DIV({class:"col-md-4"},H5(Object(a.a)("l_explore")),UL({class:"list-unstyled"},LI(A({href:URL_ROOT+"/help/gettingstarted/webapp"},Object(a.a)("l_get_started"))),LI(A({href:URL_ROOT+"/apps/web-monitor"},Object(a.a)("l_apps"))),LI(A({href:URL_ROOT+"/pricing"},Object(a.a)("l_pricing"))),LI(A({href:URL_ROOT+"/stats/availability"},Object(a.a)("l_usage_stats"))))),DIV({class:"col-md-4"},H5(Object(a.a)("l_help")),UL({class:"list-unstyled"},LI(A({href:URL_ROOT+"/help/start"},Object(a.a)("l_help_support"))))),DIV({class:"col-md-4"},H5(Object(a.a)("l_connect")),UL({class:"list-unstyled"},LI(A({href:"https://twitter.com/distill_io"},"Twitter")),LI(A({href:"https://facebook.com/distillweb"},"Facebook")),LI(A({href:"https://plus.google.com/114751872755487243849/"},"Google+"))))),DIV({class:"row",style:"margin-top:100px;font-size:small;"},"© 2013-present Neemb LLC ",A({href:URL_ROOT+"/tos",target:"_blank"},Object(a.a)("l_tos")))),j=(i(10),i(6));const R=window.jQuery;if(!R)throw new Error("ADD jQuery");const N=window._;if(!N)throw new Error("ADD _");if(!window.async)throw new Error("ADD async");if(!window.domo)throw new Error("ADD domo");if(!window.moment)throw new Error("ADD moment");if(!window.Backbone)throw new Error("ADD Backbone");function C(e,t){if(!e||0==e.length)return'""';const i=e.indexOf('"')>=0,n=e.indexOf("\t")>=0,s=e.indexOf("\n")>=0;return i&&(e=e.replace(/"/g,'""')),(i||n||s||t)&&(e='"'+e+'"'),e}const M=u.a.Base.extend({offset:0,fields:["name","uri","config","tags","content_type","state","rule_id","schedule","ts"],load:async function(){const e=this.options.sieveList._query||{"state.in":[40,45]};this.out.value=Object(a.a)("l_loading");let t=await p.a.api("/sieves","GET",N.extend({_opt:{order:["ts"],limit:5,offset:this.offset,only:this.fields}},e));this.list=this.list.concat(t.data),this.offset+=t.count,5==t.count?this.load():this.onLoadListDone()},onLoadListDone:function(){}}),V=M.extend({name:"CSV",fields:["id","uri","name","tags","text","err","ts","ts_mod"],onLoadListDone:function(){const e=this.list.map(e=>{let t=e.tags;return"string"==typeof t&&(t=N.compact(t.split(",").map((function(e){const t=App.labels.get(e);return t?t.get("name"):void 0})))),[C(e.name,!0),C(e.uri),C(t?t.join(","):""),e.ts,e.ts_mod,C(e.text),C(e.err||"")].join("\t")});e.unshift(["Name","URL","Labels","Created On","Changed On","Text","Error?"].join("\t")),this.out.value=e.join("\n")},render:function(){return this.$el.append(DIV({class:"alert alert-info",style:""},"TAB separated CSV will be generated below. Click Export button to start."),this.out=TEXTAREA({class:"from-control",style:"width: 100%; min-height: 400px;"})),this.list=[],this}}),U=M.extend({name:"JSON",onLoadListDone:async function(){this.out.value=Object(a.a)("l_loading")+" "+Object(a.a)("l_rule");let e=[];for(let i=0,n=this.list.length;i<n;i+=5)e=[...e,...await Promise.all(this.list.slice(i,i+5).map(t))];async function t(e){if(e.rule_id)try{e.rule=(await p.a.api("/rules/"+e.rule_id,"GET",{_opt:{only:["config"]}})).config}catch(e){console.error("error importing rule",e)}return(!e.tags instanceof Array||"string"==typeof e.tags)&&(e.tags=N.compact((e.tags||"").split(",").map((function(e){const t=App.labels.get(e);return t?t.get("name"):void 0})))),delete e.id,delete e.rule_id,delete e.ts_mod,delete e._state,e}this.out.value=JSON.stringify({client:j.a.agents,data:e})},render:function(){return this.$el.append(DIV({class:"alert alert-info"},"Data exported in JSON format will be generated below. You can use this JSON to import monitors later.\nNote: Actions are not exported. You can create actions for all monitors when importing them.\n\nClick Export button to start."),this.out=TEXTAREA({class:"from-control",style:"width: 100%; min-height: 400px;"})),this.list=[],this}});var B=u.a.ActionProvider.extend({name:"exporter",events:{"click .btn-primary":"event_click"},event_click:function(){this.view.load()},asCSV:function(e){this.showView(new V({parent:this,sieveList:e}))},asJSON:function(e){this.showView(new U({parent:this,sieveList:e}))},render:function(){return this.$el.append(DIV({class:"xtbar xvbar-margin"},BUTTON({class:"btn btn-default","data-action":"go_back"},I({class:"fa fa-chevron-left"})," Back"),BUTTON({class:"btn btn-primary"},Object(a.a)("a_export"))),H2({class:"xpage-header"},this.title=SPAN(""),SPAN(" - ",Object(a.a)("a_export")))),this},showView:function(e){this.view&&this.view.remove(),this.$el.append(e.render().el),R(this.title).text(e.name),this.view=e}}),F=i(7),H=i(37),Y=i(32),J=i(34);let q,Q,W,G,z,X,Z,K,ee,te,ie,ne,se,ae,oe,re,le=e=>e;window.jQuery;const ce=1,de=2,he=3,ue=4,pe=["name","url","labels"];class fe extends F.a{init(){this.state.loading=!0,setTimeout(()=>{const{result:e}=this.state,t=e.meta.fields,i=t.map(e=>e.toLowerCase()),n=e.data,[s,a]=e.data,o={};for(let e=1;e<t.length;e+=1){const i=t[e];i in pe&&(o[i]=e)}setTimeout(()=>{this.setState({index:o,fields:t,normalizedFields:i,rows:n,loading:!1})},200)},50),this.inputFields={}}getInputFields(){const e={},t=this.el.querySelectorAll("select");for(let i=0;i<t.length;i+=1){const n=t[i].value;n&&n.length>0&&(e[n]=this.state.fields[i])}return e}getRows(){const e=this.getInputFields();return this.state.result.data.map(t=>{const i={};for(const n in e)i[n]=t[e[n]];return i})}onSelectHeader(e,t){}createTpl({loading:e,index:t,fields:i,normalizedFields:n,rows:s}){return e?Object(F.b)(q||(q=le`Loading...`)):Object(F.b)(Q||(Q=le`
      <div class='page-header'>
        <h3>
          Data
          <small>
            Column headers show identified column attributes. You can edit them to manually specify or correct them.
          </small>
        </h3>
      </div>
      <div style='max-height: 200px; overflow-y: scroll;'>
        <table>
        <thead style=''>
          <tr style='border-top: solid 1px #ccc;'>
            ${0}
          </tr>
        </thead>
        <tbody>
          ${0}
        </tbody>
      </table>
    </div>

    `),n.map((e,t)=>Object(F.b)(W||(W=le`
            <th style='max-width: 100px; padding: 5px; border: solid 1px #ccc;'>
              <div><select @change=${0}>
                <option></option>
                ${0}
              </select></div>
            </th>`),e=>this.onSelectHeader(e,t),pe.map(t=>Object(F.b)(G||(G=le`<option value='${0}' ?selected=${0}>${0}</option>`),t,e==t,t)))),s.map(e=>Object(F.b)(z||(z=le`
            <tr style='border-bottom: solid 1px #ccc; white-space: nowrap;'>
              ${0}
            </tr>
          `),i.map(t=>Object(F.b)(X||(X=le`<td style='max-width: 200px; overflow: hidden; padding: 5px; border: solid 1px #ccc' title=${0}>${0}</td>`),e[t],e[t])))))}}class me extends F.a{init(){this.model=new b.a.Sieve,this.actions=new b.a.SieveActions(null,{}),this.actionEditor=new H.a.SieveActionsEditor({actions:this.actions}).render(),this.clientSelector=new Y.a.ClientSelector({model:this.model}),this.scheduleEditor=new H.a.SieveScheduleEditor({model:this.model}).render(),this.tagsEditor=new H.a.TagsEditor({model:this.model}).render()}getOptions(){return{...this.model.toJSON(),actions:this.actions.toJSON()}}createTpl({inputFields:e}){const{url:t,name:i,config:n,labels:s}=e;return Object(F.b)(Z||(Z=le`
      <div class='page-header'>
        <h3>
          Options
        </h3>
      </div>

      <div class='form-horizontal'>

        <div class='form-group'>
          <label class='control-label col-md-2'>Device</label>
          <div class='col-md-10'>
            ${0}
          </div>
        </div>

        <div class='form-group'>
          <label class='control-label col-md-2'>Schedule</label>
          <div class='col-md-10'>
            ${0}
          </div>
        </div>

        <div class='form-group'>
          <label class='control-label col-md-2'>Actions</label>
          <div class='col-md-10'>
            ${0}
          </div>
        </div>

        <div class='form-group'>
          <label class='control-label col-md-2'>Labels</label>
          <div class='col-md-10'>
            ${0}
          </div>
        </div>
      </div>`),this.clientSelector.el,this.scheduleEditor.el,this.actionEditor.el,this.tagsEditor.el)}}class ge extends F.a{init(){this.reset()}reset(){this.setState({progress:{index:0,total:0,msg:""},result:null,stage:ce,errorImport:null})}async onImport(){this.state.stage=ue;try{const e=this.csvMarker.getRows(),t=this.commonOptions.getOptions();let i;try{i=await Object(J.a)(e.length)}catch(e){console.error(e),i={isOverLimit:!1}}if(i.isOverLimit)return void(this.state.errorImport={msg:"Monitor limit exceeded"});this.importAll(e,t)}catch(e){console.error(e),this.state.errorImport={msg:`Import failed: ${e.message||e.msg}`}}}async importAll(e,t){const i=this.state;i.progress={index:0,total:e.length,msg:"Importing labels..."};for(let n=0;n<e.length;n+=1){const s=e[n];i.progress={...i.progress,msg:`Importing ${s.url}`},await this.importOne(s,t)}i.progress={...i.progress,msg:`Imported ${e.length}`}}async importOne(e,{tags:t,actions:i,...n}){if(e.rule){const t=await p.a.api("/rules","POST",{config:e.rule});e.rule_id=t.id}const s=[],a=e.labels||"";if(delete e.label,a.length>0){let e=await App.labels.getOrCreateLabels(a);s.push(...e)}if(t&&t.length>0){t=t.split(",");for(let e=0;e<t.length;e+=1)s.push(App.labels.get(t[e]))}e.tags=s.map(e=>e.id).join(","),e.uri=e.url,delete e.url;let o=_.extend({client_id:App.clients.defaultId,content_type:2,config:JSON.stringify({includeStyle:!0,ignoreEmptyText:!0,dataAttr:"text",selections:[{frames:[{index:0,excludes:[],includes:[{type:"css",expr:"body"}]}],dynamic:!0,delay:2}]})},e,n),r=await p.a.api("/sieves","POST",o);for(let e=0;e<i.length;e+=1)await p.a.api(`/sieves/${r.id}/actions`,"POST",_.extend({sieve_id:r.id},i[e]));this.state.progress={...this.state.progress,index:this.state.progress.index+1}}onBack(){this.state.stage-=1}onFileChange(e){const t=e.target.files[0],i=new FileReader;i.readAsText(t,"utf-8"),i.onload=e=>this.onFileRead(e.target.result),i.onerror=e=>this.onFileReadError(e),this.state.filename=t.name}onFileRead(e){Papa.parse(e,{header:!0,skipEmptyLines:!0,complete:e=>{this.showData(e)}})}onFileReadError(e){console.error("error reading file",e),this.state.errorFile=e.message}onFileSelect(e){this.el.querySelector("[type=file]").click()}onNextToOptions(){let e;const t=this.csvMarker.getInputFields();if(null==!t.name)e={key:"name",msg:"Missing name"};else if(t.url){const[i,n]=this.state.resultOrig.data,s=t.url,a=i[s],o=n[s];try{new URL(a),new URL(o)}catch(t){console.error(s,i,t),e={key:"url",msg:"malformed url"}}}else e={key:"url",msg:"Missing URL"};console.log("inputFields;",t,e),e?this.setState({errorMap:e}):(this.commonOptions=new me({inputFields:t}),this.state.stage=he)}showData(e){this.state.resultOrig=e,this.state.stage=de,this.csvMarker=new fe({result:e})}createTpl({csvText:e,progress:t,stage:i,errorMap:n,errorImport:s}){const o=t.index<t.total-1;return Object(F.b)(K||(K=le`
      <style> .actions { margin: 20px 0; }</style>
      <div class=xtbar>
        <button class='btn btn-default' data-action='go_back'> 
          <i class='fa fa-chevron-left'> Back</i>
        </button>
      </div>
      <div class='xpage-header'>
        <h2>
          CSV 
          ${0}
        </h2>
      </div>
      <div class='' style='padding: 10px; background-color: #fff; border-radius: 2px;'>
        ${0}

        ${0}

        ${0}

      ${0}

      ${0}
      ${0}

    </div>`),Object(a.a)("a_import"),i==ce?Object(F.b)(ee||(ee=le`
          <div class='row'>
            <div class='col-md-4'>
              <input class='btn btn-default btn-lg' type='file' accept='.csv' style='display:none' @change=${0}></input>
              <button class='btn btn-primary btn-lg' @click=${0}>
                Select CSV file to import monitors
              </button>
              ${0}
            </div>
            <div class='col-md-8'>
              Please note that the file should have columns with following headers:
              <ul>
                <li>Name</li>
                <li>URL</li>
                <li class='hide'>Config (Optional)</li>
                <li>Labels (Optional)</li>
              </ul>
            </div>
          </div>`),e=>this.onFileChange(e),e=>this.onFileSelect(e),i>ce?Object(F.b)(te||(te=le`<span>File: ${0}</span>`),this.state.filename):""):"",i==de?Object(F.b)(ie||(ie=le`
        <div>
          ${0}
          <div class='actions'>
            <button class='btn btn-default' @click=${0}>Back</button>
            <button class='btn btn-primary' @click=${0}>
              Next - configure options and actions
            </button>
          </div>
          ${0}
        </div>`),this.csvMarker.el,e=>this.onBack(),e=>this.onNextToOptions(),n?Object(F.b)(ne||(ne=le`<div class='error'>${0}</div>`),n.msg):""):"",i==he?Object(F.b)(se||(se=le`
        <div>
          ${0}
          <div class='actions'>
            <button class='btn btn-default' @click=${0}>Back</button>
            <button class='btn btn-primary' @click=${0}>${0}</button>
          </div>
        </div>`),this.commonOptions.el,e=>this.onBack(),e=>this.onImport(),Object(a.a)("a_import")):"",i==ue&&o?Object(F.b)(ae||(ae=le`
        <div> <span>${0}</span> of <span>${0}</span> </div>
        <div>${0}</div>
        `),t.index,t.total,t.msg||""):"",i!=ue||o?"":Object(F.b)(oe||(oe=le`
        <div>${0}
          <button class='btn btn-default' @click=${0}>Start Over</button>
        </div>`),t.msg||"",e=>this.reset()),s?Object(F.b)(re||(re=le`<div class='error'>${0}</div>`),s.msg):"")}setActive(e){}}var ve=ge;const be=window.jQuery;var we=u.a.ActionProvider.extend({name:"importer",events:{"click .btn-primary":"event_click"},event_click:function(){this.doImport()},doImport:async function(){try{const e=this.input.value,t=JSON.parse(e),i=this.actions.toJSON();let n={};try{n=await Object(J.a)(t.data.length)}catch(e){console.error(e),n={isOverLimit:!1}}if(n.isOverLimit)return void h.a.error("Monitor limit exceeded!");await this.importAll(t,i)}catch(e){console.error(e),h.a.error("Failed to parse data. Invalid JSON.")}},fromJSON:function(){this.progress=0,this.totalCount=0,this.input.value="",this.updateStatus()},importAll:async function(e,t){this.$(".btn-primary").button("loading"),h.a.info("Importing labels...");try{const i=_.uniq(_.flatten(_.pluck(e.data,"tags"))),n=await App.labels.getOrCreateLabels(i),s=_.object(_.pluck(n,"name"),_.pluck(n,"id"));this.progress=0,this.totalCount=e.data.length,this.updateStatus();let a=e.data;for(let e=0;e<a.length;e+=1){const i=a[e];await this.importOne(i,t,s)}h.a.info("Import completed"),this.$(".btn-primary").button("reset")}catch(e){console.error("failed to import data:",e),h.a.error("Error importing data: "+e)}},importOne:async function(e,t,i){if(e.rule){let t=await p.a.api("/rules","POST",{config:e.rule});e.rule_id=t.id}e.tags&&(e.tags=_.map(e.tags,(function(e){return i[e]})).join(","));let n=(await p.a.api("/sieves","POST",{...e,client_id:App.clients.defaultId})).id;for(let e=0;e<t.length;e+=1){let i=t[e];await p.a.api(`/sieves/${n}/actions`,"POST",{...i,sieve_id:n})}this.progress+=1,this.updateStatus()},updateStatus:function(){be(this.counter).text(this.progress),be(this.total).text(this.totalCount),this.totalCount>0&&this.progress==this.totalCount?be(this.msgStatus).text(" - Complete!"):be(this.msgStatus).text("")},postInit:function(){this.actions=new b.a.SieveActions(null,{}),this.actionEditor=new H.a.SieveActionsEditor({actions:this.actions,parent:this})},render:function(){return this.$el.append(DIV({class:"xtbar  xvbar-margin"},BUTTON({class:"btn btn-default","data-action":"go_back"},I({class:"fa fa-chevron-left"})," Back")),H2({class:"xpage-header"},H2(this.title=SPAN(""),SPAN(Object(a.a)("a_import")))),DIV({class:"row"},DIV({class:"col-md-5"},H4("Actions for imported monitors"),this.actionEditor.render().el),DIV({class:"col-md-7"},this.input=TEXTAREA({class:"form-control",style:"width:100%;min-height:300px",placeholder:"Paste JSON data to import and click Import."}))),DIV({style:"margin-top: 20px;"},BUTTON({class:"btn btn-primary"},Object(a.a)("a_import"))," Imported: ",this.counter=SPAN("0")," of ",this.total=SPAN("0"),this.msgStatus=SPAN()),DIV()),this}}),_e=i(54),ye=i(55);if(!window.domo)throw new Error("ADD domo");const xe=window._;if(!xe)throw new Error("ADD _");if(!window.jQuery)throw new Error("ADD jQuery");const Se=window.Backbone;if(!Se)throw new Error("ADD Backbone");var Ie={PreRenderedForm:u.a.Form.extend({name:"PreRenderedForm",fields:[],postInit:function(){this.model||(this.model=new Se.Model),this.initEditors()},getFieldEl:function(e){const t=e.name.replace("[","\\[").replace("]","\\]");return this.$el.find("[name="+t+"]")},initEditors:function(){this.editors=xe.map(this.fields,(function(e){return y.a.create(e.type,{param:e,parent:this,model:this.model,el:this.getFieldEl(e).parent()[0]}).acquire()}),this)},validateFields:function(){return xe.filter(this.editors,(function(e){return!e.isValid()}),this)}})};const De=window.jQuery;if(!De)throw new Error("ADD jQuery");const Ae=window._;if(!Ae)throw new Error("ADD _");var Oe=Ie.PreRenderedForm.extend({name:"SearchForm",events:{"input input":"event_input"},fields:[{name:"q",type:"text"}],event_input:function(){this.search()},postInit:function(){const e=this,t=["is:\n on,off,read,unread","has:\nerror","label:\ncustom labels","in:\ndeleted items"],i=["on","off","read","unread"],n=Ae.map(i,(function(e,t){return{id:t,name:e}})),s=Ae.map(t,(function(e,t){return{id:t,name:e}}));De(this.el.q).atwho({at:"has:",data:["error"]}).atwho({at:"in:",data:["trash"]}).atwho({at:"is:",callbacks:{filter:function(e,t,i){let n,s,a,o;for(n=[],s=0,o=t.length;s<o;s++)0!=(a=t[s])[i].toLowerCase().indexOf(e.toLowerCase())&&""!==e||n.push(a);return n}},data:n}).atwho({at:"label:",limit:10,callbacks:{matcher:function(e,t,i,n){let s,a,o,r,l;return e=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),i&&(e="(?:^|\\s)"+e),s=decodeURI("%C3%80"),a=decodeURI("%C3%BF"),(o=(r=new RegExp(e+"([A-Za-z"+s+"-"+a+"0-9_"+(l=n?" ":"")+"\"'.+-]*)$|"+e+"([^\\x00-\\xff]*)$","gi")).exec(t))?o[2]||o[1]:null},filter:function(t,i,n){let s,a,o,r;s=[];const l=e.options.labels.map((function(e,t){const i=e.get("name").replace(/"/g,escape('"'));return{id:t,name:i.indexOf(" ")>=0?'"'+i+'"':i}}));for(a=0,r=l.length;a<r;a++){const e=(o=l[a])[n].toLowerCase();0!=e.replace('"',"").replace("'","").indexOf(t.toLowerCase())&&0!=e.indexOf(t.toLowerCase())&&""!==t||s.push(o)}return s}},data:[]}).atwho({at:"",startWithSpace:!0,callbacks:{filter:function(e,t,i){let n,s,a,o;for(n=[],s=0,o=t.length;s<o;s++)a=t[s],0!=new String(a[i]).toLowerCase().indexOf(e.toLowerCase())&&""!==e||n.push(a);return n},tplEval:function(e,t){return"<li data-name='"+Ae.escape(t.name.split("\n")[0])+"'>"+Ae.escape(t.name.split("\n")[0])+"      <span style='color:grey;'>"+Ae.escape(t.name.split("\n")[1])+"</span></li>"},beforeInsert:function(e,t){return t.data("name")}},data:s,suffix:""}).on("inserted.atwho",(function(t,i,n){const s=i.data("name");s&&":"===s[s.length-1]||e.search(),De(this).atwho("run")})),this.model||(this.model=new Backbone.Model),Oe.__super__.postInit.apply(this,arguments)},search:Ae.debounce((function(){const e=this.el.q.value.trim();App.nav("search/"+encodeURIComponent(e))}),600),submit:function(){return this.search(),!1}}),Ee=Oe;const Te=window.jQuery;if(!Te)throw new Error("ADD jQuery");const ke=window._;if(!ke)throw new Error("ADD _");if(!window.async)throw new Error("ADD async");if(!window.domo)throw new Error("ADD domo");if(!window.Backbone)throw new Error("ADD Backbone");const $e=u.a.Base.extend({name:"label",tagName:"li",postInit:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"remove",this.remove)},render:function(){const e=this.model.get("name");return this.$el.empty().append(A({href:"#","data-path":"label/"+encodeURIComponent(e)},e),DIV({class:"dropdown",style:"position:absolute;top:2px;right:0;"},BUTTON({class:"btn btn-mini xbtn-light dropdown-toggle","data-toggle":"dropdown"},I({class:"fa fa-caret-down"})),UL({class:"dropdown-menu dropdown-menu-right"},LI(A({"data-action":"nav label rename","data-action-param":this.model.id},I({class:"fa fa-pencil","aria-hidden":!0}),"  ",Object(a.a)("a_rename"))),LI(A({"data-action":"nav label del","data-action-param":this.model.id},I({class:"fa fa-trash-o","aria-hidden":!0}),"  ",Object(a.a)("a_del")))))).css({postion:"relative"}),this}}),Le=u.a.Entities.extend({name:"LabelNavList",className:"nav nav-list",tagName:"ul",actions:{"nav label add":{fn:"action_add"},"nav label del":{fn:"action_del"},"nav label rename":{fn:"action_rename"}},events:{"click a[data-path]":"action_route"},action_add:function(){const e=this,t=y.a.create("text"),i=new u.a.PromptModal({title:"l_label",parent:this.getRoot(),view:t,width:500});i.show(),Te(t.field).focus(),i.on("save",(function(){const n=t.getValue();ke.isEmpty(n)?i.showAlert("e_value_incorrect_check"):(i.remove(),e.collection.create({name:n},{wait:!0}))}))},action_del:function(e){const t=this.collection.get(e);t&&confirm("Delete label - "+t.get("name")+"?")&&t.destroy()},action_rename:function(e){const t=this.collection.get(e),i=y.a.create("text",{param:{label:"l_label",must:!0,name:"name"},model:t.clone(),parent:this}),n=new u.a.PromptModal({title:"l_label",parent:this.getRoot(),view:i,width:500});n.on("save",(function(){const e=i.getValue();n.showProgress(),t.save({name:e},{patch:!0,wait:!0,error:function(e,t){n.showProgress(!1),e.showAlert("e_req")},success:function(e,t){n.showProgress(!1),n.remove()}})})),n.show()},action_route:function(e){const t=e.target,i=Te(t).attr("data-path");e.preventDefault(),e.stopPropagation(),App.nav(i,{trigger:!0})},addOne:function(e,t){const i=new $e({model:e,parent:this}).render();this.$divider.before(i.el)},removeOne:function(e){e.trigger("remove")},renderBase:function(){this.$divider=this.$el.find(".divider").last()},select:function(e,t){e+=t?"/"+encodeURIComponent(t):"",this.currentPath=e,this.$el.find("li.active").removeClass("active");const i=this.$el.find('li a[data-path="'+e+'"]');i.parents("li").addClass("active"),i.length>1&&new u.a.Modal({title:"Duplicate Labels",parent:this,view:new u.a.Base({el:DIV("There are duplicate labels present in your list. When labels from other devices are synced together, all of them are collected in one place. If you synced data, it may be the reason for duplicate labels. In any case, you should rename or delete one of them.")})}).show()}}),Pe=$e.extend({render:function(){this.$el.append(INPUT({type:"chechbox"}),LABEL({},this.model.get("name")))}}),je=Le.extend({addOne:function(){const e=new Pe({model:model,parent:this}).render();this.$list.append(e.el)},getSelections:function(){},onAdd:function(){},postInit:function(){},renderBase:function(){let e,t;this.$el.append(e=INPUT({type:"textbox",class:"hide"}),LI({class:"divider"}),t=UL({class:"nav nav-list"}),LI({class:"divider"}),LI(BUTTON({class:"btn hide"},Object(a.a)("a_add")))),(void 0).onclick=this.onAdd,this.$input=Te(e),this.$list=Te(t)}});var Re={LabelNavList:Le,LabelSelectionList:je};const Ne=window.async;if(!Ne)throw new Error("ADD async");if(!window.domo)throw new Error("ADD domo");const Ce=window.jQuery;if(!Ce)throw new Error("ADD jQuery");if(!window.moment)throw new Error("ADD moment");const Me=u.a.ActionProvider.extend({className:"panel form form-horizontal",load:function(e){const t=this;window.USER?Ne.parallel({user:function(e){p.a.api("/users/self",e)},subscription:function(e){p.a.api("/subscriptions?state=40&_opt[limit]=1",(function(t,i){e(t,i&&i.data[0])}))}},(function(e,i){t.renderAccountDetails(i.user,i.subscription)})):(Ce(this.body).text(Object(a.a)("m_sign_in_req")),e())},render:function(){return this.$el.append(DIV({class:"panel-heading"},H3(Object(a.a)("l_account"))),this.body=DIV({class:"panel-body"},Object(a.a)("l_loading"))),this},renderAccountDetails:function(e,t){Ce(this.body).empty().append(DIV({class:"form-group"},LABEL({class:"col-sm-3"},Object(a.a)("l_email")),DIV({class:"col-sm-9"},e.email)),DIV({class:"form-group"},LABEL({class:"col-sm-3"},Object(a.a)("l_username")),DIV({class:"col-sm-9"},e.name)),DIV({class:"form-group"},LABEL({class:"col-sm-3"},Object(a.a)("l_subscription")),DIV({class:"col-sm-9"},A({href:"/settings/billing"},Ve[t.plan_id]))),DIV({class:"form-group"},LABEL({class:"col-sm-3"},Object(a.a)("l_credit")),DIV({class:"col-sm-9"},"$",SPAN({class:"xcredit"},e.credit/100))))}});var Ve={"00000000-0000-0000-0000-000000000000":"Free","11111111-1111-1111-1111-111111111111":"Basic","22222222-2222-2222-2222-222222222222":"Pro","33333333-3333-3333-3333-333333333333":"Flexi","44444444-4444-4444-4444-444444444444":"Free trial"},Ue=Me;if(!window.domo)throw new Error("ADD domo");const Be=window.jQuery;if(!Be)throw new Error("ADD jQuery");var Fe=u.a.ActionProvider.extend({className:"panel",load:function(e){const t=this;window.USER?p.a.api("/users/usage/monthly?_opt[limit]=1",(function(i,n){if(i);else{const e={run:0,email:0,sms:0};let i;i=0==n.data.length?e:n.data[0],p.a.api("/users/constraints",(function(e,n){t.renderUsage(i,n)}))}e(i)})):(Be(this.body).text(Object(a.a)("m_sign_in_req")),e())},render:function(){return this.$el.append(DIV({class:"panel-heading"},H3(Object(a.a)("l_usage"))),this.body=DIV({class:"panel-body form form-horizontal"},Object(a.a)("l_loading"))),this},renderProgress:function(e,t,i){const n=Math.min(100,100*t/i|0);return t>0?DIV({class:"form-group"},LABEL({class:"col-sm-2"},e),DIV({class:"col-sm-10"},DIV({class:"progress",role:"progressbar"},DIV({class:"progress-bar"+(n>95?"progress-bar-danger":""),"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":i,style:"min-width: 40px;width: "+n+"%"},SPAN(t))))):""},renderUsage:function(e,t){Be(this.body).empty().append(this.renderProgress("Checks",e.run,t.run),this.renderProgress("Emails",e.email,t.email),this.renderProgress("SMSes",e.sms,t.sms))}});const He=window.async;if(!He)throw new Error("ADD async");var Ye=u.a.ActionProvider.extend({load:function(e){const t=this;He.parallel([function(e){t.account.load(e)},function(e){t.usage.load(e)}],e)},postInit:function(){this.account=new Ue({parent:this}),this.usage=new Fe({parent:this})},render:function(){return this.$el.append(this.account.render().el,this.usage.render().el,I()),this}}),Je=i(29);if(!window.domo)throw new Error("ADD domo");const qe=window.jQuery;if(!qe)throw new Error("ADD jQuery");const Qe=window._;if(!Qe)throw new Error("ADD _");const We=window.async;if(!We)throw new Error("ADD async");if(!window.moment)throw new Error("ADD moment");const Ge=window.Backbone;if(!Ge)throw new Error("ADD Backbone");function ze(e){return e.replace(/[[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function Xe(e){const t={};return e.searchParams.forEach((function(e,i){t[i]=e})),t}const Ze=u.a.Base.extend({name:"SieveTplRow",tagName:"li",className:"list-group-item",onDel:function(){this.model.destroy()},render:function(){const e=this.model.attributes;let t;return this.$el.empty().attr({"data-id":e.id}).append(DIV(DIV({style:"float: left"},t=BUTTON({class:"btn btn-default xbtn-light",title:Object(a.a)("a_del")},I({class:"fa fa-trash-o"}))),DIV(DIV(e.desc_name),DIV(e.desc_uri)))),t.onclick=this.onDel,this}}),Ke=u.a.Collection.extend({name:"TplCollection",tagName:"ul",className:"list-group",addOne:function(e){const t=new Ze({model:e,parent:this});return this.$el.append(t.render().el),t}}),et=u.a.ActionProvider.extend({postInit:function(){j.a.agents.local&&!j.a.isSignedIn()?this.view=new Ge.View({el:DIV("Please sign in to your account and try again")}):this.view=new Ke({collection:this.collection=new $.Tpls,parent:this})},render:function(){return this.$el.empty().append(DIV({class:"xtbar xvbar-margin"},BUTTON({class:"btn btn-default","data-action":"go_back"},I({class:"fa fa-chevron-left"})," ")),DIV({class:"xpage-header"},H3(Object(a.a)("l_sieve_tpl_list")," ",SMALL("(beta)"))),this.view.render().el),this},showList:function(){this.collection&&this.collection.fetch({data:{user_id:USER.id}})}}),tt=u.a.ActionProvider.extend({postInit:function(e){const t=this.model;this.fields={name:y.a.create("text",{parent:this,model:t,param:{name:"desc_name",help:"h_tpl_desc_name"}}),info:y.a.create("textarea",{parent:this,model:t,param:{name:"desc_info",help:"h_desc"}})}},render:function(){const e=this.fields;return this.$el.empty().append(Qe.map(["name","info"],(function(t){return DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},Object(a.a)("l_tpl_desc_"+t)),DIV({class:"col-md-10"},e[t].render().el))}))),this}}),it=u.a.ActionProvider.extend({name:"SimpleTplEditor",actions:{tpl_save:{fn:"action_save"}},action_save:function(e,t){const i=this,n=this.model.clone();function s(){i.patterns.tpl=n,We.each(i.patterns.models,a,(function(e,i){e?o(e):(qe(t).button("reset"),App.nav("tpls"))}))}function a(e,t){e.save(null,{error:function(){t(new Error("Failed to save pattern"))},success:function(){t()}})}function o(e){console.error("Error saving template",e),qe(t).button("reset"),h.a.error("Failed to save template")}qe(t).button("loading"),n.save({sieve_config:JSON.parse(this.sieve.config),sieve_type:this.sieve.content_type},{error:o,success:function(e){h.a.info("Template saved!"),setTimeout(s,0)}})},handleNetworkError:function(){let e="Failed to load data. Please check network connection and try again.";j.a.agents.local&&!j.a.isSignedIn()&&(e="Please sign in to your account and try again"),this.$elLoad.addClass("error").text(e)},postInit:function(e){const t=this.model;this.patterns=new $.Patterns,this.pattern=new $.Pattern,this.patterns.add(this.pattern),this.views={patternURIEditor:new y.a.create("text",{parent:this,model:this.pattern,param:{name:"pattern",help:"h_tpl_url_pattern"}}),desc:new tt({parent:this,model:t}).render()},this.$el.addClass("form-horizontal"),this.$el.empty().append(DIV({class:"xpage-header"},H4(Object(a.a)("Match URL"))),DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},Object(a.a)("l_uri_pattern")),this.elTip=DIV({class:"col-md-10 hide"},this.views.patternURIEditor.render().el),this.elLoad=DIV({class:"col-md-10"},"Loading data...")),DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},Object(a.a)("l_url")),DIV({class:"col-md-10"},this.elURL=DIV())),this.elDesc=DIV({class:"hide"},DIV({class:"xpage-header"},H4(Object(a.a)("l_desc"))),this.views.desc.el,DIV({class:"form-group"},DIV({class:"col-md-offset-2 col-md-10 xtbar-form"},BUTTON({class:"btn btn-primary xbtn-default","data-action":"tpl_save"},Object(a.a)("a_save")),BUTTON({class:"btn btn-default","data-action":"go_back"},Object(a.a)("a_discard")))))),this.$elLoad=qe(this.elLoad),this.start()},setPattern:function(e){const t=this.sieve;new URL(t.uri);qe(this.elLoad).remove(),qe(this.elTip).removeClass("hide"),qe(this.elDesc).removeClass("hide"),e?qe(this.elDesc).find("input").first().focus():qe(this.elTip).find("input").focus(),this.pattern.set({pattern:e||ze(t.uri.split("/").slice(2).join("/"))+"$",uri_ref:t.uri}),this.model.set({desc_name:t.name,desc_info:"",desc_uri:t.uri.split("/").slice(0,3).join("/")})},start:function(){const e=this;p.a.api("/sieves/"+this.options.sieveId,"GET",{},(function(t,i){if(t)return void e.handleNetworkError();e.sieve=i;const n=i.uri;e.$elLoad.text("Finding URL pattern..."),e.elURL.textContent=n,We.parallel({sieves:function(e){const t=new URL(n).host;p.a.api("/sieves","GET",{"uri.ne":n,"uri.like":"%"+t+"%","state.in":[40,45]},e)},patterns:function(e){p.a.api("/tpls/patterns/search","GET",{url:n},e)}},(function(t,n){t?(console.error("Failed to fetch data: ",t),e.handleNetworkError()):e.suggestOptions(i,n.sieves.data,n.patterns.data)}))}))},suggestOptions:function(e,t,i){const n=this,s=e.uri;let a;this.$elLoad.empty(),i.length>0?a=i:t.length>0&&(a=this.generatePatterns(s,t)),a?(a=Qe.uniq(a,(function(e){return e.pattern})),this.$elLoad.append(DIV({class:"list-group"},Qe.map(a,(function(e){return A({href:"#",class:"list-group-item"},DIV(SAMP(e.pattern)),SMALL(e.uri_ref))}))),P(),BUTTON({class:"btn btn-default"},"Or, use custom pattern")),this.$(".list-group-item").click(".list-group-item",(function(e){e.preventDefault(),n.setPattern(qe(e.currentTarget).find("samp").text())})),this.$elLoad.find("button").click((function(){n.setPattern()}))):this.setPattern()},generatePatterns:function(e,t){const i=e.split("/"),n=new URL(e),s=n.pathname.split("/"),a=Xe(n),o=Qe.filter(t,(function(e){const t=new URL(e.uri),i=t.pathname.split("/"),n=Xe(t);return s.length==i.length&&Qe.isEqual(Qe.keys(a),Qe.keys(n))}));if(o.length>0)return Qe.map(o,(function(e){const t=e.uri.split("/"),s=Qe.map(i,(function(e,i){return e===t[i]?ze(e):e.length>0?"(.*)":""}));return s[2]=ze(i[2]),{pattern:s.slice(2).join("/")+("/"==n.pathname?"$":""),uri_ref:e.uri}}))}});var nt={TplList:et,Editor:u.a.ActionProvider.extend({name:"TplEditor",create:function(e){this.view&&this.view.remove(),this.view=new it({parent:this,sieveId:e,model:new $.Tpl}),this.elView.appendChild(this.view.render().el)},render:function(){return this.$el.empty().append(DIV({class:"xtbar"},BUTTON({class:"btn btn-default","data-action":"go_back"},I({class:"fa fa-chevron-left"})," ",Object(a.a)("a_discard"))),DIV({class:"xpage-header"},H3(Object(a.a)("l_tpl")," ",SMALL("Templates help add monitors using preconfigured selections."))),this.elView=DIV()),this}})};if(!window.domo)throw new Error("ADD domo");const st=window.jQuery;if(!st)throw new Error("ADD jQuery");const at=window._;if(!at)throw new Error("ADD _");const ot=window.async;if(!ot)throw new Error("ADD async");if(!window.moment)throw new Error("ADD moment");const rt=window.Backbone;if(!rt)throw new Error("ADD Backbone");var lt=u.a.ActionProvider.extend({name:"SieveFromTpl",actions:{add_next:{fn:"action_next"}},action_next:function(){this.createAndSaveSieve()},add:function(e,t,i){this.title=i,this.url=t,this.tpl=new $.Tpl({id:e}),this.patterns=new $.Patterns,this.patterns.tpl=this.tpl,this.loadModels([this.tpl,this.patterns],this.onLoadModels),this.$(".xbtn-default").button("loading")},build:function(e,t,i){function n(e){const n=t[e]||"";return i?encodeURIComponent(n):n}return e.replace(/#\{\{(\w*)\}\}/g,(function(e,t){return JSON.stringify(n(t))})).replace(/\{\{(\w*)\}\}/g,(function(e,t){return n(t)}))},createAndSaveSieve:function(){const e=this.tpl.id,t=this.tpl.toJSON(),i=this.model,n=at.extend(this.values,i.attributes),s=t.sieve_uri?this.build(t.sieve_uri,n,!0):this.url;if(!at.isEmpty(this.findEmptyParams(this.params,n)))return h.a.error("Please enter paramter values before proceeding.");const a={content_type:t.sieve_type,config:this.build(t.sieve_config,this.values),uri:s,schedule:JSON.stringify({type:"INTERVAL",params:{interval:3600}}),state:w.a.STATE_INIT,client_id:App.clients.defaultId},o=new b.a.Sieve(a,{parse:!0});o.get("config").set("meta",{tplId:e}),this.options.onSave(o)},findEmptyParams:function(e,t){return at.filter(e,(function(e){return at.isEmpty(t[e.name])}))},loadModels:function(e,t){ot.each(e,(function(e,t){e.fetch({error:function(e,i){t(i)},success:function(){t(null,e)}})}),t)},onLoadModels:function(e){if(e)return h.a.error("Failed to fetch models");const t=this.patterns.at(0),i=t?this.pickValues(this.url,t):{},n=this.tpl.get("params").toJSON(),s=this.findEmptyParams(n,i);if(this.params=n,this.model=new rt.Model,this.values=i,s.length>0){const e=at.map(s,(function(e){return y.a.create(e.type,{parent:this,model:this.model,param:{name:e.name,help:e.desc||""}})}),this);this.renderEditors(e),this.$(".xbtn-default").button("reset")}else this.createAndSaveSieve()},pickValues:function(e,t){const i=t.get("pattern_params").toJSON(),n=new RegExp(t.get("pattern")).exec(e)||[],s={};return at.each(i,(function(e){s[e.name]=n[e.index+1]})),s},render:function(){const e=this.options.renderNavbar;return this.$el.empty().append(e?DIV({class:"xtbar xvbar-margin"},BUTTON({class:"btn btn-default","data-action":"go_back"},I({class:"fa fa-chevron-left"})," ",Object(a.a)("a_discard"))):"",DIV({style:"padding: 10px;"},e?DIV({class:"xpage-header"},H3(Object(a.a)("l_add_monitor"))):"",DIV({class:"form-horizontal"},this.elContent=DIV(),DIV({class:"form-group"},DIV({class:"col-md-offset-2 col-md-10 xtbar-form"},BUTTON({class:"btn btn-primary xbtn-default","data-action":"add_next"},Object(a.a)("a_next")," ",I({class:"fa fa-chevron-right"}))))))),this},renderEditors:function(e){this.editors&&at.each(this.editors,(function(e){e.remove()})),this.editors=e,st(this.elContent).empty().append(DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},"Source URL"),DIV({class:"col-md-10"},SPAN(this.url||"None")))).append(at.map(e,(function(e){return DIV({class:"form-group"},LABEL({class:"control-label col-md-2"},e.param.name),DIV({class:"col-md-10"},e.render().el))})))}});i(38);if(!window.domo)throw new Error("ADD domo");if(!window.jQuery)throw new Error("ADD jQuery");if(!window._)throw new Error("ADD _");if(!window.Backbone)throw new Error("ADD Backbone");u.a.Base.extend({name:"DeviceView",postInit:function(){window.addEventListener("message",e=>{console.log(e,e.data,e.origin),"event"==e.data.type&&this.trigger("frame:"+e.data.data)}),this.on("frame:ready",()=>{this.postMessage({type:"request",data:{action:"login"}})})},postMessage:function(e){this.iframe.contentWindow.postMessage(e,r.a.CFG.URL.ROOT)},render:function(){this.$el.empty().append(DIV({name:"device-manager"},this.iframe=IFRAME({src:r.a.CFG.URL.ROOT+"/frame-devices",style:"width: 80%; height: 100vh",frameborder:"none"})))}});var ct=i(56),dt=i(53);async function ht(e,t){"contactNA"==await(await fetch(URL_ANALYTICS+"/tags",{method:"POST",headers:{"Content-Type":"application/json","x-context":t.email},body:JSON.stringify(e)})).text()&&(await ht(["new",t.name,t.ts],t),await ht(e,t))}var ut=i(52);const pt=window.async;if(!pt)throw new Error("ADD async");const ft=window.jQuery;if(!ft)throw new Error("ADD jQuery");const mt=window.Backbone;if(!mt)throw new Error("ADD Backbone");t.default=function(){Object(s.a)(),!r.a.auth.isReady()&&(location.href=r.a.service.serviceLoginUrl);const e=window.USER,t=new f.a.Clients,i=new v.Labels,l=new b.a.Sieves(null,{comparator:function(e){return-e.get("ts_data")}});setTimeout(async()=>{let i=[];if(e.email){t.models.forEach(t=>{t.attributes.type>=10&&(i.push(["installed-ext",t.attributes.name]),Math.floor((new Date(t.attributes.ts)-new Date(e.ts))/1e3/86400)>3&&i.push(["before-signup",t.attributes.name]))});let n=0;l.models.forEach(e=>{40==e.attributes.state&&n++}),"inbox"==App.sieveList.routePrefix&&i.push(["monitor-count",n])}ht(i,e)},4e3);const c=new d;let m="inbox";function g(){r.a.service.active?h.a.reset():h.a.error("m_checks_paused")}function w(){h.a.start("init",{info:"l_loading"}),h.a.showHelp(),ft("#topbar").removeClass("hide"),ft("#topbar-user").html(`<div class="xnav-item"><a href=${USER.name?`"${dt.a.settings}">${USER.name}`:`"${dt.a.login}">Sign In`}</a></div>`),Object(n.f)(Object(ct.a)(),document.getElementById("x-vsidebar")),ft("#x-vsidebar").find('[data-toggle="tooltip"]').tooltip({placement:"right"}),ft("#x-vsidebar").find(".vbar-tooltip").tooltip({placement:"right"}),pt.parallel([function(e){t.fetch({data:{"state.in":[0,30],_opt:{order:["ts"]}},error:function(){e(new Error("Failed to fetch clients' list."))},success:function(){t.defaultId=r.a.store.Prefs.get("client.id"),e()}})},async function(e){if(!USER.id)return USER.constraint={interval:5},e();try{let t=await p.a.api("/users/constraints");USER.constraint=t,e()}catch(t){console.error("Error fetching constraint:",t),USER.constraint={interval:5},e()}},function(e){i.fetch({data:{"state.ne":100,_opt:{order:["name"],limit:1e3}},error:function(){e(new Error("Failed to fetch labels."))},success:function(){e()}})}],(function(e){h.a.stop("init",e?{error:"err:fetch"}:void 0),mt.history.start({root:ROUTE_ROOT,pushState:PUSH_STATE}),!e&&ft("#content").removeClass("hide"),r.a.service.active||g()}))}USER.prefs||(USER.prefs={}),c.__init__(),Je.a.on("clients",(function(){t.fetch({data:{"state.in":[0,30],_opt:{order:["ts"]}}})})),Je.a.on("tags",(function(){i.fetch({data:{"state.ne":100,_opt:{order:["name"],limit:1e3}}})})),Je.a.on("service:state",g);var _=u.a.RoutedRoot.extend({actions:{go_back:{fn:"action_go_back"}},events:{"click .xsidebar a":"event_nav"},action_go_back:function(e){App.navBack()},event_nav:function(e){m=location.hash.slice(1)},onChangeError:function(t){this.$(".xbadge-error").text(t)[t>0?"show":"hide"](),setTimeout(()=>{if(e.email&&"inbox"==App.sieveList.routePrefix&&l.length>0){ht(["error-count",t/l.length>.5?t:0],e)}},4e3)},onChangeUnread:function(e){this.$(".xbadge-unread").text(e)[e>0?"show":"hide"]()},postInit:function(e){_.__super__.postInit.call(this,e),this.listenTo(Je.a,"change:unread",this.onChangeUnread),this.listenTo(Je.a,"change:error",this.onChangeError)},render:function(){return this.$el.append(DIV({id:"planbar",style:"position:fixed;top:40px;width:100%;height:0;text-align:center;"}),DIV({class:"xsidebar"},DIV({class:"btn-group",style:"margin-bottom:20px;width:100%"},BUTTON({class:"btn btn-success dropdown-toggle","data-toggle":"dropdown",style:"width:100%"},Object(a.a)("a_add")),UL({class:"dropdown-menu",role:"menu"},LI(A({tabindex:-1,href:"#add/type-page"},Object(a.a)("l_webpage"))),LI(A({tabindex:-1,href:"#add/type-feed"},Object(a.a)("l_feed"))))),UL({class:"nav nav-pills nav-stacked",style:"margin-bottom:10px;"},LI(A({href:"#","data-path":"inbox"},Object(a.a)("l_all"))),LI(A({href:"#","data-path":"filter/unread"},SPAN({class:"badge xbadge-unread",style:"float: right"},""),Object(a.a)("l_unread"))),LI(A({href:"#","data-path":"filter/error"},SPAN({class:"badge xbadge-error",style:"float: right"},""),Object(a.a)("l_error"))),LI(A({href:"#","data-path":"trash"},Object(a.a)("l_trash"))),LI({class:"divider",style:"border:solid 1px #ccc"}),LI({class:"divider"}),LI(A({class:"btn btn-default","data-action":"nav label add"},Object(a.a)("a_add_label"))))),DIV({class:"xcontainer"},DIV({id:"list",class:"hide"}),DIV({id:"tpl-editor",class:"hide"}),DIV({id:"tpls",class:"hide"}),DIV({id:"sieve-editor",class:"hide"}),DIV({id:"sieve-from-tpl",class:"hide"}),DIV({id:"exporter",class:"hide"}),DIV({id:"importer-csv",class:"hide"}),DIV({id:"importer-json",class:"hide"}),DIV({style:""},L)),DIV({id:"summaries",class:"xslidebar"},DIV({class:"xhandle",role:"button"},I({class:"xvertical-middle fa fa-chevron-left"}),I({class:"xvertical-middle fa fa-chevron-right"})),DIV({class:"xcontent"}))),this},route:function(e){App.nav(e)}});window.App=new function(n){const s=mt.Router.extend({routes:{"":"index","add/type-:type":"add","add/tpl-:id/url-:url(/:name)":"add_using_tpl_for_url","add-tpl/:from_id":"add_template","edit/:id":"edit","edit-dup/:id":"duplicate","edit-tpl/:id":"edit_tpl",export_csv:"export_csv",export_json:"export_json","filter/error(/:id)":"filter_error","filter/unread(/:id)":"filter_unread",import_csv:"import_csv",import_json:"import_json","inbox(/:id)":"inbox","label/:name(/:id)":"label","search/(:query)(/:id)":"search","profiles/":"profiles","proxies/":"proxies","tpls(/:id)":"tpls","trash(/:id)":"trash"},add:function(e){v.editNew(e),S(v)},add_template:function(e){w.create(e),S(w)},add_using_tpl_for_url:function(e,t,i){g.add(e,t,i),S(g)},duplicate:function(e){v.duplicate(e),S(v)},edit:function(e){v.edit(e),S(v)},edit_tpl:function(e){},export_csv:function(){r.asCSV(p),S(r)},export_json:function(){r.asJSON(p),S(r)},filter_error:function(e){p.showErred(e),S(p),f.select("filter","error")},filter_unread:function(e){p.showUnread(e),S(p),f.select("filter","unread")},import_csv:function(){d.reset(),S(d)},import_json:function(){u.fromJSON(),S(u)},index:function(){App.nav("/inbox")},inbox:function(e){p.showInbox(e),S(p),f.select("inbox")},label:function(e,t){const n=i.where({name:e});n.length>0?(p.showLabel(n[0],t),S(p),f.select("label",e)):h.a.error("e_label_na")},search:function(e,t){null!=e&&0!=e.length?(p.showSearch(e,t),S(p),f.select("search")):App.nav("/inbox")},profiles:function(){location.href=URL_ROOT+"/watchlist#profiles/"},proxies:function(){location.href=URL_ROOT+"/watchlist#proxies/"},tpls:function(e){y.showList(),S(y),f.select("tpls")},trash:function(e){p.showTrash(e),S(p),f.select("trash")}});this.clients=t,this.labels=i,this.sieves=l,this.store=c,this.user=e,this.router=new s,this.edit=function(e,t){this.nav("edit/"+e,t)},this.nav=function(e,t){if(!0!==t){const e=location.hash.slice(1),t=e.split("/"),i=(m||"/").split("/");t[0]==i[0]&&t[1]==i[1]||(m=e)}mt.history.navigate(e,{trigger:!0})},this.navBack=function(){this.nav(m,!0)},this.toggleSlidebar=function(){const e=ft("#summaries"),t=e.hasClass("xslidebar-open");e.toggleClass("xslidebar-open"),t||b.load((function(e){e&&console.error("Failed to load summaries:",e)}))},ft(".btn").button();const a=this.root=new _({el:ft("#content")[0],router:this.router}).render();var r=new B({el:ft("#exporter")[0]}).render();new _e.a.FeedbackAnchor({el:ft("#feedback")[0],parent:a}).render();var d=new ve({},{el:ft("#importer-csv")[0]}),u=new we({el:ft("#importer-json")[0],parent:a}).render();new ye.a({el:ft("#langs")[0]}).render(),new Ee({el:document.getElementById("form-search"),labels:i});var p=this.sieveList=new H.a.Sieves({clients:t,collection:l,labels:i,el:ft("#list")[0],parent:a,routePrefix:"inbox"}).render(),f=this.labelNavList=new Re.LabelNavList({collection:i,el:ft(".xsidebar > ul")[0],parent:a}).render(),g=new lt({el:ft("#sieve-from-tpl")[0],parent:a,onSave:function(e){e.save(null,{error:function(e,t){console.error("Failed to save monitor. Error: ",t),h.a.error("Failed to save monitor, check console for more info.")},success:function(){App.edit(e.id,!0)}})}}).render(),v=new H.a.SieveOptions({clients:t,collection:l,el:ft("#sieve-editor")[0],parent:a}).render(),b=new Ye({el:ft("#summaries > .xcontent")[0],parent:a}).render(),w=new nt.Editor({el:ft("#tpl-editor")[0],parent:a}).render(),y=new nt.TplList({el:ft("#tpls")[0],parent:a}).render();ft("#summaries > .xhandle").click(this.toggleSlidebar);let x=null;function S(e){e!=x&&(h.a.reset(),x==p&&(p.currentScrollTop=ft("#content").scrollTop()),ft("#"+e.name).show(),x&&(x.setActive(!1),x.el.classList.add("hide")),e.setActive(!0),e.el.classList.remove("hide"),x=e,o.a.Acts.setActions(a.getActions()),e==p?ft("#content").scrollTop(p.currentScrollTop||0):ft("#content").scrollTop(0))}},Je.a.init(),ft((function(){Object(ut.a)({app:service.CFG.CLIENT.NAME,url:service.CFG.URL.ER,version:service.CFG.VERSION,id:USER.id}),r.a.service.ready&&r.a.auth.isReady()?w():r.a.service.once("init",(function(){try{w()}catch(e){console.error("Error rendering app after init",e)}}))}))}},51:function(e,t,i){"use strict";var n=i(0);const s=window.jQuery;if(!s)throw new Error("ADD jQuery");t.a=function(){s("[data-placeholder]").each((function(){this.placeholder=Object(n.a)(this.getAttribute("data-placeholder"))})),s("[data-text]").each((function(){this.textContent=Object(n.a)(this.getAttribute("data-text"))})),s("[data-title]").each((function(){this.title=Object(n.a)(this.getAttribute("data-title"))}))}},52:function(e,t,i){"use strict";let n;function s({url:e,...t}){n=e,window.addEventListener("unhandledrejection",(function(e){const i=e.reason;let n;o(n="object"==typeof i?{...i,...t}:{file_url:"",message:JSON.stringify(i),...t})})),window.onerror=function(e,i,n,s,a){if(e.toLowerCase().indexOf("script error")>-1);else{o({message:e,file_url:i,app_url:document.URL,line:n,column:s,stack:a.stack,...t})}return!1}}i.d(t,"a",(function(){return s}));const a=()=>{const e=new WeakSet;return(t,i)=>{if("object"==typeof i&&null!==i){if(e.has(i))return;e.add(i)}return i}};function o(e){fetch(n,{method:"POST",mode:"cors",body:JSON.stringify(e,a())}).then((function(e){})).catch((function(e){console.error("Request failure: ",e)}))}},53:function(e,t,i){"use strict";const n=i(3).a.CFG.URL.ROOT;t.a={api:`${n}/api/v1`,static:"/ui",error_reporter:"https://reporter.distillweb.net",error_reporter_local:"error-reporter-local",website:"https://distill.io",watchlist:"/ui/inbox.html#inbox",template:"/ui/inbox.html#tpls",availability:`${n}/analytics/availability`,settings:"/ui/settings.html#general",billing:`${n}/settings/billing`,login:`${n}/service-login?redirect=app://ui/inbox.html#inbox`,logout:`${n}/logout`}},54:function(e,t,i){"use strict";var n=i(0),s=i(4),a=i(5);const o=window._;if(!o)throw new Error("ADD _");const r=window.Backbone;if(!r)throw new Error("ADD Backbone");const l=window.jQuery;if(!l)throw new Error("ADD jQuery");if(!window.domo)throw new Error("ADD domo");const c=s.a.Base.extend({name:"FeedbackForm",events:{"click button":"send_feedback","change input":"event_change","keypress textarea":"event_change"},event_change:function(e){o.defer(()=>{let{name:t,value:i}=e.target;i=i.trim(),this.model.set(t,i)})},send_feedback:function(e){e.preventDefault();const t=this.model.get("message"),i=this.model.get("emotion"),n=document.URL;t&&(a.a.api("/feedbacks","POST",{message:t,emotion:i,context:n},(function(e){})),l(this.form).addClass("hide").removeClass("form"),l(this.success).removeClass("hide"),window.setTimeout(()=>{this.hide()},2e3),this.model.set({message:"",emotion:"😀"}))},hide:function(){l(window).off("mousedown",this.onAClick).off("keypress",this.onKeyup),this.remove()},removeChildren:function(){o.each(this.children.slice(0),(function(e){e.remove(),this.trigger("child:remove")}),this)},onAClick:function(e){const t=e.target;!l.contains(document.documentElement,t)&&document.documentElement!=t||l.contains(this.form,t)||this.hide()},onKeyup:function(e){console.log(e.keyCode),27==e.keyCode&&this.hide()},postInit:function(){o.defer((function(e){l(window).mousedown(e.onAClick).keyup(e.onKeyup)}),this)},render:function(){return this.$el.append(DIV({class:"popover",style:"display: flex;\n        flex-wrap:wrap;\n        text-align:center;\n        top: auto;\n        left: 60px;\n        bottom: 50px;\n        width: 300px"},this.form=FORM({class:"form",role:"form"},TEXTAREA({type:"text",name:"message",placeholder:Object(n.a)("m_send_feedback"),style:"width: 100%; height: 120px; padding: 5px 10px 10px"},this.model.get("message")||""),DIV({style:"margin:0px 0px 2px 0px; width:auto;",class:"btn-group btn-group-toggle","data-toggle":"buttons"},o.map([{emo:"😀",title:Object(n.a)("l_happy")},{emo:"🤔",title:Object(n.a)("l_suggestion")},{emo:"☹",title:Object(n.a)("l_sad")},{emo:"🙄",title:Object(n.a)("l_confused")},{emo:"😡",title:Object(n.a)("l_dissatisfied")}],e=>LABEL({class:"btn btn-secondary "+(e.emo==this.model.get("emotion")?"active":""),title:e.title},INPUT({type:"radio",value:e.emo,name:"emotion"}),e.emo))),BUTTON({type:"submit",class:"btn btn-primary pull-right ",style:"min-width:0"},Object(n.a)("a_send"))),this.success=DIV({class:"hide",style:"width:100%; ma-width: 30%; margin:20% 30%; "},Object(n.a)("m_thank_you"),"       😀"))),this.focus(),this}}),d=s.a.Base.extend({name:"FeedbackAnchor",events:{"click a":"event_click"},postInit:function(){this.model=new r.Model({emotion:"😀"})},event_click:function(){const e=new c({model:this.model,parent:this}).render();l(this.popoverCt).append(e.el)},render:function(){return this.$el.append(A({class:"ripple",id:"feedAnchor",href:"#","data-toggle":"tooltip","data-html":"true",title:"<b>Feedback</b>"},I({class:"fa fa-comment","aria-hidden":"true"})),this.popoverCt=DIV({id:"feedPop"})),this}});t.a={FeedbackAnchor:d}},55:function(e,t,i){"use strict";var n=i(3),s=(i(0),i(6)),a=i(4),o=[{locale:"en-US",label:"English (US)"},{locale:"de",label:"Deutsch"},{locale:"fr",label:"Français"},{locale:"ru",label:"Русский"},{locale:"ja",label:"日本語"},{locale:"zh",label:"简体中文"},{locale:"es",label:"Español"},{locale:"it",label:"Italiano"},{locale:"pl",label:"Polskie"},{locale:"pt",label:"Português do Brasil"},{locale:"sr",label:"Српски"}],r=i(5);const l=window._;if(!l)throw new Error("ADD _");if(!window.jQuery)throw new Error("ADD jQuery");const c=window.location,d=a.a.Dropdown.extend({getLocale:function(){return USER&&USER.locale||LOCALE},getLabel:function(e){return l.findWhere(o,{locale:e}).label},postInit:function(e){this.menu=new a.a.Menu({items:l.map(o,(function(e){return{label:e.label,data:{locale:e.locale}}}))}),this.menu.on("click",this.onClick),this.setLabel(""),this.$el.attr({"data-toggle":"tooltip","data-html":"true",title:"<b>Language</b>"})},onClick:function(e){const t=e.locale;if(s.a.agents.local){const e=n.a.auth.getId();n.a.store.Prefs.set("locale",t),e?r.a.api("/users","PUT",{id:e,locale:t},(function(){n.a.service.SyncMan._syncStore(n.a.store.UserStore,(function(){c.reload()}))})):c.reload()}else USER&&r.a.api("/users","PUT",{locale:t},(function(){c.reload()}));return!0},renderAction:function(){return A({class:"ripple vbar-tooltip",href:"#","data-toggle":"dropdown","data-html":"true"},I({class:"fa fa-language","aria-hidden":"true"}))}});t.a=d},56:function(e,t,i){"use strict";i.d(t,"a",(function(){return _}));var n=i(3),s=i(6),a=i(7),o=i(54),r=i(55),l=i(0),c=i(53);let d,h,u,p,f,m,g=e=>e;window._;if(!window.jQuery)throw new Error("ADD jQuery");const v=(new r.a).render(),b=(new o.a.FeedbackAnchor).render();function w(e){s.a.agents.local&&(e.preventDefault(),n.a.auth.logout(),location.href=c.a.logout)}function _(){return Object(a.b)(d||(d=g`
    <div class='vbar'>
        <a class='xripple xside-logo' target="_blank" rel="noopener" href='${0}' data-toggle="tooltip" data-html="true" title="<b>Distill.io</b>"><img height=38 alt='distill-logo' src='${0}/img/distill_logo_inverted.svg'/></a>
        <a class='xripple' href='${0}' data-toggle="tooltip" data-html="true" title="<b>Watchlist</b>"><i class="fa fa-list" aria-hidden="true"></i></a>
        <a class='xripple' href='${0}' data-toggle="tooltip" data-html="true" title="<b>Analytics</b>"><i class="fa fa-bar-chart-o" aria-hidden="true"></i></a>
        <a class='xripple' href='${0}' data-toggle="tooltip" data-html="true" title="<b>Templates</b>"><i class="fa fa-file-text" aria-hidden="true"></i></a>
        ${0}
        <i style='flex: 1'></i>
        ${0}
        ${0}
        <div class='dropdown' data-toggle="tooltip" data-html="true" title="<b>Settings</b>">
            <a class='xripple vbar-tooltip dropdown-toggle' data-toggle="dropdown" href='#'>
              <i class="fa fa-cog" aria-hidden="true"></i>
            </a>
            <ul class='dropdown-menu' role='menu'>
              ${0}
              <li class='divider'></li>
              <li><a target="_blank" rel="noopener" href="https://distill.io/kb/">${0}</a></li>
              <li role='presentation'><a href="${0}" role='menuitem'>${0}</a></li>
              ${0}
              ${0}
            </ul>
        </div>
    </div>
  `),c.a.website,c.a.static,c.a.watchlist,c.a.availability,c.a.template,USER.account_id?Object(a.b)(h||(h=g`
            <a class='xripple' href='/groups/' data-toggle="tooltip" data-html="true" title="<b>Manage Teams</b>">
              <i class="fa fa-users" aria-hidden="true"></i>
            </a>`)):"",b.el,v.el,USER.name?Object(a.b)(u||(u=g`
                  <li class='logout' role='presentation'><a href=${0} @click=${0} role='menuitem'>${0} (<em>${0}</em>)</a></li>
                `),c.a.logout,w,Object(l.a)("a_sign_out"),USER.name):Object(a.b)(p||(p=g`
                  <li class='login' role='presentation'><a href=${0} role='menuitem'>${0}</a></li>
                `),c.a.login,Object(l.a)("a_signin")),Object(l.a)("l_support"),c.a.settings,Object(l.a)("l_settings"),USER.account_id?"":Object(a.b)(f||(f=g`<li role='presentation'><a href="${0}" target="_blank" role='menuitem'>${0}</a></li>`),c.a.billing,Object(l.a)("l_billing")),"admin"==USER.role?Object(a.b)(m||(m=g`<li role='presentation'><a href="/admin/users" role='menuitem'>${0}</a></li>`),Object(l.a)("l_admin")):"")}}}]);
//# sourceMappingURL=10.js.map